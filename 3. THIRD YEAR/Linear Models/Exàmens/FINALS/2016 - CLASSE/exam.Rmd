---
title: "2n PARCIAL 2016"
author: "Marta Pi?ol Palau"
date: "December 18, 2017"
output: html_document
---

#Problema 1

```{r}
dades <- read.table("bloodpress_A.txt", header=T)
dades <- dades[,-1]
```


```{r}
g <- lm(BP ~ Age+Weight+BSA+Dur+Pulse+Stress, dades)
```

**(a) Feu un estudi de la possible multicolinealitat d'aquest model.**

1. cal excloure la columna 1 (pt) i la columna 2 (bp) per calcular les correlacions
la variable bsa amb weight tenen una correlaci? elevada

2. Calcular els VIP's

```{r}
library(faraway)
#funcio per calcular els vips en faraway
#hi ha tres valors superiors a 4, per tant, podem afirmar que hi ha multicolinealitat
```

**(b) Trobeu el "millor" model per dos metodes diferents de seleccio de variables com, per exemple, AIC i Cp de Mallows.**
  **(b.1) Quines son les variables seleccionades?**
  **(b.2) Quins son els coecients de determinacio ajustats d'aquests models? Compareu-los amb el del model complet.                 Llavors, que hem guanyat?**
  
```{r}
#funci? step i decidir si fem forward backward..
#el millor ?s model complet (backward)

#Si fem Cp Malow utilitzem la funci? regsubsets packet Leaps
#s'ha de fer un grafic on hi ha els resultats del cp per dos parametres, 3 parametres, 4 parametres... i dibuixar la bisectriu del primer cuadrant
#Objectiu: buscar una solucioo que s'aproximi a la bisectriu lo mes possible per abaix
#nomes es troben solucion per sobre. Per tant, una altre vegada la millor solucio es el model complet

#Cap dels dos metodes reduiexen variables

#Tamb? es podria calcular el grafic dels R cuadrats ajustats. El m?s gran es el de que conte totes les variables.


```

**(c) Un altre possibilitat es fer servir la Ridge Regression. Quins son els coeficients obtinguts? Expliqueu breument les avantatges i inconvenients d'aquest m?tode front a la selecci? de variables.**

```{r}
library(MASS)
gridge <- lm.ridge(BP ~ Age+Weight+BSA+Dur+Pulse+Stress, dades, lambda = seq(0,3,0.01))
matplot(gridge$lambda, coef(gridge), type="l", lty=1, xlab=expression(lambda), ylab=expression(hat(beta)))
abline(v=0.03)
select(gridge)

#l'objectiu ?s troba el gcv
#secuencia que va de 0 a 3 de 0.1. El minim que em surt de gcv es 0.03
# fixem lamda en 0.03 i obtenim els coeficients, pero pot ser que doni algo diferent

gridge <- lm.ridge(BP ~ Age+Weight+BSA+Dur+Pulse+Stress, dades, lambda =0.03)
coef(gridge)
# d'aquest model podem demanar els coeficients
#diferencia: no seleccionem variables, les fem servir totes. PEro sabem, que a canvi d'un petit biaix estem guanyant en eficiencia
```

**(d) Ajusteu un model per a cadascu dels seguents metods:**
faraway apartat 8.4 pg 123
  **(i) Metode robust de Huber.**

```{r}
library(MASS)
lmod<-rlm(BP ~ Age+Weight+BSA+Dur+Pulse+Stress, dades)
```

  **(ii) Metode robust Bisquare**
```{r}
library(MASS)
lmod<-rlm(BP ~ Age+Weight+BSA+Dur+Pulse+Stress, dades, psi = psi.bisquare)
```

  **iii) Least absolute deviations.**
```{r}
library(quantreg)
lmod<-rq(BP ~ Age+Weight+BSA+Dur+Pulse+Stress, dades, psi = psi.bisquare)
```

**(iv) Least trimmed squares.**
```{r}
ltsreg(BP ~ Age+Weight+BSA+Dur+Pulse+Stress, dades, psi = psi.bisquare)
```

objtectiu: obtenir els coeficients de la regressio, per que aixi podem calcular les prediccions si ens ho demanen


#Problema 3

**En un Analisi de la Variancia un dels pitjors problemes que ens podem trobar es la manca d'igualtat de les variancies entre situacions experimentals, es a dir, la heterocedasticitat. En el cas concret d'un ANOVA d'un factor (one-way ANOVA) hi ha diverses solucions possibles com: (i) fer transformacions de la variable resposta, (ii) utilitzar la correccio de Welch, (iii) solucio boostrap, etc. Considerem les seguents dades amb tres situacions experimentals (grup):**

```{r}
yA <- c(0.178, 0.195, 0.225, 0.294, 0.315, 0.341, 0.36, 0.363, 0.371, 0.398, 0.407,
0.409, 0.432, 0.494, 0.719)
yB <- c(0.11 , 0.111, 0.204, 0.416, 0.417, 0.441, 0.492, 0.965, 1.113, 1.19 , 1.233,
1.505, 1.897)
yC <- c(0.106, 0.114, 0.143, 0.435, 0.448, 0.51 , 0.576, 0.588, 0.608, 0.64 , 0.658,
0.788, 0.958)
```

**L'objectiu es comparar els tres grups (amb presencia d'heterocedasticitat).**

**(a) Dibuixeu un grac que mostri les diferencies en la dispersio de les dades. Calculeu les variancies per a cada grup i comproveu1 que la rao entre la variancia mes gran i la mes petita es superior a 4. Donat que la variancia es sensible a outliers, potser es millor calcular el rang interquartilic IQR per a cada grup.**

```{r}
#boxplot multipe: s'observa clarament que hi ha un grup mes dipers que els altres
#calcular variancies per cada grup
#si la rao entre la var mes gran i mes petita es superior a 4 tindrem un problema: S? que passa, per tant, tenim un problema d'heterocedasticitat
#LA var es sensible a outliers, per tant, pot ser millor treballar amb el rang interquartilic (funcio iqr)
```



**(b) Construu el vector y de respostes i el factor grup i apliqueu un test de Levene per contrastar la
homocedasticitat de les dades. Quina es la conclusio?**

```{r}
y <- c(yA, yB, yC)
#ajutant a b i c en un unic vector
grup <- as.factor(c(rep(a,15),rep(a,13),rep(a,13)))

#el test de levenne es pot fer a mano amb una funcio que esta al packet car
library(car)
LeveneTest(y ~ grup)

#ens surt significatiu-> rebutgem la homocedasticitat
#el model lineal no funciona perque no compleix les condicions de gauss markov
#solucio: fer servir minims cuadrats ponderats
```



(c) Ara aplicarem la solucio de mnims quadrats ponderats (weighted least squares):

```{r}
#w1 invers de la variancia de cada grup repetida 15 vegades, 13 vegades, 13vegades (vector de pesos)
#aplicar el model lm pero amb el parametre weist
#fer el mateix amb l'invers del rang intercuartilic
```



(i) Construu un vector de pesos w1 amb l'invers de la variancia del grup per a cada observacio.
Calculeu el model lineal amb el parametre weights=w1 i doneu la taula ANOVA. Quina es la
conclusio?
Compareu el tercer grac de l'analisi dels residus del model sense pesos i amb pesos.


(ii) Construu un vector de pesos w2 amb l'invers del rang interquartilic IQR del grup per a cada
observacio.
Calculeu el model lineal amb el parametre weights=w2 i doneu la taula ANOVA. Quina es la
conclusio?


(d) Calculeu un model robust amb la funcio rlm del paquet MASS i el parametre weights=w2.
Calculeu la taula ANOVA amb la funcio Anova del paquet car. Quina es la conclusio?
```{r}
#model robust
#funcio ANOVA del paquet car -> no e sla funcio anova habitual. Ens diu si hi ha diferencies entre el tres grups
```


(e) Calculeu un model robust rlm1 amb la funcio lmrob del paquet robustbase i xeu el parametre
weights=w2.
Considereu el model rlm0 <- lmrob(y ~ 1, weights=w2) i compareu-lo amb l'anterior amb
anova(rlm1, rlm0)
Quina es la conclusio del test de Wald?
```{r}
#alternativa que calcula un model robust diferent. Es vol veure quin es el resultat en aquest altre sistema
#s'ha de comparar el model complet amb el model que nomes t? la constant
#el model 0 es el model que nomes te la constant com a regressora
#es per veure si hi ha diferencies entre els 3 grups
#test de wald
```
aquest ultim exercici ?s molt guiat. a l'examen sortira un exercici d'aquest estil. sovint els procediments son iteratius s'ha de fer mes d'una volta

## PROBLEMA 2

Atacs de cor en conills. Quan el muscle del cor es privat d’oxigen, el teixit mor i produeix un atac de cor (infart de miocardi). Aparentment, refredar el cor redueix la mida de l’atac de cor. Malgrat aixo, no se sap si el refredament  ́es efectiu nom ́es si es fa abans que la sang que flueix al cor quedi restringida. Alguns investigadors (Hale et al. 1997) van fer la hipotesi que el refredament del cor seria efectiu per reduir la mida de l’atac de cor fins i tot si es feia despr`es que el flux de sang quedi restringit.

Per investigar aquesta hipotesi, els investigadors van realitzar un experiment amb 32 conills anestesiats als que van induir un atac de cor. Els investigadors van establir tres grups experimentals:

• Conills amb cors refredats a 6oC als 5 minuts del bloqueig de l’arteria (early cooling) 

• Conills amb cors refredats a 6oC als 25 minuts del bloqueig de l’arteria (late cooling) 

• Conills amb els cors no refredats de cap manera (no cooling)

Al final de l’experiment, els investigadors van mesurar la mida de l’area infartada (en grams) en cadascú dels 32 conills. Pero, com podeu imaginar, hi ha una gran variabilitat en la mida dels cors. La mida de l’area infartada d’un conill pot ser gran simplement perque tingui un cor gran. Aixi doncs, per poder ajustar les difer`encies en les mides dels cors, els investigadors tamb ́e van mesurar la mida de la regío de risc (en grams) en cadasc  ́ dels 32 conills.

Amb les seves mesures a les mans (coolhearts_A.txt), els investigadors es van fer la principal pregunta: Les mitjanes de les `arees infartades s ́on diferents en els tres grups (control, early cooling, late cooling) si
tenim en compte la mida de la regi ́o de risc a l’infart?


El model de regressi ́o que els investigadors haurien d’utilitzar per contestar la seva pregunta  ́es
                             
                                Inf.area ~ Area + Group
                                
(a) Considereu el model amb interacci ́o i contrasteu si aquesta interacci ́o  ́es significativa.

```{r}

```

(b) Comproveu que el model proposat  ́es equivalent al model de regressi ́o Inf.area ~ Area + X2 + X3. Com anomenem aquest tipus de models?
Si anomenem β0, β1, β2, β3 als coeficients en l’ordre donat, com s’interpreten β2 i β3.
```{r}

```


(c) Calculeu els coeficients del model i valoreu l’ajust del model a les dades.
```{r}

```



(d) Investigueu la validesa del model lineal (sense la interacci ́o). Feu un test de normalitat per als residus.
Hi ha algun residu que podr ́ıem qualificar de at ́ıpic (outlier)? Calculeu les dist`ancies de Cook i el leverage.
Decidiu si hi ha algun conill problem`atic pel que fa a l’ajust del model.
```{r}

```



(e) Proposeu un contrast d’hip`otesi amb els par`ametres βi, i = 0, 1, 2, 3 que contesti una pregunta dels investigadors: E ́s u ́til el model lineal per predir la mida de l’infart?
```{r}

```


(f) Contrasteu la hip`otesi H0 : β1 = 0 amb dos tests diferents. Utilitzeu un nivell de significaci ́o α = 0.05.
```{r}

```



(g) Contrasteu la hip`otesi principal dels investigadors: Afecta el tipus de tractament a la mida de l’`area infartada?
Dibuixeu un gr`afic de dispersi ́o de les variables x = Area i y = Inf.area. Afegiu les rectes de regressi ́o simple dels tres grups, una per a cada grup i expliqueu el resultat.
```{r}

```

