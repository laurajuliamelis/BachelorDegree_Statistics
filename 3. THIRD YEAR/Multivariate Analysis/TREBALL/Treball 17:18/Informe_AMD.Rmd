---
title: Exemple d'aplicaci√f¬≥ de t√f¬®cniques de mineria de dades a la ind√f¬∫stria
  hotelera
author:
- affiliation: Universitat de Barcelona
  name: Hugo All√f¬®s Pons
- affiliation: Universitat de Barcelona
  name: Carles Blanco Conde
- affiliation: Universitat de Barcelona
  name: Aleix Fibla Salgado
- affiliation: Universitat de Barcelona
  name: Victor Miranda Hern√f¬°ndez
- affiliation: Universitat de Barcelona
  name: Pablo Morante L√f¬≥pez
- affiliation: Universitat de Barcelona
  name: Antoni Ramoneda Montoya
- affiliation: Universitat de Barcelona
  name: Oriol Rovira Tauler
- affiliation: Universitat de Barcelona
  name: Aleix Salvador Barrera
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
    toc: yes
  pdf_document:
    citation_package: natbib
    fig_caption: yes
    highlight: tango
    keep_tex: yes
    latex_engine: pdflatex
    number_sections: yes
    template: Plantillas/Plantilla_informe.tex
    toc: yes
biblio-style: apsr
fontfamily: mathpazo
fontsize: 11pt
geometry: margin=1in
header-includes: \usepackage{float}
keywords: cl√f¬∫ster, preprocessament, profiling, ACP, ACM
bibliography: Plantillas/master.bib
thanks: Tots els arxius per a replicar l'an√f¬†lisi es troben al compte de Github
  https://github.com/aleixfiblasalgado
abstract: Aquest document mostra un exemple d'aplicaci√f¬≥ de t√f¬®cniques de mineria
  de dades i an√f¬†lisi multivariant dins del marc de la ind√f¬∫stria hotelera, amb
  l'objectiu de millorar les experi√f¬®ncies dels viatgers i optimitzar el targeting
  dels hotels
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list =ls())
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(ggthemes)
library(corrplot)
library(xtable)
library(gridExtra)
library(Epi)
library(descr)
library(catspec)
library(xtable)
library(Hmisc)
library(kableExtra)
library(agricolae)
options(xtable.floating = FALSE)
options(xtable.timestamp = "")
options(xtable.comment = FALSE)
setwd("~/ESTADISTICA/3er/2n semestre/An√†lisi Multivariant/Course project/Report")
```

\newpage

\section{Introducci√≥}

Aquest treball s'ha desenvolupat amb l'objectiu de millorar les experi√®ncies de viatges en l'√†mbit de la industria hotelera. Per a assolir aquest objectiu, s'empren una s√®rie de t√®cniques de mineria de dades dins el marc de l'an√†lisi multivariant.      
Com a materia prima per a l'an√†lisi, s'han utilitzat dades importades a trav√©s d'una API des de  \href{https://www.booking.com}{'Booking'}. Aquestes dades s√≥n propietat de *Booking* per√≤ un usuari de \href{https://www.kaggle.com}{kaggle} les ha fet p√∫bliques i en permet l'√∫s amb finalitats acad√®miques. A la web trobem dues versions de les dades: un primer *'dataset'* amb la informaci√≥ obtinguda de *Booking* (\url{https://www.kaggle.com/jiashenliu/ 515k-hotel-reviews-data-in-europe}), i un de segon, en el qual la informaci√≥ del primer ha estat enriquida amb noves variables. Aquest √∫ltim √©s el que s'utilitza en aquest treball \url{https://www.kaggle.com/ycalisar/hotel-reviews-dataset-enriched}.      
      
La base de dades cont√©, aproximadament, $515.000$ opinions de clients, i les puntuacions otorgades pels mateixos, que han contractat estades a un total de $1.493$ hotels d'Europa. *Booking* tamb√© proporciona les coordenades de cada hotel per a realitzar geolocalitzacions. 

A grans trets, la matriu de dades resultant cont√© 41 variables, 21 de les quals s√≥n num√®riques i 20 categ√≤riques, i $515.738$ observacions. Tanmateix, per a ajustar-nos a la dimensionalitat de les dades proposada a les bases del treball, s'ha seleccionat aleat√≤riament un subconjunt de $5.000$ observacions i s'han eliminat de la base de dades les variables **[Hotel_Address, Hotel_State, Room_Type, Tags, Day_of_Week, Day_of_Year, Bed_Type, Week_of_Month, Week_of_Year, Quarter_of_Year,Reviewer_Country]**, que es consideren poc rellevants en relaci√≥ als objectius del treball. D'aquesta manera, assegurem que tots els procediments requerits podran ser implementats de manera eficient i satisfact√≤ria amb les nostres dades. 

```{r, results='hide', warning=F, comment = "", message=FALSE}
datapath <- "~/ESTADISTICA/3er/2n semestre/An√†lisi Multivariant/Course project/Dades"
file <- "Booking_data.csv"
dd <- read.csv(file = paste(datapath, file, sep = "/"))
dd <- dd[, -1]
na_count <-sapply(dd, function(y) sum(length(which(is.na(y)))))
na_count <- data.frame(na_count)
```

Respecte als valors **missing**, la base de dades revela un total de $3.350$, que representen un $2,23\%$ de la matriu de dades completa $(m \cdot n)$. En aquest sentit, presentem la Taula 1 que mostra com es distribuieixen els valors missing entre les diferents variables, aix√≠ com la Figura 1.1 on es representa un histograma que resumeix la taula anterior.

```{r, warning=F, comment = "", message=FALSE}
require(knitr)
require(rmarkdown)
na <- c(23, 23, 23, 23, 23, 3209, 14, 10, 2)
df <- data.frame(
        variable = c("Hotel_lat", "Hotel_lng", "Businesses_100m", "Businesses_1km", "Businesses_5km",
                     "Room_Type_Level", "Trip_Type","Reviewer_Nationality", "Negative_Review"),
        nre.Missings = na,
        freq.Missings = paste(round((na/150000)*100, 4), "%", sep = " ")
)
kable(df, caption = "Taula de valors missing")
```

```{r, fig.cap="Histograma dels valors missing", warning=F, comment = "", message=FALSE, fig.height=5, fig.width=6, fig.align="center"}
require(ggplot2)
df <- data.frame(variable = names(dd),
                 missings = c(0, 0, 0, 0, 23, 23, 23, 23, 23, 3209, 0, 14, 0, 0, 
        0, 0, 0, 0, 0, 0, 10, 2, 0, 0, 0, 0, 0, 0, 0, 0))
labels <- "missings"
ggplot(data=df, aes(x=variable, y= missings)) + theme(axis.title = element_text(size=10)) + geom_bar(stat="identity") + labs(x = "missings", y = "variable", size = 0.6)  + coord_flip() 
```

\newpage


\section{Pla de treball}

En aquest cap√≠tol es resumeix la organitzaci√≥ del treball i les tasques que es persegueix implementar, a priori. Un cop finalitzat el treball es presentar√† un appendix on cada component del grup valorar√† si el treball s'ha dut a terme d'acord amb el pla de treball establert en aquesta secci√≥. 

\subsection{Diagrama de Gantt}
El Diagrama de Gant √©s una eina que es fa servir per a descompondre el projecte en tasques *"indivisibles"* i sequenciar-les temporalment. La *Figura 2* mostra el Diagrama de Gantt per a aquest projecte.

\begin{figure} 
\includegraphics[width=6in]{Grafic_aux/Gantt.pdf} 
\caption{Diagrama de Gantt}
\end{figure}

\subsection{Distribuci√≥ de tasques}
A la *Figura 3* es resumeix la distribuci√≥ de les diferents tasques presentades anteriorment al Diagrama de Gantt. 
						
\begin{figure} 
\includegraphics[width=5.8in]{Grafic_aux/Plantilla_dist_tasques.pdf} 
\caption{Plantilla de Tasques}
\end{figure}

\subsection{Pla de riscos}
Finalment, cal elaborar un pla on es consideren riscos potencials que puguin presentar-se al llarg del projecte, aix√≠ com un llistat de possibles solucions per als mateixos *(Figura 4)*.

\begin{figure} 
\includegraphics[width=5.8in]{Grafic_aux/Riscos.pdf} 
\caption{Pla de riscos}
\end{figure}

\newpage

\section{Estructura de les dades i an√†lisi descriptiva}

Aquest cap√≠tol recull tota la informaci√≥ necess√†ria per a que el lector es familiaritzi amb les dades. En primer lloc, es planteja la motivaci√≥ del treball, seguida de les metadades que acompanyen a la base de dades. Finalment, es plantegen tots els procediments que s'han dut a terme en la fase de preprocessament de les dades, aix√≠ com un an√†lisi explorat√≤ri inicial de cadascuna de les variables.

\subsection{Motivaci√≥ del treball}

El debat per escollir el tema del treball no ha estat una discussi√≥ dif√≠cil, ja que a tots els integrants del grup ens agrada viatjar, observar noves cultures i estils de vida; alhora que, estar en bona companyia i viure experi√®ncies enriquidores. Aix√≠ doncs, vam decidir, aplicar les t√®cniques d‚Äôan√†lisi de dades que estem aprenent en el present curs per tal de fer un estudi sobre una ind√∫stria amb molt de pes en el nostre territori, com √©s la ind√∫stria hotelera, tot i que no nom√©s ens hem centrat en un √†mbit local.
L‚Äôobjectiu principal que perseguim amb la realitzaci√≥ del present projecte, √©s tractar d‚Äôestablir un model, basat en les valoracions i puntuacions que han realitzat els hostes, per tal detectar caracter√≠stiques (tant del client com de l'hotel) que estiguin associades a una puntuaci√≥ elevada, o per contra, molt baixa.
Per√≤, no nom√©s volem quedar-nos aqu√≠, sin√≥ que la nostra intenci√≥ √©s la de millorar l‚Äôexperi√®ncia dels clients que utilitzen els portals web especialitzats, a trav√©s de la conglomeraci√≥ d‚Äôhotels a partir de les ressenyes, i les prefer√®ncies dels hostes, per tal d‚Äôoferir un millor servei.

\subsection{Descripci√≥ formal de l'estructura de les dades}

Tal i com s'ha mencionat anteriorment, tot l'an√†lisi es duu a terme amb una mostra aleat√≤ria de 5.000 observacions *{seed(20359724)}* i una selecci√≥ de 30 variables que es consideren rellevants per als objectius perseguits (*Base de dades original 515.738 files per 41 columnes*). En aquest sentit, cada observaci√≥ de la matriu de dades representa una ressenya escrita a Booking per un client que ha visitat cert hotel registrat al portal. Tot seguit, es presenta el llistat de les variables seleccionades, aix√≠ com les metadades requerides en cada cas. Cal destacar que tota la informaci√≥ que apareix al diccionari de dades es basa en la base de dades un cop fet la selecci√≥ dels registres, i no sempre ser√† aplicable a les dades originals. Adicionalment, de cara a mencions posteriors, hem considerat oport√∫ indexar les variables, de manera que, en endavant, podem referenciar una variable pel seu √≠ndex.

---------------------------

**Diccionari de metadades**

$\vspace{2mm}$

El valor NULL a les variables *Businesses_100m, Businesses_1km, Businesses_5km, Room_Type_Level, Trip_Type* indica dada faltant, mentre que a les variables *Hotel_lat, Hotel_lng* i *Negative_Review* tenim NA. Per √∫ltim la variable *Reviewer_Nationality* codifica les dades faltants mitjan√ßant espais buits.

$\vspace{1mm}$

*(Els nivells de les variables categ√≤riques apareixen ordenats)*

1. *id* (integer): Identifica cada ressenya.       
        a. **rang** : {170 , 515.740}       
        b. **rol**: variable √≠ndex       

2. *Hotel_Name* (qualitative): Nom de l'hotel.       
        a. **modalitats**: {11 Cadogan Gardens , 1K Hotel , 25hours Hotel beim MuseumsQuartier , 88 Studios , 9Hotel             Republique , Abba Sants , AC Hotel Barcelona Forum a Marriott Lifestyle Hotel , AC Hotel Diagonal L Illa a               Marriott Lifestyle Hotel , AC Hotel Milano a Marriott Lifestyle Hotel , AC Hotel Sants a Marriott Lifestyle              Hotel, ...} *(1135 modalitats)*       
        b. **rol**: variable explicativa       
        
3. *Hotel_Country* (qualitative): Pa√≠s de l'hotel.       
        a. **modalitats**: {AT, ES , FR , GB , IT , NL}       
        b. **rol**: variable explicativa            

4. *Hotel_City* (qualitative): Ciutat de l'hotel.       
        a. **modalitats**: {Amsterdam , Amsterdam Zuidoost , Barcelona , Boulogne Billancourt , Donauinsel , El Prat de          Llobregat , Fitzrovia , London , Milan , Paddington , Paris , Paris 06 , Paris 12 , Vienna , Vincennes , Woodford         Green}          
        b. **rol**: variable explicativa        
        
5. *Hotel_lat* (numeric): Latitud de l'hotel.       
        a. **rang**: {41.32838 , 52.40018}              
        b. **rol**: geolocalitzaci√≥       
        c. **missing_code**: NA       

6. *Hotel_lng* (numeric): Longitud de l'hotel.       
        a. **rang**: {-0.3697581 , 16.4219737}       
        b. **rol**: geolocalitzaci√≥       
        c. **missing_code**: NA       

7. *Businesses_100m* (integer): Nombre de negocis a 100 metres a la rodona de l'hotel.       
        a. **rang**: {1 , 254}       
        b. **rol**: variable explicativa       
        c. **missing_code**: NULL

8. *Businesses_1km* (integer): Nombre de negocis a 1 km a la rodona de l'hotel.       
        a. **rang**: {5 , 5500}       
        b. **rol**: variable explicativa       
        c. **missing_code**: NULL 
        
9. *Businesses_5km* (integer): Nombre de negocis a 5 km a la rodona de l'hotel.       
        a. **rang**: {408 , 30300}       
        b. **rol**: variable explicativa       
        c. **missing_code**: NULL 

10. *Room_Type_Level* (qualitative): Tipus d'habitaci√≥ contractada per l'usuari que ha escrit la ressenya.       
        a. **modalitats**: {Ambassadors , Art , Business , Business Class , City , Classic , Deluxe , Duplex , Executive         , Family , Luxury , NULL , Premium , Privilege , Standard , Studio , Suite , Superior}         
        b. **rol**: variable explicativa          
        c. **missing_code**: NULL        
        
11. *Guest_Type* (qualitative): Perfil del client que ha escrit la ressenya, obtingut a partir de tags.       
        a. **modalitats**: {Couple , Family with older children , Family with young children , Group , Solo traveler ,          Travelers with friends , With a pet}          
        b. **rol**: variable explicativa            
  
12. *Trip_Type* (qualitative): Tipus de viatge realitzat pel client que ha escrit la ressenya, obtingut a partir de tags.      
        a. **modalitats**: {Business trip , Couple , Family with older children , Family with young children , Leisure           trip , NULL , Solo traveler}          
        b. **rol**: variable explicativa        
        
13. *Stay_Duration* (integer): Total de nits d'estada.      
        a. **rang**: {1 , 20}          
        b. **rol**: variable explicativa       
        
14. *Review_Date* (data: yyyy-mm-dd): Data en la qual l'usuari ha escrit la ressenya a Booking.      
        a. **rang**: {2015-08-04 , 2017-08-03}          
        b. **rol**: variable explicativa    
        
15. *Days_Since_Review* (integer): Difer√®ncia de dies entre la data en la qual l'usuari ha escrit la ressenya a Booking i la data de *checkout*.      
        a. **rang**: {0 , 730}          
        b. **rol**: variable explicativa    

16. *Is_Hotel_Holiday* (qualitative): Variable bin√†ria que indica si va ser festiu a la ciutat on es troba l'hotel, a la Review date.               
        a. **modalitats**: {0: No , 1: Yes}          
        b. **rol**: variable explicativa            
        
17. *Is_Reviewer_Holiday* (qualitative): Variable bin√†ria que indica si va ser festiu al pais del client, a la Review date.               
        a. **modalitats**: {0: No , 1: Yes}          
        b. **rol**: variable explicativa                    

18. *Total_Number_of_Reviews* (integer): Nombre total de ressenyes v√†lides que t√© l'hotel a Booking.         
        a. **rang**: {60 , 16670}          
        b. **rol**: variable explicativa                

19. *Review_Is_Positive* (qualitative): Variable bin√†ria que indica si el nombre de paraules a la variable *Review Total         Positive Word Counts* √©s major que a la variable *Review Total Negative Word Counts*.          
        a. **modalitats**: {0: No , 1: Yes}          
        b. **rol**: variable explicativa                
        
20. *Review_Positivity_Rate* (numeric): Mesura el grau de positivisme de la ressenya fent la mitjana ponderada del total de paraules a la ressenya positiva (*Review Total Positive Word Counts*) sobre la suma del total de paraules tant en la positiva com en la negativa (*Review Total Negative Word Counts*).            
        a. **rang**: {0 , 100}          
        b. **rol**: variable resposta            
        
21. *Reviewer Nationality* (qualitative): Nacionalitat de l'usuari que ha escrit la ressenya.       
        a. **modalitats**: {"" , Abkhazia Georgia , Albania , Andorra , Angola , Argentina , Armenia , Australia ,              Austria , Azerbaijan , Bahrain , Bangladesh ,...} *(123 modalitats)*       
        b. **rol**: variable explicativa       
        c. **missing_code**:  ""       
        
22. *Negative_Review* (text): Ressenya negativa escrita per l'usuari.       
        a. **rol**: text     
        b. **missing_code**:  "Na"          
        
23. *Review_Total_Negative_Word_Counts* (integer): Nombre total de paraules a la ressenya negativa escrita per l'usuari.         
        a. **rang**: {0 , 372}          
        b. **rol**: variable explicativa       

24. *Positive_Review* (text): Ressenya positiva escrita per l'usuari.       
        a. **rol**: text     
        b. **missing_code**:  "Na"           
        
25. *Review_Total_Postive_Word_Counts* (integer): Nombre total de paraules a la ressenya positiva escrita per l'usuari.          a. **range**: {0 , 247}          
        b. **rol**: variable explicativa         

26. *Average_Score* (numeric): Valoraci√≥ mitjana de l'hotel a la p√†gina de Booking a data 31 de desembre de 2016.        
        a. **range**: {5.2 , 9.6}          
        b. **rol**: variable explicativa                            

27. *Reviewer_Score* (numeric): Valoraci√≥ global otorgada per l'usuari que ha escrit la ressenya.        
        a. **range**: {2.5 , 10}          
        b. **rol**: variable explicativa                         
        
28. *Total_Number_of_Reviews_Reviewer_Has_Given* (integer): Nombre total de ressenyes a la web de Booking escrites per l'usuari.          
        a. **range**: {1 , 156}                    
        b. **rol**: variable explicativa                                      
   
29. *Additional_Number_of_Scoring* (integer): Nombre total de valoracions adicionals v√†lides sobre diferents aspectes de l'hotel.            
        a. **range**: {8 , 2682}                       
        b. **rol**: variable explicativa           

30. *Submited_from_Mobile* (qualitative): Variable bin√†ria que indica si la ressenya s'ha pujat a Booking via tel√®fon m√≤vil.               
        a. **modalitats**: {0: No , 1: Yes}          
        b. **rol**: variable explicativa                    
          
-----------------------------


\subsection{An√†lisi explorat√≤ri inicial de les variables}

Un cop tenim ben definida la base de dades, aix√≠ com el diccionari de metadades que l'acompanya, conv√© conduir un an√†lisi exploratori inicial de les variables amb l'objectiu de millorar la percepci√≥ que tenim sobre aquestes, i descobrir m√©s a fons la seva estructura. Aquesta aproximaci√≥ inicial, tamb√© ens permetr√† detectar anomalies, que posteriorment corregirem a la fase de preprocessament. 

Tot i que majorit√†riament farem servir t√®cniques d'an√†lisi univariant, hi ha un ampli ventall d'eines que es poden fer servir de manera complement√†ria. M√©s que un procediment formal, l'an√†lisi exploratori de dades √©s una aproximaci√≥ a l'an√†lisi de dades que posposa les suposicions habituals sobre quin tipus de model de dades tenim, amb una aproximaci√≥ molt m√©s directe a aquestes, que revela la seva estructura i model subjacent. Aix√≤ va molt m√©s enll√† que una mera col.lecci√≥ de t√®cniques; EDA (exploratory data analysis) √©s una filosofia sobre com diseccionem un conjunt de dades, el que busquem, com les veiem i com les interpretem. En aquest apartat, pretenem aconseguir aquest objectiu a partir de gr√†fics estad√≠stics univariants de les nostres variables.

Per a no perdre el fil, proposem seguir l'ordenaci√≥ que hem especificat al diccionari de dades. Les primeres variables *id* i *Hotel_Name* no les representem a cap gr√†fic, ja que s√≥n identificadors dels registres. Aix√≠ doncs, comen√ßem amb la variable *Hotel_Country* *(Figure 5)*.

```{r, warning=F, comment = "", message=FALSE}
summary(dd$Hotel_Country)
```
Aquesta, apareix codificada com una variable qualitativa de 6 modalitats amb nombre d'individus a cada modalitat igual al resultat anterior.

```{r, fig.cap="Pie Chart Hotel_Country (Raw)", warning=F, comment = "", message=FALSE, fig.height = 3.8, fig.width=4.4}
library(colorspace)
paleta<-rainbow_hcl(length(levels(dd[,3])))
par(cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6)	
pie(table(dd$Hotel_Country), col = paleta,  main = "Hotel_Country (Raw)")
legend("topleft", c("AT","ES","FR","GB","IT","NL"), cex=0.5, fill=paleta)
```

Es pot observar que la meitat de la mostra de l'estudi es troba al Regne Unit, seguit de Fran√ßa, Espanya i els Pa√Øsos Baixos, entre els quals componen un 1/3 del total.      

\vspace{2mm}

La seg√ºent variable a estudiar √©s *Hotel_City*. Aquesta tamb√© apareix codificada com una variable qualitativa amb 16 modalitats, de manera que el procediment a aplicar √©s id√®ntic a l'anterior *(Figure 6)*.

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Hotel_City)
```

```{r, fig.cap="Bar plot Hotel_City (Raw)", warning=F, comment = "", message=FALSE, fig.height = 4.5, fig.width=5.3}
paleta<-rainbow_hcl(length(levels(dd[,4])))
par(las = 2, oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6)  
barplot(table(dd$Hotel_City), ylim = c(0, 3000), col = paleta ,main = "Hotel_City (Raw)", ylab = "Frequency")
legend("topright",  levels(dd[,4]), cex=0.45, fill=paleta)
```

Al igual que hem vist per al cas univariant per pa√Øsos, el Regne Unit, √©s qui mes hotels aporta a l'estudi, localitzant-se la majoria a la capital, Londres. Tamb√©, al igual que en el cas anterior, en una segona escala trobem les capitals dels Pa√Øsos Baixos i Fran√ßa. La totalitat dels hotels espanyols analitzats es troben a Barcelona. Adicionalment, tenim un ampli ventall de ciutats i districtes que, de cara el preprocessing, en reduirem el nombre per tal de sintetitzar la informaci√≥ i analitzar les ciutats m√©s rellevants.           

\vspace{2mm}

A continuaci√≥, tractem conjuntament les variables de localitzaci√≥ latitud i longitud. Considerem fer un resum num√®ric per a totes dues variables, acompanyat de dos boxplots *(Figure 7)*.

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Hotel_lat)
summary(dd$Hotel_lng)
```
Aqu√≠ tenim les primeres dades mancants (NA). Cal pendre nota d'aquesta anomalia per a corregir-la a la fase de preprocessament.

```{r, fig.cap="Boxplot Mesures de localitzaci√≥ (Raw)", warning=F, comment = "", message=FALSE, fig.height = 4.5, fig.width=6}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mfrow = c(1, 2)) 
boxplot(dd$Hotel_lat, data = dd, col = "gray", pch = 16, 
        main = "Hotel_lat (Raw)")
boxplot(dd$Hotel_lng, data = dd, col = "gray", pch = 16, 
        main = "Hotel_lng (Raw)")
```

Pel que fa a la latitud on es troben els hotels, observem que la majoria es troben al voltant de 51¬∫N, el qual passa per pa√Øsos com el Regne Unit, Fran√ßa o B√®lgica. D'altra banda, mencionar que en el nostre estudi nom√©s hi trobem hotels entre les latituds 41¬∫ i 52¬∫ N, els quals coincideixen, √≤bviament amb les latituds de la majoria dels pa√Øsos europeus.

Complement√†riament, per con√®ixer la localitzaci√≥ dels hotels tamb√© necessitem la longitud, que √©s una linia im√†ginaria que va de pol a pol. Aqu√≠ podem observar com el gran gruix dels hotels es troben al voltant del 0¬∫, √©s a dir, al voltant del Meridi√† de Greenwich, el qual passa per Espanya, Fran√ßa i el Regne Unit.           

\vspace{2mm}

A continuaci√≥, passem a analitzar les variables *Businesses_100m, Businesses_1km, Businesses_5km*. A primera vista, ja veiem que aquestes tres variables apareixen mal codificades (les tenim com a factors i haurien de ser num√®riques). En conseq√º√®nia, les apartem per analitzar-les un cop haguem fet el preprocessament i les tinguem en el tipus adequat. Tanmateix sabem que tenim 23 valors missings per a aquestes variables que es desprenen de la falta d'informaci√≥ de mesures de localitzaci√≥ i coincideixen en les observacions (caldr√† tenir-ho en consideraci√≥ per al preprocessament).          

\vspace{2mm}

Seguidament, considerem la variable *Room_Type_Level* i observem quins s√≥n els tipus d'habitacions m√©s freq√ºents *(Figure 8)*. De nou, la variable √©s qualitativa i repliquem el procediment descrit anteriorment per a variables qualitatives.

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Room_Type_Level)
```

```{r, fig.cap="Barplot Room_Type_Level (Raw)", warning=F, comment = "", message=FALSE, fig.height = 4.8, fig.width=5.3}
paleta<-rainbow_hcl(length(levels(dd[,10])))
par(las = 2, oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6)  
barplot(table(dd$Room_Type_Level), ylim = c(0, 3500), col = paleta ,main = "Room_Type_Level (Raw)", ylab = "Frequency")
legend("topleft",  levels(dd[,10]), cex=0.45, fill=paleta)
```

En aquest cas, el tipus d'habitacions que m√©s abunden tendeixen a ser diferents a les habituals, doncs la m√©s repetida √©s null. Aquesta variable vol dir que no es refereix a cap de les altres categories, potser degut a una falta d'estandaritzaci√≥ dels noms de les habitacions (cada hotel pot fer servir noms diferents per a referir-se al mateix tipus d'habitaci√≥).
Tot i aix√≤, si ens quedem amb les denominacions de les que disposem, obtenim que les tres m√©s freq√ºents s√≥n: Standard, Superior, Deluxe i Classic. Finalment, dir que tenim un nombre considerable de modalitats per a la variable i, potser, haur√≠em de considerar redu√Ør-lo a la fase de preprocessament.        

\vspace{2mm}

A continuaci√≥, tractem conjuntament les variables *Guest_Type* i *Trip_Type*, ja que estan for√ßa relacionades entre s√≠ en refer√®ncia al perfil del client i el viatge que busca. Fem servir la mateixa metodologia, tots dos s√≥n factors amb 7 modalitats *(Figure 9)*.

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Guest_Type)
summary(dd$Trip_Type)
```

```{r, fig.cap="Barplot perfils client/viatge (Raw)", warning=F, comment = "", message=FALSE, fig.height = 4.5, fig.width=7}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mfrow = c(1, 2)) 
paleta<-rainbow_hcl(length(levels(dd[,11])))
barplot(table(dd$Guest_Type), col = paleta ,main = "Guest_Type (Raw)", ylab = "Frequency")
legend("topright",  levels(dd[,11]), cex=0.55, fill=paleta)
barplot(table(dd$Trip_Type), col = paleta ,main = "Trip_Type (Raw)", ylab = "Frequency")
legend("topleft",  levels(dd[,12]), cex=0.5, fill=paleta)
```

Realitzant els gr√†fics i els recomptes per variable, podem concloure que les parelles s√≥n el tipus d'hostes m√©s freq√ºents pel que fa a la variable *Guest_Type*, mentre que en segona posici√≥ tindriem els que realitzen el viatge en solitari (ja sigui per motius laborals o pr√≤piament d'oci). En refer√®ncia a la variable *Trip_Type* estudiada, s'observa clarament com el tipus de viatge m√©s freq√ºent √©s el d'oci, seguit a molta dist√†ncia pel viatge amb motius de negocis, √©ssent la resta valors (inclosa la categoria NULL) residuals. De cara el preprocessing ajuntarem les variables family en una sola.        

\vspace{2mm}

La seg√ºent variable a estudiar √©s la que informa sobre la duraci√≥ de l'est√†ncia *Stay_Duration*. Aquesta, la tenim codificada com a num√®rica i podem explorar-la a trav√©s d'un resum num√®ric i representar-la gr√†ficament amb un histograma *(Figure 10)*.

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Stay_Duration)
```

```{r, fig.cap="Histograma Stay_Duration (Raw)", warning=F, comment = "", message=FALSE, fig.height = 4.8, fig.width=5.3}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6) 
hist(dd$Stay_Duration, xlab = "# Dies", breaks = 20, col = "grey",
     main = "Stay_Duration (Raw)", ylim = c(0, 3500))
```

Veiem com els dies que un hoste passa a l'hotel com a m√†xim arriba a 20, per√≤ si ens quedem amb els m√©s freq√ºents dir√≠em que entre 1 i 3, donat que aquest interval compr√©n, aproximadament, el 75% de les observacions.        

\vspace{2mm}

La seg√ºent variable *Review_Date* fa refer√®ncia a la data en la que es va escriure la ressenya a Booking. En aquest cas, apareix codificada com a num√®rica. Per a poder treballar amb ella caldr√† que la transformem en data del tipus *yyyy/mm/dd* (pendent de preprocessament).           

\vspace{2mm}

Passa una cosa semblant amb la variable *Days_Since_Review*, actualment factor amb 720 nivells. D'aquesta variable ens interessar√† tenir, codificat com a variable num√®rica, el nombre de dies que han transcorregut (pendent de preprocessament).         

\vspace{2mm}

Seguidament, les variables bin√†ries *Is_Hotel_Holiday* i *Is_Reviewer_Holiday* apareixen codificades com a num√®riques, quan interessaria m√©s tenir-les com a factors. En aquest sentit, plantegem igualment construir la proporci√≥ de 1 (S√≠) que tenim sobre el total mitjan√ßant un pie chart *(Figure 11)*.

```{r, fig.cap="Pie Chart Festivitats (Raw)", warning=F, comment = "", message=FALSE, fig.height = 5.2, fig.width=5.8}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mfrow = c(1, 2)) 
paleta<-rainbow_hcl(2)
pie(table(dd$Is_Hotel_Holiday), col = paleta, main = "Is_Hotel_Holiday (Raw)")
legend("topright", c("No","Yes"), cex=0.75, fill=paleta)
pie(table(dd$Is_Reviewer_Holiday), col = paleta, main = "Is_Reviewer_Holiday (Raw)")
legend("topright", c("No","Yes"), cex=0.75, fill=paleta)
```

En primer lloc, s'observa que, majorit√†riament, l'hotel no es troba en dia festiu en la data que es va escriure la ressenya. En segon lloc, al igual que per a l'hotel, tamb√© √©s pr√†cticament total la resposta no, en refer√®ncia a la festivitat al pa√≠s d'origen del client. Totes dues freq√º√®ncies s√≥n semblants a les dues variables. Per depurar m√©s l'an√†lisi podriem considerar analitzar si els valors 1 per a una de les dues es corresponen amb els valors 1 de l'altra.

```{r, warning=F, comment = "", message = FALSE, results = 'hide'}
sum(dd$Is_Hotel_Holiday*dd$Is_Reviewer_Holiday)
```
* Veiem que hi ha 65 casos dels 67 de la varible *Is_Reviewer_Holiday* que coincideixen.              

\vspace{2mm}

Seguidament, analitzem la variable *Total_Number_of_Reviews*. Aquesta apareix codificada correctament com a num√®rica aix√≠ que constru√Øm un histograma *(Figure 12)* i el complementem amb un resum num√®ric, com en els casos anteriors.

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Total_Number_of_Reviews)
```

```{r, fig.cap="Histograma Total_Number_of_Reviews (Raw)", warning=F, comment = "", message=FALSE, fig.height = 4.8, fig.width=5.8}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6) 
hist(dd$Total_Number_of_Reviews, xlab = "# Dies", breaks = 20, col = "grey",
     main = "Total_Number_of_Reviews (Raw)")
```

El nombre total de ressenyes, oscil.la entre 60 i 16.670, existint la concentraci√≥ m√†xima entre els 60 i 5000. Veiem com la variable mostra una distribuci√≥ semblant a una Chi_Quadrat, igual que la variable *Stay_Duration*. Aquest fet, sembla ll√≤gic ja que les dues tenen un zero natural.         

\vspace{2mm}

A continuaci√≥ tenim dues variables que reflecteixen el grau de positivisme del comentari. En aquest sentit, hem considerat tractar-les conjuntament tot i que la primera d'elles *Review_Is_Positive*, apareix mal codificada (√©s una variable bin√†ria i per tant hauria de ser un factor, no una variable num√®rica). En aquest cas, considerem un resum num√®ric per a la variable *Review_Positivity_Rate* i un gr√†fic conjunt (histograma) d'aquesta amb *Review_Is_Positive* *(Figure 13)*.

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Review_Positivity_Rate)
```

```{r, fig.cap="Gr√†fics variables positivisme de la ressenya (Raw)", warning=F, comment = "", message=FALSE, fig.height = 4.5, fig.width=5.8}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mfrow = c(1, 2)) 
paleta<-rainbow_hcl(2)
pie(table(dd$Review_Is_Positive), col = paleta, main = "Review_Is_Positive (Raw)")
legend("topright", c("No","Yes"), cex=0.75, fill=paleta)
hist(dd$Review_Positivity_Rate, xlab = "Score", breaks = 100, col = "grey",
     main = "Review_Positivity_Rate (Raw)")
```

En primer lloc, dir que aquestes variables tenen molta rellev√†ncia en l'an√†lisi ja que representen, o estan molt relacionades, amb la resposta que volem estudiar. Es pot observar que les ressenyes positives s√≥n lleugerament m√©s elevades per√≤ pr√†cticament observem un empat.

En segon lloc, en refer√®ncia al ratio de positivitat, al gr√†fic es veu com la variable presenta molta variabilitat. Ara b√©, si ens centrem en els valors que es situen una mica per sobre de la l√≠nia que marca les variables menys freq√ºents, observem com aquestes s√≥n 0, 25, 33.3, 50, 60, 66.6 i 100, els quals podriem dividir en dos subgrups, un primer per 0 i 10, i un segon per la resta. Aix√≤ vol dir que les valoracions s√≥n molt polaritzades i caldria considerar si definitivament seria bo fer servir aquesta variable com a resposta.           

\vspace{2mm}

A continuaci√≥ tenim la variable *Reviewer_Nationality* qualitativa i amb 123 modalitats. Com a conseq√º√®ncia d'aquest nombre tan elevat de nivells del factor, els gr√†fics es tornen il.legibles.

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Reviewer_Nationality)
```
           
\vspace{2mm}

Seguidament, comentem de manera conjunta les variables *Negative_Review, Review_Total_Negative_Word_Counts, Positive_Review i Review_Total_Positive_Word_Counts*. La primera i la tercera contenen, per a cada registre, una cadena de car√†cters que fa refer√®ncia a la ressenya completa que l'usuari ha escrit a la p√†gina web de Booking. Considerem, de moment, deixar-les de banda per a l'an√†lisi textual que realitzarem a l'√∫ltim cap√≠tol del treball. Ara, si ens centrem en les dues restants, observem com apareixen degudament codificades (variables num√®riques), i pot ser interessant fer un boxplot conjunt de les dues per a comparar-les *(Figure 14)*. A priori, haur√≠en de ser complement√†ries, aquelles ressenyes amb major nombre de paraules als comentaris positius hauren de tenir un nombre molt petit de paraules als comentaris negatius, i viceversa. Acompanyem els boxplots amb resums num√®rics per a les dues variables (negative/positve).

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Review_Total_Negative_Word_Counts)
summary(dd$Review_Total_Positive_Word_Counts)
```

```{r, fig.cap="Boxplot Paraules als comentaris negatius/positius (Raw)", warning=F, comment = "", message=FALSE, fig.height = 4.2, fig.width=6}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mfrow = c(1, 2)) 
boxplot(dd$Review_Total_Negative_Word_Counts, data = dd, col = "gray", pch = 16, 
        main = "Review_Total_Negative_Word_Counts (Raw)")
boxplot(dd$Review_Total_Positive_Word_Counts, data = dd, col = "gray", pch = 16, 
        main = "Review_Total_Positive_Word_Counts (Raw)")
```

Pel que fa al nombre de paraules negatives per ressenya, destacar que la freq√º√®ncia modal √©s entre 0 i 20, trobant-se la mitjana en 19,38. Si ara considerem els comentaris positius, obtenim que podr√≠em reduir m√©s aquest interval i situar-lo entre 0 i 10, tot i trobar-se la mitjana en 17. Aix√≤ √©s indicatiu que quan la experi√®ncia no ha estat bona l'usuari tendeix a escriure ressenyes m√©s llargues.        

\vspace{2mm}

A continuaci√≥, tractarem les variables *Average_Score* i *Reviewer_Score*, ambdues de gran rellev√†ncia per a l'an√†lisi. Apareixen codificades correctament, de manera que podem construir resums num√®rics i boxplots per a les dues.

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Average_Score)
summary(dd$Reviewer_Score)
```

```{r, fig.cap="Boxplot Puntuacions (Raw)", warning=F, comment = "", message=FALSE, fig.height = 4.2, fig.width=6}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mfrow = c(1, 2)) 
boxplot(dd$Average_Score, data = dd, col = "gray", pch = 16, 
        main = "Average_Score (Raw)")
boxplot(dd$Reviewer_Score, data = dd, col = "gray", pch = 16, 
        main = "Reviewer_Score (Raw)")
```

Observem com les puntuacions que han anat otorgant els usuaris s√≥n, en promig, similars a la valoraci√≥ mitjana acumulada pels hotels a finals de l'any 2016 *(Figure 15)*. Tanmateix, la variabilitat en la valoraci√≥ dels usuaris √©s m√©s alta, situaci√≥ ll√≤gica ja que la variable *Average_Score* √©s un promig. En general, una valoraci√≥ agregada de tots els hotels estaria al voltant de 8,3 i seria interessant en seccions posteriors veure com evoluciona la puntuaci√≥ que otorguen els clients al llarg del temps (en funci√≥ de la variable *Review_Date*).           

\vspace{2mm}

Seguidament, passem a la variable *Total_Number_of_Reviews_Reviewer_Has_Given*, indicador de si l'usuari √©s molt actiu, o no, al portal web. La variable √©s num√®rica i la tenim codificada correctament, aix√≠ que, com en els casos anteriors, elaborem un resum num√®ric i un histograma *(Figure 16)*.

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Total_Number_of_Reviews_Reviewer_Has_Given)
```

```{r, fig.cap="Histograma Total_Number_of_Reviews_Reviewer_Has_Given (Raw)", warning=F, comment = "", message=FALSE, fig.height = 3.8, fig.width=4.5}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6) 
hist(dd$Total_Number_of_Reviews_Reviewer_Has_Given, xlab = "# Ressenyes v√†lides", breaks = 20, col = "grey",
     main = "Total_Number_of_Reviews_Reviewer_Has_Given (Raw)")
```

Veiem com, per m√©s d'un 25% dels usuaris, √©s la primera ressenya que escriuen. La mitjana es situa en 7,3, i el 75% dels valors es troben compresos entre 1 i 9. No sembla un nombre de ressenyes massa elevat (poca participaci√≥).            

\vspace{2mm}

Seguidament analitzem la variable *Additional_Number_of_Scoring*, cas id√®ntic al de la variable anterior, per√≤ ara considerem totes les valoracions adicionals (serveis, localitzaci√≥ etc..) v√†lides que t√© l'hotel en questi√≥ al portal de Booking *(Figure 17)*.

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Additional_Number_of_Scoring)
```

```{r, fig.cap="Histograma Additional_Number_of_Scoring (Raw)", warning=F, comment = "", message=FALSE, fig.height = 4.8, fig.width=5.5}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6) 
hist(dd$Additional_Number_of_Scoring, xlab = "# Ressenyes v√†lides", breaks = 20, col = "grey",
     main = "Additional_Number_of_Scoring (Raw)")
```

Veiem com el nombre de puntuacions adicionals va des de 8 (m√≠nim) fins a 2682 (m√†xim). Cal destacar que els dos quartils s√≥n m√©s propers, entre 170 i 666 unitats, i per tant podr√≠em considerar que tenim valors an√≤mals a la variable (caldria estudiar en detall aquestes observacions amb valors extrems). Tanmateix, observem com, en general, les puntuacions de serveis s√≥n m√©s elevades que les de ressenyes escrites, ja que el m√®tode √©s m√©s c√≤mode per a l'usuari (marcar estrelles vs. escriure un comentari).            

\vspace{2mm}

Per finalitzar aquesta primera part d'an√†lisi explorat√≤ri de dades considerem la variable *Submitted_from_Mobile* bin√†ria. De nou, la variable bin√†ria apareix codificada com a num√®rica i caldr√† tractar-la a la fase de preprocessament per codificar-la correctament. Tanmateix, podem emprar el mateix procediment que per a les altres vairables bin√†ries i construir un pie chart *(Figure 18)*.

```{r, fig.cap="Pie Chart Submitted_from_Mobile (Raw)", warning=F, comment = "", message=FALSE, fig.height = 4.5, fig.width=5.8}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mfrow = c(1, 2)) 
paleta<-rainbow_hcl(2)
pie(table(dd$Submitted_from_Mobile), col = paleta, main = "Submitted_from_Mobile (Raw)")
legend("topright", c("No","Yes"), cex=0.75, fill=paleta)
```

Observem com predominen les ressenyes escrites des del tel√®fon m√≤bil.

\newpage

\subsection{Proc√©s de preprocessament}

Un cop feta l'aproximaci√≥ incial a les dades que hem platejat a l'apartat anterior, en la fase de preprocessament el que es busca √©s corregir els errors o problemes detectats (outliers, NAs ...) que perjudicar√†n la qualitat dels an√†lisis posteriors. 

```{r, warning=F, comment = "", message=FALSE, include = F, results='hide'}
dim(dd) ## dimensions
colnames(dd) ### Nom de les columnes
rownames(dd) ### Nom de les files
str(dd)
summary(dd)
attach(dd)
```

En primer lloc, transformem el tipus/classe de les variables mal codificades.
Les variables *Businesses_100m, Businesses_1km, Businesses_5km i Days_Since_Review*, les hem transformat en variables num√®riques enteres. D'altra banda les variables *Is_Hotel_Holiday, Is_Reviewer_holiday, Submitted_from_Mobile i Review_Is_Positive*, les hem transformat en factor. Totes elles s√≥n variables dicot√≤miques i, en conseq√º√®ncia, hem declarat els nivells (1: S√≠ i 0:No).
Per √∫ltim, codifiquem com a data la variable *Review_Date*. En aquest apartat podem meniconar tamb√© que les variables textuals *Positive_Review* i *Negative_Review* no s'ajusten exactement a un factor amb diferents nivells aix√≠ que les podr√≠em codificar com cadenes de car√†cters. Tanmateix, com que nom√©s les farem servir en un √†mbit redu√Øt de l'an√†lisi i, el seu estat actual no representa un problema, hem considerat mantenir-les com a factor per convertir-les a car√†cter quan realitzem l'an√†lisi textual.

```{r, warning=F, comment = "", message=FALSE, results='hide'}
#4.1. Identificar les variables categ√≤riques
class(dd[,1])
sapply(dd, class)

#4.2. Declarar com a factor
dd$id <- as.numeric(as.character(dd$id))
dd$Hotel_lat<-as.numeric(as.character(dd$Hotel_lat))
dd$Hotel_lng<-as.numeric(as.character(dd$Hotel_lng))
dd$Businesses_100m<-as.numeric(as.character(dd$Businesses_100m))
dd$Businesses_1km<-as.numeric(as.character(dd$Businesses_1km))
dd$Businesses_5km<-as.numeric(as.character(dd$Businesses_5km))
dd$Stay_Duration<-as.numeric(as.character(dd$Stay_Duration))
dd$Is_Hotel_Holiday <- as.factor(dd$Is_Hotel_Holiday)
dd$Is_Reviewer_Holiday <- as.factor(dd$Is_Reviewer_Holiday)
dd$Total_Number_of_Reviews<-as.numeric(as.character(dd$Total_Number_of_Reviews))
dd$Review_Is_Positive <- as.factor(dd$Review_Is_Positive)
dd$Review_Positivity_Rate<-as.numeric(as.character(dd$Review_Positivity_Rate))
dd$Review_Total_Negative_Word_Counts<-as.numeric(as.character(dd$Review_Total_Negative_Word_Counts))
dd$Review_Total_Positive_Word_Counts<-as.numeric(as.character(dd$Review_Total_Positive_Word_Counts))
dd$Average_Score <- as.numeric(as.character(dd$Average_Score))
dd$Reviewer_Score<- as.numeric(as.character(dd$Reviewer_Score))
dd$Total_Number_of_Reviews_Reviewer_Has_Given<-as.numeric(as.character(dd$Total_Number_of_Reviews_Reviewer_Has_Given))
dd$Additional_Number_of_Scoring<-as.numeric(as.character(dd$Additional_Number_of_Scoring))
dd$Submitted_from_Mobile <- as.factor(dd$Submitted_from_Mobile)


#Detalls (a la variable Days_Since_Review cal treure-li "day" , i Review_Date cal passar-la a data )

dd$Days_Since_Review <- gsub("[^0-9]", "", dd$Days_Since_Review)
dd$Days_Since_Review <- as.numeric(dd$Days_Since_Review)

dd$Review_Date<- paste(substr(dd$Review_Date, 1, 5-1), "/", substr(dd$Review_Date, 5, nchar(dd$Review_Date)), sep = "")
dd$Review_Date <- paste(substr(dd$Review_Date, 1, 8-1), "/", substr(dd$Review_Date, 8, nchar(dd$Review_Date)), sep = "")
dd$Review_Date[which(dd$Review_Date ==  "NA/NA/")] <- NA
mode(dd$Review_Date)

dd$Review_Date <- as.Date(dd$Review_Date, "%Y/%m/%d")
```

Un cop tenim totes les variables en el tipus d'R convenient, ens centrem en les modalitats de les variables qualitatives. Observem els diferents nivells que presenten, a partir de definir una funci√≥ que selecciona les variables de la base de dades segons de la seva classe, per tal d‚Äôextreure nom√©s els factors i mirar els seus nivells (recordem que cal obviar les variables textuals). Com a filtre adicional, considerem tractar √∫nicament aquells factors amb nombre de nivells inferior a 150. A banda de les variables textuals, la variable *Hotel_Name* tampoc la considerem ja que cada nom √©s √∫nic i serveix per a identificar completament un registre, no t√© sentit aplicar cap tipus d'agrupaci√≥ de modalitats en aquest cas.

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
subset_colclasses <- function(DF, colclasses="numeric") {
  DF[,sapply(DF, function(vec, test) class(vec) %in% test, test=colclasses)]
}

for(i in names(subset_colclasses(dd, "factor"))){
  if(length(levels(dd[ ,i])) < 1000){
      cat("Variable:", i, "Nivells:", levels(dd[ ,i]), "\n")
  }
}
```

```{r, warning=F, comment = "", message=FALSE, results = 'asis'}
require(pander)
file <- "Nivells.csv"
nivells <- read.csv(file = paste(datapath, file, sep = "/"), sep = ";")
nivells$Variable <- as.character(nivells$Variable)
nivells$Nivells <- as.character(nivells$Nivells)

panderOptions('table.split.table', 300)
set.caption("Modalitats de les variables qualitatives")
pandoc.table(nivells, style = 'rmarkdown')
```

En aquest sentit, volem analitzar els nivells de cada variable a fi d'esbrinar si existeixen redund√†ncies entre aquests, si podem eliminar algun, o si simplement les etiquetes no s√≥n convenients. En general, √©s recomanable recategoritzar factors amb nivells que reflexen el mateix, o aquelles variables amb un gran nombre de categories per a facilitar an√†lisis posteriors.

En primer lloc, assignem etiquetes *(No, S√≠)* a les variables dicot√≤miques. 

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
levels(dd$Is_Hotel_Holiday) 
levels(dd$Is_Reviewer_Holiday) 
levels(dd$Submitted_from_Mobile)
levels(dd$Review_Is_Positive)

levels(dd$Is_Hotel_Holiday) <- c("No","Yes")
levels(dd$Is_Reviewer_Holiday) <- c("No","Yes")
levels(dd$Submitted_from_Mobile) <- c("No","Yes")
levels(dd$Review_Is_Positive) <- c("No","Yes")
```

Seguidament, plantegem redefinir les categories de la resta de variables qualitatives de la taula anterior. Un cop arribats a aquest punt, √©s convenient mencionar que en aquest procediment es realitzar√† el tractament dels valors missing de les variables categ√≤riques. Mentre que, per a les variables num√®riques necessitarem realitzar una imputaci√≥ de valors, aqu√≠ podem simplement agrupar les dades mancants en una nova categoria (p.e. "Altres") i declarar-les com un nou nivell del factor. 

La primera variable √©s **Hotel_Country**. En aquest cas, veiem com no tenim valors missing i els nivells de la variable s√≥n √∫nicament 6 (AT, ES, FR, GB, IT, NL). En aquest sentit, es conclou que aquesta variable no necessita cap tipus de tractament.      

\vspace{2mm}

En segon lloc, considerem la variable **Hotel_City** i repetim la operaci√≥ (en aquest cas la variable no t√© valors missing).

* *ANTICS NIVELLS*:  Amsterdam, Amsterdam Zuidoost, Barcelona, Boulogne Billancourt, Donauinsel, El Prat de Llobregat, Fitzrovia, London, Milan, Paddington, Paris, Paris 06, Paris 12, Vienna, Vincennes, Woodford Green. 

* *NOUS NIVELLS*: Amsterdam{Amsterdam, Amsterdam Zuidoost}, Barcelona{Barcelona, El Prat de Llobregat} , Boulogne Billancourt{Boulogne Billancourt}, Vienna{Donauinsel, Vienna} , London{Fitzrovia, London, Paddington, Woodford Green}, Milan{Milan}, Paris{Paris, Paris 06, Paris 12}, Vicennes{Vincennes}. 

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
table(dd$Hotel_City) 
dd$Hotel_City<- factor(dd$Hotel_City, ordered=TRUE, levels= c("Amsterdam","Amsterdam Zuidoost","Barcelona","Boulogne Billancourt","Donauinsel","El Prat de Llobregat","Fitzrovia","London","Milan","Paddington","Paris","Paris 06","Paris 12","Vienna","Vincennes","Woodford Green"))
newvalues2 <- c("Amsterdam","Amsterdam","Barcelona","Boulogne Billancourt","Vienna","Barcelona","London","London","Milan","London","Paris","Paris","Paris","Vienna","Vincennes","London")
dd$Hotel_City <- newvalues2[ match(dd$Hotel_City,
                                c("Amsterdam","Amsterdam Zuidoost","Barcelona","Boulogne Billancourt","Donauinsel","El Prat de Llobregat","Fitzrovia","London","Milan","Paddington","Paris","Paris 06","Paris 12","Vienna","Vincennes","Woodford Green"))]
table(dd$Hotel_City)
class(dd$Hotel_City)
dd$Hotel_City <- as.factor(dd$Hotel_City)

summary(dd$Hotel_City)
```

Seguim amb el tractament de la variable **Room_Type_Level**. Recordem que, per a aquesta variable, tenim els missings codificats com a NULL. Definim la correspond√®ncia entre els antics nivells de la variable i els nous:

* *ANTICS NIVELLS*: Ambassadors, Art, Business, Business Class, City,
Classic, Deluxe, Duplex, Executive, Family, Luxury, NULL, Premium, Privilege, Standard, Studio, Suite, Superior.

* *NOUS NIVELLS*: Deluxe{Ambassadors, Art, Deluxe, Executive, Luxury, Premium, Privilege, Superior} , Business{Business, Business Class} , Classic{City, Classic} , Duplex{Duplex} , Family{Family} , Other{NULL} , Standard{Standard, Studio}, Suite{Suite}. 

Observeu que, els NULL que ten√≠em al principi els hem recodificat com a "Other".

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
dd$Room_Type_Level <- as.factor(as.character(Room_Type_Level))
table(dd$Room_Type_Level)
dd$Room_Type_Level<- factor(Room_Type_Level, ordered=TRUE, levels= c("Ambassadors","Art","Business","Business Class","City","Classic","Deluxe","Duplex","Executive","Family","Luxury","NULL","Premium","Privilege","Standard","Studio","Suite","Superior"))
newvalues <- c("Deluxe","Deluxe","Business","Business","Classic","Classic","Deluxe","Duplex","Deluxe","Family","Deluxe","Other","Deluxe","Deluxe","Standard","Standard","Suite","Deluxe")
dd$Room_Type_Level <- newvalues[ match(dd$Room_Type_Level,
                                    c("Ambassadors","Art","Business","Business Class","City","Classic","Deluxe","Duplex","Executive","Family","Luxury","NULL","Premium","Privilege","Standard","Studio","Suite","Superior"))]
table(dd$Room_Type_Level)
class(dd$Room_Type_Level)
dd$Room_Type_Level <- as.factor(dd$Room_Type_Level)
```
        
\vspace{2mm}

En relaci√≥ a la variable **Guest_Type**, mencionar que aquesta no rep cap tipus de modificaci√≥ ja que la seva codificaci√≥ inicial √©s adequada.      

La seg√ºent variable √©s **Trip_Type**. Aquest cas √©s similar a l'anterior, caldr√† recodificar els valors missing (els tenim com a NULL) com "Other". La correspond√®ncia entre els nivells antics i els nous √©s:

* *ANTICS NIVELLS*: Business trip, Couple, Family with older children, Family with young children, Leisure trip, NULL, Solo traveler.

* *NOUS NIVELLS*: Business trip{Business trip}, Couple{Couple}, Family {Family with older children, Family with young children}, Leisure trip{Leisure trip}, Other{NULL}, Solo traveler{Solo traveler}.  

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
table(dd$Trip_Type)
dd$Trip_Type<- factor(dd$Trip_Type, ordered=TRUE, levels= c("Business trip","Couple","Family with older children","Family with young children","Leisure trip","NULL","Solo traveler"))
newvalues3 <- c("Business trip","Couple","Family","Family","Leisure trip","Other","Solo traveler")
dd$Trip_Type <- newvalues3[ match(dd$Trip_Type,
                               c("Business trip","Couple","Family with older children","Family with young children","Leisure trip","NULL","Solo traveler"))]
table(dd$Trip_Type)
class(dd$Trip_Type)
dd$Trip_Type <- as.factor(dd$Trip_Type)

summary(dd$Trip_Type)
```

Per √∫ltim, cal recodificar la variable **Reviewer_Nationality**. Observem com, en aquest cas tenim un gran nombre de nivells (moltes nacionalitats diferents). Com a soluci√≥, hem proposat escollir les 20 nacionalitats m√©s freq√ºents i agrupar la resta en la categoria "Altres" (incloent en aquest grup els valors missings codificats com ""). Les correspond√®ncies s√≥n:

* *ANTICS NIVELLS*: Abkhazia Georgia, Albania, Andorra, Angola, Argentina, Armenia, Australia, Austria, Azerbaijan, Bahrain, Bangladesh, Barbados, Belgium, Bermuda, Bosnia and Herzegovina, Botswana, Brazil, Brunei, Bulgaria, Cameroon, Canada, Chile, China, Colombia, Comoros, Costa Rica, Croatia, Cura√ßao, Cyprus, Czech Republic, Denmark, Dominican Republic, Egypt, Estonia, Ethiopia, Finland, France, Gabon, Georgia, Germany, Gibraltar, Greece, Guernsey, Honduras, Hong Kong, Hungary, Iceland, India, Indonesia, Iran, Iraq, Ireland, Isle of Man, Israel, Italy, Ivory Coast, Jamaica, Japan, Jersey, Jordan, Kazakhstan, Kenya, Kosovo, Kuwait, Latvia, Lebanon, Liechtenstein, Lithuania, Luxembourg, Macedonia, Malaysia, Malta, Mauritius, Mexico, Moldova, Monaco, Montenegro, Morocco, Namibia, Nepal, Netherlands, New Caledonia, New Zealand, Nigeria, Norway, Oman, Pakistan, Panama, Peru, Philippines, Poland, Portugal, Puerto Rico, Qatar, Romania, Russia, Saint Barts, Saint Lucia, Saudi Arabia, Serbia, Singapore, Slovakia, Slovenia, South Africa, South Korea, Spain, Sri Lanka, Sweden, Switzerland, Taiwan, Thailand, Tunisia, Turkey, Uganda, Ukraine, United Arab Emirates, United Kingdom, United States Minor Outlying Islands, United States of America, Venezuela, Vietnam, Zambia.

* *NOUS NIVELLS*: Other{Abkhazia Georgia, Albania, Andorra, Angola, Argentina, Armenia, Azerbaijan, Bahrain, Bangladesh, Barbados, Bermuda, Bosnia and Herzegovina, Botswana, Brazil, Brunei, Bulgaria, Cameroon, Chile, China, Colombia, Comoros, Costa Rica, Croatia, Cura√ßao, Cyprus, Czech Republic, Denmark, Dominican Republic, Egypt, Estonia, Ethiopia, Finland, Gabon, Georgia, Gibraltar, Guernsey, Honduras, Hong Kong, Hungary, Iceland, India, Indonesia, Iran, Iraq, Isle of Man, Ivory Coast, Jamaica, Japan, Jersey, Jordan, Kazakhstan, Kenya, Kosovo, Latvia, Lebanon, Liechtenstein, Lithuania, Luxembourg, Macedonia, Malaysia, Malta, Mauritius, Mexico, Moldova, Monaco, Montenegro, Morocco, Namibia, Nepal, New Caledonia, Nigeria, Norway, Oman, Pakistan, Panama, Peru, Philippines, Poland, Portugal, Puerto Rico, Qatar, Romania, Russia, Saint Barts, Saint Lucia, Serbia, Singapore, Slovakia, Slovenia, South Africa, South Korea, Sri Lanka, Taiwan, Thailand, Tunisia, Uganda, Ukraine,United States Minor Outlying Islands, Venezuela, Vietnam, Zambia}, Australia{Australia}, Belgium{Belgium}, Canada{Canada}, France{France}, Germany{Germany}, Greece{Greece}, Ireland{Ireland}, Israel{Israel}, Italy{Italy}, Kuwait{Kuwait}, Netherlands{Netherlands}, New Zealand{New Zealand}, Saudi Arabia{Saudi Arabia}, Spain{Spain}, Sweeden{Sweeden}, Switzerland{Switzerland}, Turkey{Turkey}, United Arab Emirates{United Arab Emirates}, United Kingdom{United Kingdom}, United States of America{United States of America}.

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
table(dd$Reviewer_Nationality)
rn <- levels(dd$Reviewer_Nationality)
dd$Reviewer_Nationality<- factor(dd$Reviewer_Nationality, ordered=TRUE, levels= rn)
newvalues4 <- c("Other", "Other", "Other", "Other", "Other", "Other", "Other", "Australia",
                "Other","Other","Other","Other","Other","Belgium", "Other","Other","Other",
                "Other","Other","Other","Other","Canada","Other","Other","Other","Other",
                "Other","Other","Other","Other","Other","Other","Other","Other","Other","Other",
                "Other", "France", "Other","Other","Germany","Other","Greece","Other","Other","Other",
                "Other","Other","Other","Other","Other","Other","Ireland","Other","Israel", "Italy",
                "Other","Other","Other","Other","Other","Other","Other","Other","Kuwait","Other",
                "Other","Other","Other","Other","Other","Other","Other","Other","Other","Other",
                "Other","Other","Other","Other","Other","Netherlands","Other","New Zealand", "Other",
                "Other","Other","Other","Other","Other","Other","Other","Other","Other","Other",
                "Other","Other","Other","Other", "Saudi Arabia","Other", "Other","Other",
                "Other","Other","Other","Spain","Other","Sweeden", "Switzerland","Other",
                "Other","Other","Turkey","Other","Other","United Arab Emirates",
                "United Kingdom","Other", "United States of America","Other","Other",
                "Other")

dd$Reviewer_Nationality <- newvalues4[ match(dd$Reviewer_Nationality,
                               rn)]
table(dd$Reviewer_Nationality)
class(dd$Reviewer_Nationality)
dd$Reviewer_Nationality <- as.factor(dd$Reviewer_Nationality)

summary(dd$Reviewer_Nationality)        
```

Un cop realitzat cop definides les modalitats correctament, la seg√ºent passa √©s la imputaci√≥ dels valors missing de la base de dades, ja que d'ara endavant treballarem sense dades mancants. Com ja hem mencionat anteriorment, aquest proc√©s ja s'ha iniciat en el pas anterior agrupant els valors missing de les variables categ√≤riques en un nou nivell del factor que anomenem "Altres" o "Other". 

Ara b√©, √©s necess√†ri realitzar la imputaci√≥ dels NA de les variables num√®riques. En aquest sentit, plantegem, en primer lloc, la pregunta de si la pres√®ncia de valors missing a la nostra base de dades √©s, o no, aleat√≤ria. En el cas que tinguem random missing, podem pensar que es deu a un fen√≤men aleat√≤ri casual i que tots ells segueixen la mateixa distribuci√≥ amb valor esperat 0, de manera que coneixent informaci√≥ adicional no haur√≠em de tenir problemes per a realitzar la imputaci√≥. Tanmateix, la q√ºesti√≥ es torna m√©s complexe en cas que tinguem missings no aleatoris ja respondrien a algun tipus de sistem√†tica.     

\vspace{1mm}

Per a verificar la naturalesa dels nostres NA (recordem que estem parlant de variables num√®riques) fem servir el *Little's MCAR test* on:

* $H_{0}$: Missings are completely random (MCAR)
* $H_{1}$: Missings are not random

```{r, warning=F, comment = "", message=FALSE}
require(BaylorEdPsych)
require(mvnmle)
nums <- subset_colclasses(dd, "numeric")

## Test de Little
LittleMCAR(as.data.frame(nums))$p.value
```

El valor del test ens porta a rebutjar la hip√≤tesi nul.la de valors missing aleat√≤ris. Si ens parem a pensar, aquest resultat sembla raonable, ja que les √∫niques 23 observacions per a les que tenim dades mancants, en relaci√≥ a les variables num√®riques *Hotel_lat, Hotel_lng, Businesses_100m, Businesses_1km, Businesses_5km*, s√≥n conseq√º√®ncia d'una abs√®ncia de coneixement de la situaci√≥ geogr√†fica de l'hotel. Aix√≠ mateix, √©s ll√≤gic pensar que aix√≤ es deu en un error en la mesura, o la manca de dades geogr√†fiques d'una zona particular (totes deuen ser en un espai for√ßa proper).

Com que el nombre d'observacions afectades per aquests valors missing √©s molt redu√Øt (23) podem fer la imputaci√≥ igualment, controlant que els valors que obtinguem es mantinguin dins dels rangs establert i no apareguin anomalies a les dades *(Figure 19)*.

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
imputed <- filter(dd, is.na(dd$Hotel_lat))
summary(imputed)
require(class)

## indexos per a les variables que necessiten imputaci√≥

uncompleteVars<-c(5:9)

fullVariables <- c(13, 15, 18, 20, 23, 25, 26, 27, 28, 29)
aux<-dd[,fullVariables]

for (k in uncompleteVars){
  aux1 <- aux[!is.na(dd[,k]),]
  aux2 <- aux[is.na(dd[,k]),]
  dim(aux2)

  RefValues<- dd[!is.na(dd[,k]),k]
  #Find nns for aux2
  knn.values = knn(aux1,aux2,RefValues)   

  #CARE: neither aux1 nor aux2 can contain NAs


  #CARE: knn.ing is generated as a factor. 
  #Be sure to retrieve the correct values

  dd[is.na(dd[,k]),k] = as.numeric(as.character(knn.values))
  fullVariables<-c(fullVariables, k)
  aux<-dd[,fullVariables]
}

summary(dd)
```

```{r, fig.cap="Histogrames sense NA", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=5.5, fig.align="center"}
par(cex = 0.6, mfrow = c(2, 3), mar = c(3, 3, 0, 0), oma = c(1, 1, 1, 1))
for (i in 5:9) {
     hist(dd[ ,i], breaks = 100, main = NULL)
        mtext(paste("Variable", i, sep = " - "), side = 3, line = -1, adj = 0.1, cex = 0.6)}
```

Apel.lant al diccionari de dades i a l'an√†lisi univariant previ, sembla que la imputaci√≥ s'ha realitzat correctament. 

Finalment, respecte a la imputaci√≥ dels valors missing, nom√©s quedar√† tractar els valors missing a les variables textuals (a la variable de dates no en tenim). En aquest sentit, podem plantejar un proc√©s similar al de les variables qualitatives, creant un "text" que digui *"Ressenya no v√†lida"* per a aquelles observacions amb NAs.

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
dd$Negative_Review <- as.character(dd$Negative_Review)
dd$Negative_Review[is.na(Negative_Review)] <- "Ressenya no v√†lida"
dd$Negative_Review <- as.factor(dd$Negative_Review)
```

Finalment, arribats a aquest punt, guardem la base de dades un cop processada de manera adient (en endavant farem servir aquestes noves dades processades en tots els an√†lisis).

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
write.table(dd, file = paste(datapath, "Booking_data_preprocessed_def.csv", sep = "/"), sep = ",", dec = ".", row.names = FALSE, col.names = TRUE)
```

\newpage

\subsection{An√†lisi descriptiva univariant post preprocessament}

Un cop completada la fase de preprocessament, √©s interessant repetir l'an√†lisi univariant, per a les variables que anteriorment presentaven algun problema de codificaci√≥, o aquelles que han patit alguna modificaci√≥ (redefinici√≥ de categories, imputaci√≥ de valors missing etc...)

En aquest sentit, repetim el procediment d'an√†lisi gr√†fic i num√®ric univariant que hem plantejat en l'apartat d'an√†lisi explorat√≤ri inicial, concretant quines variables han patit alguna modificaci√≥ i quines romanen igual.        

\vspace{2mm}

Les dues primeres variables *id* i *Hotel_Name* segueixent sent identificadors per a cada observaci√≥ de la base de dades.       

\vspace{2mm}

La variable *Hotel_Country* no pateix cap tipus de modificaci√≥.

\vspace{2mm}

Per a la variable *Hotel_City*, hem redefinit les modalitats tal i com especifiquem en la fase de preprocessament. En aquest sentit, reconstru√Øm el gr√†fic amb les noves modalitats *(Figure 20)*.

```{r, fig.cap="Bar plot Hotel_City (Processed)", warning=F, comment = "", message=FALSE, fig.height = 4.5, fig.width=5.3}
paleta<-rainbow_hcl(length(levels(dd[,4])))
par(las = 2, oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6)  
barplot(table(dd$Hotel_City), ylim = c(0, 3000), col = paleta ,main = "Hotel_City (Processsed)", ylab = "Frequency")
legend("topright",  levels(dd[,4]), cex=0.45, fill=paleta)
```

Observem com les proporcions es mantenen, b√†sicament el que hem fet √©s agrupar les categories m√©s marginals amb la ciutat gran m√©s propera.          

\vspace{2mm}

A les variables *Hotel_lat, Hotel_lng, Businesses_100m, Businesses_1km, Businesses_5km* hem realitzat la imputaci√≥ dels valors missing (a part de la recodificaci√≥ a num√®riques de les variables "Businesses"). En aquest cas, el que volem verificar √©s que els nous valors que hem introdu√Øt no es troben fora del rang o la tend√®ncia general de les dades. Per a les dues primeres variables *Hotel_lat, i Hotel_lng* fem el resum num√®ric i ens fixem especialment en els extrems per a detectar si algun valor ha caigut fora dels l√≠mits anteriors a la imputaci√≥ o es corresponen amb localitzacions molt allunyades de les ciutats amb les que estem tractant.

```{r, warning=F, comment = "", message = FALSE}
summary(dd$Hotel_lat)
summary(dd$Hotel_lng)
```

En aquest sentit, observem com ens movem en el mateix interval de valors i, al no tenir cap ciutat en una localitzaci√≥ molt diferent a la resta, podem concloure que la imputaci√≥ ha estat exitosa al nivell de precisi√≥ geogr√†fica al que treballem. Tot seguit, constru√Øm histogrames per a les variables *Businesses_100m, Businesses_1km, Businesses_5km*, ja que ara les tenim codificades com a variables num√®riques *(Figure 21)*.


```{r, fig.cap="Histogrames Negocis a la rodona (Processed)", warning=F, comment = "", message=FALSE, fig.height = 8.4, fig.width=6.5}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mfrow = c(3, 1)) 
hist(dd$Businesses_100m, xlab = "# Negocis", breaks = 20, col = "grey",
     main = "100m")
hist(dd$Businesses_1km, xlab = "# Negocis", breaks = 20, col = "grey",
     main = "1km")
hist(dd$Businesses_5km, xlab = "# Negocis", breaks = 20, col = "grey",
     main = "5km")
```

Observem com, a mesura que augmentem el radi d'inclusi√≥, les dades tendeixen a una distribuci√≥ m√©s semblant a la normal. Respecte a la imputaci√≥ que hem realitzat, no tenim prou evid√®ncia per a considerar que els 23 valors imputats puguin afectar a les conclusions globals de l'an√†lisi.         

\vspace{2mm}

En relaci√≥ a la variable *Room_Type_Level* hem redefinit les modalitats tal i com especifiquem en la fase de preprocessament. En aquest sentit, reconstru√Øm el gr√†fic amb les noves modalitats *(Figure 22)*.

```{r, fig.cap="Barplot Room_Type_Level (Processed)", warning=F, comment = "", message=FALSE, fig.height = 4.8, fig.width=5.5}
paleta<-rainbow_hcl(length(levels(dd[,10])))
par(las = 2, oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6)  
barplot(table(dd$Room_Type_Level), ylim = c(0, 3500), col = paleta ,main = "Room_Type_Level (Processed)", ylab = "Frequency")
legend("topleft",  levels(dd[,10]), cex=0.45, fill=paleta)
```
            
\vspace{2mm}

La variable *Guest_Type* no pateix cap tipus de modificaci√≥.              

\vspace{2mm}

La variable *Trip_Type* ha patit una redefinci√≥ de les modalitats tal i com hem especificat en l'apartat anterior. Repetim el barplot considerant les dades preprocessades *(Figure 23)*.

```{r, fig.cap="Barplot perfils viatge (Processed)", warning=F, comment = "", message=FALSE, fig.height = 4.8, fig.width=5.5}
par(oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6) 
paleta<-rainbow_hcl(length(levels(dd[,11])))
barplot(table(dd$Trip_Type), col = paleta ,main = "Trip_Type (Processed)", ylab = "Frequency")
legend("topleft",  levels(dd[,12]), cex=0.5, fill=paleta)
```
           
\vspace{2mm}

La variable *Stay_Duration* no pateix cap tipus de modificaci√≥.                

\vspace{2mm}

La seg√ºent variable √©s *Review_Date*. Aquesta variable la hem recodifcat com a data i podem considerar determinar l'interval de temps corresponent a les nostres dades.

```{r, warning=F, comment = "", message = FALSE}
range(dd$Review_Date)
```

Observem com aquest interval compr√®n 2 anys.        

\vspace{2mm}

Les variables *Is_Hotel_Holiday*, *Is_Reviewer_Holiday*, *Review_Is_Positive* i *Submitted_from_Mobile* les hem recodificat com a factors per√≤ els gr√†fics constru√Øts anteriorment s√≥n perfectament extrapolables, ja que simplement canviem 1 per S√≠ i 0 per No.     

\vspace{2mm}

Les variables *Total_Number_of_Reviews* i *Review_Positivity_Rate* romanen igual.     

\vspace{2mm}  

La seg√ºent variable √©s *Reviewer_Nationality* que, recordem, tenia 123 modalitats. Treballar amb aquest nombre tan alt de nivells pot resultar dif√≠cil per a etapes posteriors de l'an√†lisi aix√≠ que, tal i com hem descrit a la fase de preprocessament, redefinim les modalits. En conseq√º√®ncia, la variable queda finalment definida del seg√ºent mode *(Figure 24)*.

```{r, fig.cap="Bar plot Reviewer_Nationality (Processed)", warning=F, comment = "", message=FALSE, fig.height = 6.2, fig.width=7}
paleta<-rainbow_hcl(length(levels(dd[,21])))
par(las = 2, oma = c(2, 1, 0, 0), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6)  
barplot(table(dd$Reviewer_Nationality), ylim = c(0, 3000), col = paleta ,main = "Reviewer_Nationality (Processed)", ylab = "Frequency")
legend("topleft",  levels(dd[,21]), cex=0.45, fill=paleta)
```

La resta de variables *Negative_Review, Review_Total_Negative_Word_Counts, Positive_Review, Review_Total_Positive_Word_Counts, Average_Score, Reviewer_Score, Total_Number_of_Reviews_Reviewer_Has_Given, Additional_Number_of_Scoring* no han patit cap tipus de modificaci√≥.

\newpage

\section{Cl√∫ster jer√†rquic}

En l'√†mbit de la ci√®ncia de dades, es sol treballar amb bases de dades molt grans que tenen un nombre d'observacions molt elevat. Sovint, aquestes observacions s√≥n semblants entre s√≠, de manera que √©s possible organitzar aquesta gran quantitat de dades en un nombre redu√Øt de *grups* o *cl√∫sters*, els quals es componen d'observacions similars. Les diferents t√®cniques de clustering es fan servir per agrupar dades/observacions en diferents segments de manera que les dades dins de cadascun d'aquests segments s√≥n similars, per√≤ significativament diferents entre segments. Determinar qu√® vol dir "similars" o "diferents" √©s la part essencial del *cluster analysis* i est√† estretament relacionat amb la estad√≠stica. 

Existeixen diferents tipus de m√®todes o t√®cniques de cl√∫stering (particions, jer√†rquics etc...) que es basen en diferents metodologies i es serveixen de coneixements te√≤rics provinents de diferents camps d'estudi. En l√≠nia amb els objectius perseguits en aquest projecte, el cl√∫stering que es duu a terme en aquest cap√≠tol √©s un *cl√∫stering jer√†rquic*.

S'empra el m√®tode de Ward, que consisteix en fer servir la p√®rdua d'informaci√≥ que es produeix al integrar els diferents individus en els cl√∫sters. Aquesta p√®rdua es pot mesurar a trav√©s de la suma total dels quadrats de les desviacions de cada individu respecte la mitjana del cl√∫ster, de manera que s'aniran agrupant aquells individus que menys incrementin aquesta magnitud al juntar-se.

A m√©s, es pret√©n que totes les variables intervinguin en el proc√©s de creaci√≥ dels conglomerats. En aquest sentit, proposem fer servir la dist√†ncia de Gower, per a conjunts de dades mixtes. √âs a dir, farem servir aquesta dist√†ncia quan tinguem un conjunt de registres/individus sobre els quals haguem observat tant variables quantitatives com qualitatives, com √©s el cas.

Es defineix la dist√†ncia de Gower com $d_{ij}^{2} = 1 -s_{ij}$, on:

\begin{eqnarray*}
s_{ij} = \frac{\sum_{h = 1}^{p_{1}} (1-|x_{ih}-x_{jh}| / G_{h})+a+\alpha}{p_{1}+(p_{2}-d)+p_{3}} \quad
\textit{√©s el coeficient de similitud de Gower}
\end{eqnarray*}

* $p_{1}$ √©s el nombre de variables quantitatives cont√≠nues,
* $p_{2}$ √©s el nombre de variables bin√†ries,
* $p_{3}$ √©s el nombre de variables qualitatives (no bin√†ries),
* $a$ √©s el nombre de coincid√®ncies (1, 1) en les variables bin√†ries,
* $d$ √©s el nombre de coincid√®ncies (0, 0) en les variables bin√†ries,
* $\alpha$ √©s el nombre de coincid√®ncies de les variables qualitatives (no bin√†ries) i
* $G_{h}$ √©s el rang (o recorregut) de la h-√®ssima variable quantitativa.

Tanmateix, hem considerat excloure del proc√©s de cl√∫stering la variable identificadora del registre i les dues variables textuals amb les ressenyes dels clients, ja que la realitzaci√≥ d'aquestes variables √©s √∫nica per a cada observaci√≥ i rebran un tractament diferent. Addicionalment hem considerat oport√∫ no incloure la variable *Hotel_Name*, ja que tamb√© √©s una caracter√≠stica √∫nica per a cada establiment i no t√© massa sentit pensar en agrupacions en funci√≥ d'aquesta variable.

Calculem la matriu de discrep√†ncies fent servir la dist√†ncia de gower i, amb el m√®tode de Ward realitzem el proc√©s de cl√∫stering. Podem representar el resultat amb un dendograma *(Figure 25)*.

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
require(cluster)
rm(list = ls())
datapath <- "~/ESTADISTICA/3er/2n semestre/An√†lisi Multivariant/Course project/Dades"
file <- "Booking_data_preprocessed_def.csv"
dd <- read.csv(paste(datapath, file, sep = "/"), sep = ",", dec = ".", header = T)
attach(dd)

actives<- seq(1, 30)
actives <- actives[-c(1, 2, 22, 24)]
dissimMatrix <- daisy(dd[,actives], metric = "gower", stand=TRUE)

distMatrix<-dissimMatrix^2
h1 <- hclust(distMatrix,method="ward.D") 
```

```{r, fig.cap="Dendograma-m√®tode de Ward amb dist√†ncies de gower", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=5.5, fig.align="center"}
plot(h1, xlab = "observaci√≥", ylab = "Dist√†ncies", main = "Dendrograma-WARD", sub = "")
nc = 5
c5 <- cutree(h1,nc)
rect.hclust(h1, k = 5, border="red")

# library(factoextra)
# fviz_dend(h1, k = 5, # Cut in four groups
#           cex = 0.5, # label size
#           k_colors = c("#2E9FDF", "#00AFBB", "#E7B800", "#FC4E07"),
#           color_labels_by_k = TRUE, # color labels by groups
#           rect = TRUE, # Add rectangle around groups
#           rect_border = c("#2E9FDF", "#00AFBB", "#E7B800", "#FC4E07"), 
#           rect_fill = TRUE)
```

En aquest cas, hem considerat oport√∫ realitzar una partici√≥ en 5 cl√∫sters un cop observat el dendograma. No existeix un procediment formal √∫nic establert per a decidir el nombre de particions, √©s m√©s com√∫ fer servir t√®cniques heur√≠stiques com per exemple tallar per aquell salt on guanyem menys in√®rcia entre grups de manera que l'esfor√ß d'una partici√≥ adicional no compensi la variabilitat que aconseguim explicar amb aquest tall extra. En aquest treball, proposem un m√®tode heur√≠stic alternatiu anomenat Elbow Method *(Figure 26)* que es basa en el mateix principi de la suma de quadrats intra cl√∫sters. Ens interessar√† tenir una suma de quadrats intra cl√∫sters petita ja que aix√≤ voldr√† dir que els individus dins d'un mateix conglomerat seran molt similars, per√≤ a la vegada realitzar particions nom√©s fins al punt que el benefici marginal d'un grup m√©s en superi el cost.

```{r, fig.cap="Elbow Method", warning=F, comment = "", message=FALSE, fig.height=2.5, fig.width=3.5, fig.align="center"}
subset_colclasses <- function(DF, colclasses="numeric") {
  DF[,sapply(DF, function(vec, test) class(vec) %in% test, test=colclasses)]
}
k.max <- 15
dcon <- subset_colclasses(dd, "numeric")
dcon2 <- subset_colclasses(dd, "integer")
dcon <-cbind(dcon, dcon2)
rm(dcon2)
wss <- sapply(1:k.max, 
              function(k){kmeans(dcon, k, nstart=50,iter.max = 15 )$tot.withinss})
par(cex = 0.6)
plot(1:k.max, wss,
     type="b", pch = 19, frame = FALSE, 
     xlab="Number of clusters K",
     ylab="Total within-clusters sum of squares", 
     main = "Elbow method - Total within-clusters sum of squares")
```

El Elbow method fa servir nom√©s variables num√®riques ja que calcula sumes de quadrats. Podr√≠a passar que el resultat no es correspongu√©s amb el nostre dendograma, on hem fet servir totes les variables. Tanmateix, veiem com una partici√≥ en 5 cl√∫sters sembla for√ßa raonable en tots dos casos i el m√®tode de Elbow pot servir per a refor√ßar la nostra creen√ßa pr√®via. Ara b√©, caldr√† analitzar la qualitat de la nostra partici√≥ i comparar-la amb d'altres. Per exemple, si prenem una hipot√®tica partici√≥ de 4 i una altra de 6 tenim que:

```{r, warning=F, comment = "", message=FALSE}
c6 <- cutree(h1,6)
c4 <- cutree(h1,4)

#class sizes 
table(c5)

#comparing with other partitions (la millor √©s 5)
table(c5, c6)
table(c5,c4)
```

Observant la distribuci√≥ dels cl√∫sters, veiem que els grups 1, 3 i 4 s√≥n semblants en mida i m√©s abundants que els grups 2 i 5. A priori, sembla raonable seleccionar aquesta partici√≥. Ara b√©, podem comparar el percentatge de variabilitat entre grups explicada respecte el total per a les particions immediatament anterior i posterior (k = 4 i k = 6). Fent-ho obtenim:

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
set.seed(12736)
k4 <- kmeans(dcon,4)
k5 <- kmeans(dcon,5)
k6 <- kmeans(dcon,6)
Wss4 <-  sum(k4$withinss)
Wss5 <-  sum(k5$withinss)
Wss6 <-  sum(k6$withinss)

## Prenem la partici√≥ de k = 5 (c2)
cdg4 <- aggregate(as.data.frame(dcon),list(c4),mean)
cdg5 <- aggregate(as.data.frame(dcon),list(c5),mean)
cdg6 <- aggregate(as.data.frame(dcon),list(c6),mean)
Bss4 <- sum(rowSums(cdg4^2)*as.numeric(table(c4)))
Bss5 <- sum(rowSums(cdg5^2)*as.numeric(table(c5)))
Bss6 <- sum(rowSums(cdg6^2)*as.numeric(table(c6)))

Ib4 <- 100*Bss4/(Bss4+Wss4)
Ib5 <- 100*Bss5/(Bss5+Wss5)
Ib6 <- 100*Bss6/(Bss6+Wss6)
print(c(Ib4, Ib5, Ib6))
```

* **98,17080** amb 4 conglomerats.
* **98,80219** amb 5 conglomerats.
* **99,12840** amb 6 conglomerats.

Observem com el guany obtingut en passar de 5 conglomerats a 6 √©s m√≠nim, aix√≠ doncs, ens quedem amb la opci√≥ escollida anteriorment de 5 cl√∫sters.

\newpage

\section{Profiling dels cl√∫sters}

Un cop realitzat el proc√©s de clustering, conv√© pensar en tenir una comprensi√≥ m√©s √†mplia de com s√≥n les unitats d'estudi dins de cada conglomerat. Per a aquest prop√≤sit fem servir les variables de la nostra base de dades que han participat en el clustering per a elaborar panells de classes i estad√≠stiques descriptives per grups $\footnote{Deixarem fora l'identificador, les dues variables textuals i Hotel_Name.}$. En √∫ltima inst√†ncia, l'objectiu √©s crear un "perfil" per a cada cl√∫ster que representi els atributs d'aquest en relaci√≥ a les variables mencionades.        

Les eines descriptives que hem fet servir per a la caracteritzaci√≥ dels cl√∫sters s√≥n:
     
* Snake plots, diagrames de barres o taules de conting√®ncia per a les variables qualitatives.
* Boxplots i diagrames de barres per a les variables num√®riques.

A m√©s, per cada variable analitzada, fem servir un seguit de contrastos, tant param√®trics com no param√®trics, per a testar la hip√≤tesis de difer√®ncies significatives entre cl√∫sters.

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
ValorTestXnum <- function(Xnum,P){
        #freq dis of fac
        nk <- as.vector(table(P)); 
        n <- sum(nk); 
        #mitjanes x grups
        xk <- tapply(Xnum,P,mean);
        #valors test
        txk <- (xk-mean(Xnum))/(sd(Xnum)*sqrt((n-nk)/(n*nk))); 
        #p-values
        pxk <- pt(txk,n-1,lower.tail=F);
        for(c in 1:length(levels(as.factor(P)))){if (pxk[c]>0.5){pxk[c]<-1-pxk[c]}}
        return (pxk)
}

ValorTestXquali <- function(P,Xquali){
        taula <- table(P,Xquali);
        n <- sum(taula); 
        pk <- apply(taula,1,sum)/n;
        pj <- apply(taula,2,sum)/n;
        pf <- taula/(n*pk);
        pjm <- matrix(data=pj,nrow=dim(pf)[1],ncol=dim(pf)[2]);      
        dpf <- pf - pjm; 
        dvt <- sqrt(((1-pk)/(n*pk))%*%t(pj*(1-pj))); 
        zkj <- dpf/dvt; 
        pzkj <- pnorm(zkj,lower.tail=F);
        for(c in 1:length(levels(as.factor(P)))){for (s in 1:length(levels(Xquali))){if (pzkj[c,s]> 0.5){pzkj[c,s]<-1- pzkj[c,s]}}}
        return (list(rowpf=pf,vtest=zkj,pval=pzkj))
}

K<-dim(dd)[2]
par(ask=TRUE)

P<-c5
nc<-length(levels(as.factor(P)))
pvalk <- matrix(data=0,nrow=nc,ncol=K, dimnames=list(levels(P),names(dd)))
nameP<-"Cluster"
n<-dim(dd)[1]
```

Les primeres variables de la base de dades *Hotel_Country, Hotel_City, Hotel_lat, Hotel_lng* fan refer√®ncia a l'√†mbit geogr√†fic i √©s ll√≤gic pensar que la caracteritzaci√≥ dels cl√∫sters anir√† en la mateixa l√≠nia en tots quatre casos.

```{r, fig.cap="Profiling variable Hotel_Country", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
require(colorspace)
k <- 3
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.5,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1))
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 3)
title("Hotel_Country per cluster (%)", xlab = "cluster", line = 1,  ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=T,col=paleta, ylim = c(0, 1500))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Hotel_Country per cluster (nre. d'hotels)", ylab = "# hotels", xlab = "cluster", line = 1)
```

Si construim el snake plot i el diagrama de barres de la variable *Hotel_Country* estratificant per cl√∫ster *(Figure 27)*, observem com el cl√∫ster 1 √©s el m√©s divers pel que fa al pa√≠s on es troba l'hotel en q√ºesti√≥. En aquest conglomerat hi trobem hotels d'√Äustria, It√†lia i Pa√Øsos Baixos en proporcions for√ßa semblants. Ara b√©, la resta de cl√∫sters t√© una forta caracteritzaci√≥ pel que fa al pa√≠s de l'hotel:

* *Cl√∫ster 2*: Predominen hotels d'Espanya.
* *Cl√∫ster 3*: Predominen hotels del Regne Unit.
* *Cl√∫ster 4*: Predominen hotels del Regne Unit amb lleugera pres√®ncia d'hotels d'altre pa√Øsos.
* *Cl√∫ster 5*: Predominen hotels de Fran√ßa.

D'altra banda si en comptes de considerar la variable *Hotel_Country* fem exactament el mateix per a la ciutat de l'hotel *(Figure 28)* observem com existeix una correspond√®ncia en la relaci√≥ entre pa√Øsos i ciutats:

* Al cl√∫ster 1 hi trobem hotels de √Åmsterdam, Vienna i Mil√†.
* Al cl√∫ster 2 hi trobem hotels de Barcelona.
* Als cl√∫sters 3 i 4 trobem majorit√†riament hotels de Londres. 
* Al cl√∫ster 5 predominen els hotels situats a Par√≠s.

```{r, fig.cap="Profiling variable Hotel_City", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
require(colorspace)
k <- 4
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.5,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1))
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 3)
title("Hotel_City per cluster (%)", xlab = "cluster", line = 1,  ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=T,col=paleta, ylim = c(0, 1800))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Hotel_City per cluster (nre. d'hotels)", ylab = "# hotels", xlab = "cluster", line = 1)
```

Per √∫ltim, podem realitzar un test $\chi^{2}$ per a validar estad√≠sticament que les difer√®ncies entre aquestes variables s√≥n significatives entre cl√∫sters:

```{r, warning=F, comment = "", message=FALSE}
k  <- 3
print("Test Chi quadrat Hotel_Country:")
print(chisq.test(dd[,k], as.factor(P)))

k  <- 4
print("Test Chi quadrat Hotel_City:")
print(chisq.test(dd[,k], as.factor(P)))
```

Tots dos contrastos s√≥n significatius.

Per a facilitar la comprensi√≥ dels resultats descrits anteriorment, podem pensar en fer servir les variables latitud i longitud per a realitzar una geolocalitzaci√≥ de les dades i visualitzar els cl√∫sters en un mapa. Als seg√ºents gr√†fics representem al mapa la localitzaci√≥ dels hotels, estratificant per cl√∫sters, els quals distingim amb colors, i on la mida dels cercles fa refer√®ncia al nombre total de ressenyes que tenen els hotels *(Figure 29)*.

$\vspace{1mm}$

```{r, fig.cap="Geolocalitzaci√≥", warning=F, comment = "", message=FALSE, fig.height = 4, fig.width=6}
require(ggmap)
map <- get_map("France", zoom = 5, language = "Spanish")
cluster <- c5
variablePoints <- ggmap(map) + geom_point(aes(x = dd$Hotel_lng, y = dd$Hotel_lat, color = cluster, size = Total_Number_of_Reviews), data = dd, alpha = .5) + geom_text(aes(label = lat), size = 0.6) + theme(axis.title = element_text(size=10))
updatedMap <- variablePoints + scale_size_area(name = "Total number of reviews")
updatedMap
```


Si seguim amb la resta de variables de la base de dades, les seg√ºents tres fan refer√®ncia al nombre de negocis a la rodona considerant diferents dist√†ncies. L'objectiu cercat amb aquestes variables √©s fer una distinci√≥ entre hotels urbans i hotels m√©s allunyats del centre de les ciutats. Com que les variables *Business_100m, Business_1km i Business_5Km* tenen connotacions semblants, hem considerat representar-les juntes mitjan√ßant un plotMeans *(Figure 30)*.

```{r, fig.cap="Profiling Nre. Negocis a 100m, 1km i 5km a la rodona", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7.5}
require("Rcmdr")
par(mfrow = c(1, 3), cex.main = 0.8, cex.axis = 0.7, cex.lab = 0.6, mgp=c(3,2,0))
plotMeans(dd$Businesses_100m, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "Plot Means of Businesses_100m", ylab = "mitjana Businesses_100m",
        xlab = "cluster")
plotMeans(dd$Businesses_1km, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "Plot Means of Businesses_1km", ylab = "mitjana Businesses_1km",
        xlab = "cluster")
plotMeans(dd$Businesses_5km, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "Plot Means of Businesses_5km", ylab = "mitjana Businesses_5km",
        xlab = "cluster")
```

Observem com els hotels que trobem als cl√∫sters 2 i 5 tendeixen a ser m√©s urbans, en especial els del cl√∫ster 5 ja que destaquen en tots els llindars. Els hotels inclosos al cl√∫ster 2 destaquen, encara que en menor mesura que els del 5, quan la dist√†ncia √©s inferior a 1 km a la rodona (pot ser degut a que Barcelona √©s menys extensa que les altres ciutats). En contrapartida, els hotels del cl√∫ster 1 semblen ser els menys urbans ja que ocupen posicions baixes en tots tres llindars, i es troben for√ßa allunyats de la mitjana. Les dues primeres variables comparteixen moltes caracter√≠stiques i √©s l'ultima *(Businesses_5km)* on m√©s evidents es fan les difer√®ncies.

Proposem la realitzaci√≥ d'una ANOVA i un test de Kruskall-Wallis per a testar si existeixen difer√®ncies globals entre clusters. A part, calculem la significaci√≥ de cada cl√∫ster amb la funci√≥ *ValorTestXnum*. En aquest sentit, p-valors molt extrems per a un cl√∫ster voldr√† dir que aquest est√† molt allunyat de la mitjana.

```{r, warning=F, comment = "", message=FALSE}
k <- 7
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Businesses_100m:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Businesses_100m:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print(c("p-values ValorsTest Businesses_100m:", pvalk[,k]))

k <- 8
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Businesses_1km:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Businesses_1km:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print(c("p-values ValorsTest Businesses_1km:", pvalk[,k]))

k <- 9
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Businesses_5km:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Businesses_5km:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print(c("p-values ValorsTest Businesses_5km:", pvalk[,k]))
```

Si ens fixem en els p-valors tots tres contrastos s√≥n significatius. Tanmateix, cal mencionar que la significaci√≥ va augmentant a mesura que augmentem el llindar de km a la rodona. √âs a dir, com m√©s √†mplia √©s la zona que considerem, m√©s evidents es fan les difer√®ncies entre els grups. Per aquest motiu, a l'hora d'elaborar els perfils, donem m√©s pes als resultats obtinguts per a la variable *Businesses_5km*, ja que ens permet detectar millor les difer√®ncies entre hotels m√©s o menys allunyats del centre de les ciutats.       

\vspace{1mm}

A continuaci√≥ ens fixem en el tipus d'habitaci√≥. Constru√Øm un snake plot i un diagrama de barres per a comparar les modalitats dins de cada cl√∫ster *(Figure 31)*

```{r, fig.cap="Profiling variable Room_Type_Level", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
require(colorspace)
k <- 10
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.5,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1))
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 2)
title("Room_Type_Level per cluster (%)", xlab = "cluster", line = 1, ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=T,col=paleta, ylim = c(0, 1500))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Room_Type_Level per cluster (nre. d'hotels)", ylab = "# habitacions per categoria", xlab = "cluster", line = 1)
```

Aquest gr√†fic presenta la limitaci√≥ que tenim molts valors missing que hem incl√≤s en la categoria "Others. Aquesta categoria √©s la m√©s freq√ºent en tots els cl√∫sters, en especial al cl√∫ster 2 (m√©s del 80%). La resta de modalitats s√≥n for√ßa homog√®nies per a tots els cl√∫sters amb la salvetat que al cl√∫ster 5 hi ha major pres√®ncia d'habitacions del tipus cl√†ssic i en el cl√∫ster 3 les del tipus Standard i Deluxe. El test $\chi^{2}$ √©s significatiu per√≤ hem de tenir en compte que els valors centrats poden estar altament influits per la modalitat "Other".

```{r, warning=F, comment = "", message=FALSE}
print("Test Chi quadrat Room_Type_Level:")
print(chisq.test(dd[,k], as.factor(P)))
```

La seg√ºent variable √©s *Guest_Type*. Aquesta fa refer√®ncia al perfil del client que ha escrit la ressenya. Si analitzem com es distribueixen les modalitats d'aquesta variable entre els 5 cl√∫sters *(Figure 32)*, observem com als cl√∫sters 1, 3 i 4 les parelles s√≥n m√©s abundants que a la resta. El cl√∫ster 3 tamb√© cont√© m√©s viatgers solitaris que la resta, mentre que al cl√∫ster 2 augmenten lleugerament els grups. La resta de categories es mant√© for√ßa constant per a tots els conglomerats.

```{r,  fig.cap="Profiling variable Guest_Type", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=8.5}
require(colorspace)
k <- 11
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.5,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1))
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 1)
title("Guest_Type per cluster (%)", xlab = "cluster", line = 1, ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=T,col=paleta, ylim = c(0, 1500))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Guest_Type per cluster (nre. d'hotels)", ylab = "# clients per categoria", xlab = "cluster", line = 1)
```

Si construim el test, veiem com existeixen difer√®ncies significatives entre els cl√∫sters, tot i que la significaci√≥ global √©s menys forta que en els casos anteriors.

```{r, warning=F, comment = "", message=FALSE}
print("Test Chi quadrat Guest_Type:")
print(chisq.test(dd[,k], as.factor(P)))
```

A continuaci√≥, passem a la variable *Trip_Type* que reflecteix el motiu del viatge *(Figure 33)*. En aquest cas, observem com, en tots els conglomerats predominen els viatges amb motiu d'oci. Tanmateix, trobem difer√®ncies subtils al cl√∫ster 3 on aquesta domin√†n√ßa dels viatges per plaer disminueix en benefici dels viatges per motiu de negoci.

```{r, fig.cap="Profiling variable Trip_Type", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=8.5}
require(colorspace)
k <- 12
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.5,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1))
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 2)
title("Trip_Type per cluster (%)", xlab = "cluster", line = 1, ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=T,col=paleta, ylim = c(0, 1500))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Trip_Type per cluster (nre. d'hotels)", ylab = "# viatges per categoria", xlab = "cluster", line = 1)
```

Tot i aix√≤, podem concloure que la distribuci√≥ de la variable √©s m√©s aviat homog√®nia per a tots els cl√∫sters. Si construim el test, veiem com existeixen difer√®ncies significatives entre els conglomerats, per√≤ el p-valor no √©s tan petit com el trobat per a altres variables (menys evid√®ncia de difer√®ncies entre cl√∫sters).

```{r, warning=F, comment = "", message=FALSE}
print("Test Chi quadrat Trip_Type:")
print(chisq.test(dd[,k], as.factor(P)))
```

La seg√ºent variable √©s *Stay_Duration*. Al tenir davant una variable num√®rica, construim un boxplot i un gr√†fic de barres *(Figure 34)*. Observem com els cl√∫sters 1, 2 i 5 inclouen llargues estades, mentre que els cl√∫sters 3 i 4 (recordem, majoria de parelles o viatgers en solitari) tendeixen a incloure estades m√©s curtes. 

```{r, fig.cap="Profiling variable Stay_Duration", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
k <- 13
boxplot(dd[,k]~P, horizontal=TRUE)
title(main=paste("Boxplot of", names(dd)[k], "vs", nameP ), ylab = "cluster", xlab = "Dies d'estada", line = 1)

barplot(tapply(dd[[k]], P, mean))
title(main=paste("Means of", names(dd)[k], "by", nameP ), xlab = "cluster", ylab = "Durada est√†ncia mitjana", line = 1) 
abline(h=mean(dd[[k]]))
legend(0,mean(dd[[k]]),"global mean",bty="n")
```

El test revela difer√®ncies significatives entre els conglomerats, tant a nivell global com per a cada cl√∫ster.

```{r, warning=F, comment = "", message=FALSE}
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Stay_Duration:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Stay_Duration:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print("p-values ValorsTest Stay_Duration:")
print(pvalk[,k])
```

La seg√ºent variable √©s *Days_Since Review*. En aquest cas, fem un resum num√®ric per a cada segment (cl√∫sters del 1 al 5). Observem que la mitjana del cl√∫ster 5 √©s considerablement superior a la resta. Els altres conglomerats semblen situar-se for√ßa a prop de la mitjana global, tot i que els cl√∫sters 1 i 4 semblen tenir valors lleugerament superiors al segon i el tercer. 

```{r, warning=F, comment = "", message=FALSE}
dd$cluster <- NULL
k <- 15
for(s in levels(as.factor(P))) {print(summary(dd[P==s,k]))}
```

Si realitzem el test no podem parlar de significaci√≥ global forta. Tanmteix, evidencia com el cl√∫ster 5 presenta una forta desviaci√≥ significativa respecte la tend√®ncia general de tots els conglomerats. Per tant, la conclusi√≥ a la que arribem √©s que les ressenyes incloses en el cl√∫ster 5 s'han publicat amb m√©s retard respecte la norma general.

```{r, warning=F, comment = "", message=FALSE}
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Days_Since Review:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Days_Since Review:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print("p-values ValorsTest Days_Since Review:")
print(pvalk[,k])
```

A continuaci√≥ ens fixem conjuntament en les variables *Is_Hotel_Holiday i Is_Reviewer_Holiday*, dicot√≤miques les dues. Per a caracteritzar els cl√∫sters, construim dos diagrames de barres apilades de manera que poguem comparar entre els conglomerats si la ciutat de l'hotel, o la de l'usuari es troba en dia festiu *(Figure 35)*. L'objectiu √©s veure si en algun cl√∫ster els clients tendeixen a escriure les ressenyes en dies festius.

```{r, fig.cap="Profiling variables dia Festiu", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
k <- 16
barplot(table(dd[,k], as.factor(P)), beside=F,col=paleta, ylim = c(0, 1800))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.7, col=paleta, ncol = 2)
title("Is_Hotel_Holiday per cluster (nre. d'hotels)", ylab = "# ressenyes", xlab = "cluster", line = 1)

k <- 17
barplot(table(dd[,k], as.factor(P)), beside=F,col=paleta, ylim = c(0, 1800))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.7, col=paleta, ncol = 2)
title("Is_Reviewer_Holiday per cluster (nre. d'hotels)", ylab = "# ressenyes", xlab = "cluster", line = 1)
```

Veiem com, al cl√∫ster 4 √©s on la pres√®ncia de dies festius en el moment d'escriure la ressenya √©s m√©s alt. A la resta de cl√∫sters la proporci√≥ de **S√≠** √©s molt baixa per a les dues variables. Si ens fixem en els p-valors dels contrastos, observem com els dos testos surten significatius.

```{r, warning=F, comment = "", message=FALSE}
k  <- 16
print("Test Chi quadrat Is_Hotel_Holiday:")
print(chisq.test(dd[,k], as.factor(P)))

k  <- 17
print("Test Chi quadrat Is_Reviewer_Holiday:")
print(chisq.test(dd[,k], as.factor(P)))
```

A continuaci√≥, ens fixem en la variable *Total_Number_of_Reviews*. Aquesta variable, recordem, representa el nombre total de ressenyes v√†lides que t√© l'hotel en q√ºesti√≥. Un estudi interessant seria observar si existeix algun cl√∫ster on els hotels tinguin major nombre de ressenyes, i veure com aix√≤ repercuteix en la valoraci√≥ de l'hotel.     

```{r, fig.cap="Profiling variable Total_Number_of_Reviews", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
k <- 18
boxplot(dd[,k]~P, horizontal=TRUE)
title(main=paste("Boxplot of", names(dd)[k], "vs", nameP ), ylab = "cluster", xlab = "Nombre de ressenyes v√†lides", line = 1)

barplot(tapply(dd[[k]], P, mean))
title(main=paste("Means of", names(dd)[k], "by", nameP ), ylab = "Nombre mig de ressenyes v√†lides", xlab = "cluster", line = 1)
abline(h=mean(dd[[k]]))
legend(0,mean(dd[[k]]),"global mean",bty="n")
```
       
Al gr√†fic *(Figure 36)* veiem com, en nombre de ressenyes v√†lides destaquen els cl√∫sters 1, 3 i 4. Els cl√∫sters 2 i 5 es troben considerablement per sota la mitjana global, en especial el cl√∫ster 5 amb un valor mig de ressenyes v√†lides al voltant de 1000. Tal i com evidencia la figura anterior, el test revela difer√®ncies significatives entre els conglomerats.

```{r, warning=F, comment = "", message=FALSE}
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Total_Number_of_Reviews:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Total_Number_of_Reviews:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print("p-values ValorsTest Total_Number_of_Reviews:")
print(pvalk[,k])
```

Les seg√ºents dues variables, estan relacionades amb el grau de positivitat de la ressenya de Booking. *Review_Is_Positive* √©s una variable bin√†ria que pren valor 1 (S√≠) si el nombre de paraules a la ressenya positiva √©s major que a la negativa. La proporci√≥ de ressenyes positives per cluster, juntament amb un gr√†fic de barres o un PlotMeans de la variable *Review_Positivity_Rate* *(Figure 37)*, ens pot donar un indici de en quin dels cl√∫sters els comentaris s√≥n m√©s positius. Aquest coneixement combinat amb an√†lisis posteriors ens revelar√† quin tipus d'hotel √©s el m√©s preferit pels clients, tamb√© en funci√≥ de les seves caracter√≠stiques.

```{r, fig.cap="Profiling variables grau de positivisme de la ressenya", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
k <- 19
barplot(table(dd[,k], as.factor(P)), beside=F,col=paleta, ylim = c(0, 1800))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.7, col=paleta, ncol = 2)
title("Review_Is_Positive (nre. d'hotels)", ylab = "# hotels", xlab = "cluster", line = 1)

k <- 20
barplot(tapply(dd[[k]], P, mean))
title(main=paste("Means of", names(dd)[k], "by", nameP ), xlab = "cluster", ylab = "Positivity Rate", line = 1)
abline(h=mean(dd[[k]]))
legend(0,mean(dd[[k]]),"global mean",bty="n")
```

Observant el gr√†fic, podem concloure que:     

* El cl√∫ster 4 t√© gaireb√© totes les ressenyes i comentaris positius.
* Els cl√∫sters 1, 2 i 5 tenen un percentatge de ressenyes positives superior al 50% i superior a la mitjana global en tots tres casos.
* El cl√∫ster 3 t√© gaireb√© totes les ressenyes i comentaris negatius.

Tal i com sembla indicar la figura, els contrastos evidencien una forta validesa estad√≠stica de les conclusions a les que hem arribat.

```{r, warning=F, comment = "", message=FALSE}
k <- 19
print("Test Chi quadrat Review_Is_Positive:")
print(chisq.test(dd[,k], as.factor(P)))

k <- 20
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Review_Positivity_Rate:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Review_Positivity_Rate:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print("p-values ValorsTest Review_Positivity_Rate:")
print(pvalk[,k])
```


La seg√ºent variable √©s *Reviewer Nationality*. Tal i com hem fet anteriorment, construim un snake plot i un gr√†fic de barres (variable categ√≤rica) *(Figure 38)*. Es pot apreciar com la nacionalitat que predomina est√† altament correlacionada amb el pa√≠s de l'hotel, un clar exemple en s√≥n els cl√∫sters 3 i 4 on predominen els hotels situats a Gran Bretanya i les ressenyes escrites per brit√†nics. Aix√≤ pot indicar que el turisme intern √©s molt m√©s usual a Booking o, al menys, que √©s m√©s com√∫ escriure ressenyes per a hotels del teu pa√≠s. 

```{r, fig.cap="Profiling variable Reviewer_Nationality", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=8}
require(colorspace)
k <- 21
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1))
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 3)
title("Reviewer_Nationality per cluster (%)", xlab = "cluster", line = 1, ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=T,col=paleta, ylim = c(0, 1800))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Reviewer_Nationality per cluster (nre. d'hotels)", ylab = "# usuaris", xlab = "cluster", line = 1)
```

De nou, el test mostra una alta significaci√≥ estad√≠stica. 

```{r, warning=F, comment = "", message=FALSE}
print("Test Chi quadrat Reviewer_Nationality:")
print(chisq.test(dd[,k], as.factor(P)))
```

Les seg√ºents variables, si excloem les textuals, s√≥n *Review_Total_Negative_Word_Counts i Review_Total_Positive_Word_Counts*. Entenem que aquestes variables han de anar en l√≠nia amb el resultat anterior on hem valorat el grau de positivisme del comentari. Comparem totes dues juntes mitjan√ßant un plotMeans i veiem com el resultat, ll√≤gicament, √©s complementari. Aquells cl√∫sters amb valors als per a *Review_Total_Negative_Word_Counts* tindr√†n valors baixos per a *Review_Total_Positive_Word_Counts* i viceversa.        
$\vspace{1mm}$

```{r, fig.cap="Plot Means Nre.paraules comentari Negatiu/Postiu", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
require("Rcmdr")
par(mfrow = c(1, 2), cex.main = 0.8, cex.axis = 0.7, cex.lab = 0.6, mgp=c(3,2,0))
plotMeans(dd$Review_Total_Negative_Word_Counts, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "PlotMeans Total_Negative_Word_Counts", ylab = "mitjana Review_Total_Negative_Word_Counts",
        xlab = "cluster")
plotMeans(dd$Review_Total_Positive_Word_Counts, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "Plot Means Total_Positive_Word_Counts", ylab = "mitjana Review_Total_Positive_Word_Counts",
        xlab = "cluster")
```
Les conslusions que obtenim del gr√†fic s√≥n:        

* El cl√∫ster 3 √©s el que cont√© els hotels on els comentaris s√≥n m√©s negatius.
* Els hotels dels cl√∫sters 1, 2 i 5 es mantenen prop de la mitjana global encara que les valoracions per a aquest √∫ltim tendeixen a ser m√©s negatives.
* El cl√∫ster 4 √©s el que cont√© els hotels on els comentaris s√≥n m√©s positius.

El contrast, refor√ßa la informaci√≥ proporcionada pel gr√†fic, mostrant una forta validesa estad√≠stica en relaci√≥ al test de difer√®ncies entre cl√∫sters.

```{r, warning=F, comment = "", message=FALSE}
k <- 23
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Review_Total_Negative_Word_Counts:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Review_Total_Negative_Word_Counts:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print("p-values ValorsTest Review_Total_Negative_Word_Counts:")
print(pvalk[,k])

k <- 25
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Review_Total_Positive_Word_Counts:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Review_Total_Positive_Word_Counts:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print("p-values ValorsTest Review_Total_Positive_Word_Counts:")
print(pvalk[,k])
```


Tot seguit entrem a analitzar variables relacionades amb les puntuacions dels hotels. Prenem conjuntament la puntuaci√≥ mitjana que presentava l'hotel a finals de 2016 i la que han anat otorgant els usuaris de Booking que han escrit les ressenyes. Te√≤ricament aquells hotels on les valoracions s√≥n m√©s positves haurien de rebre millors valoracions aix√≠ que, sembla ll√≤gic pensar que els resultats haur√≠en d'anar en l√≠nia amb els anteriors.

$\vspace{1mm}$
        
```{r, fig.cap="Plot Means Valoracions", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
par(mfrow = c(1, 2), cex.main = 0.8, cex.axis = 0.7, cex.lab = 0.6, mgp=c(3,2,0))
plotMeans(dd$Average_Score, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "Plot Means Average_Score", ylab = "mitjana Average_Score",
        xlab = "cluster")
plotMeans(dd$Reviewer_Score, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "Plot Means of Reviewer_Score", ylab = "mitjana Reviewer_Score",
        xlab = "cluster")
```
En efecte, les conclusions que podem obtenir d'aquests gr√†fics s√≥n calcades a les que hem obtingut analitzant *Review_Is_Positive, Review_Positivity_Rate. Review_Total_Negative_Word_Counts i Review_Total_Positive_Word_Counts*: cl√∫ster 3 pitjors valoracions, cl√∫ster 4 millors valoracions i la resta mantenint-se en la mitjana global. Aix√≤ pot ser un indici d'alta correlaci√≥ entre aquestes variables.

Tots dos testos mantenen la significaci√≥ global amb valors m√©s propers a la no significaci√≥ per als cl√∫sters 1, 2 i 5 que, recordem es troben a prop de la mitjana global.

```{r, warning=F, comment = "", message=FALSE}
k <- 26
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Average_Score:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Average_Score:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print("p-values ValorsTest Average_Score:")
print(pvalk[,k])

k <- 27
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Reviewer_Score:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Reviewer_Score:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print("p-values ValorsTest Reviewer_Score:")
print(pvalk[,k])
```

La seg√ºent variable que analitzem, ja a falta de nom√©s dues per concloure el profiling, √©s *Total_Number_of_Reviews_Reviewer_Has_Given*. Aquesta ens dona informaci√≥ sobre com d'actiu a Booking √©s l'usuari que ha escrit la ressenya *(Figure 39)*. En aquest sentit, observem com els usuaris relatius al cl√∫ster 1 s√≥n els m√©s actius i la resta es mant√© a prop de la mitjana global, exepte els del tercer conglomerat, on la mitjana de comentaris totals escrits pels usuaris √©s m√©s baixa.

```{r, fig.cap="Profiling variable Total_Reviews_Given", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7.5}
k <- 28
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
boxplot(dd[,k]~P, horizontal=TRUE)
title(main=paste(names(dd)[k], "vs", nameP ), ylab = "cluster", xlab = "Total de ressenyes escrites pels usuaris", line = 1)

barplot(tapply(dd[[k]], P, mean))
title(main=paste(names(dd)[k], "by", nameP ), ylab = "Nombre mig de ressenyes escrites pels usuaris", xlab = "cluster", line = 1)
abline(h=mean(dd[[k]]))
legend(0,mean(dd[[k]]),"global mean",bty="n")
```

Els contrastos reforcen la conclusi√≥ obtinguda observant el gr√†fic, ja que la significaci√≥ m√©s forta apareix als cl√∫sters 1 i 3.

```{r, warning=F, comment = "", message=FALSE}
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Total_Number_of_Reviews_Reviewer_Has_Given:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Total_Number_of_Reviews_Reviewer_Has_Given:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print("p-values ValorsTest Total_Number_of_Reviews_Reviewer_Has_Given:")
print(pvalk[,k])
```

A continuaci√≥ ens fixem en la variable *Additional_Number_of_Scoring* relativa al total de valoracions adicionals que rep l'hotel (localitzaci√≥, nejeta, servei...). Seria interessant veure si els hotels amb valoracions m√©s positives tamb√© reben un major nombre de comentaris adicionals, o aquest efecte √©s just al contrari *(Figure 40)*.

```{r, fig.cap="Profiling variable Additional_Number_of_Scoring", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
k <- 29
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
boxplot(dd[,k]~P, main=paste("Boxplot of", names(dd)[k], "vs", nameP ), horizontal=TRUE) 
title(ylab = "cluster", xlab = "Nombre de valoracions adicionals", line = 1)

barplot(tapply(dd[[k]], P, mean),main=paste("Means of", names(dd)[k], "by", nameP ))
title(ylab = "Nombre mig de valoracions adicionals", xlab = "cluster", line = 1)
abline(h=mean(dd[[k]]))
legend(0,mean(dd[[k]]),"global mean",bty="n")
```

Veiem com el resultat √©s clarament significatiu i, curiosament, els hotels dels cl√∫sters on les puntuacions s√≥n m√©s extremes (cluster 3 les m√©s negatives i cl√∫ster 4 les m√©s positives) √©s on els usuaris s'entreten m√©s a valorar aspectes extra de l'hotel. En contrapartida, aquells establiments hotelers amb valoracions mitjanes no solen rebre d'adicionals.

Els contrastos mostren una forta validesa estad√≠stica per als resultats obtinguts.

```{r, warning=F, comment = "", message=FALSE}
o<-oneway.test(dd[,k]~P)
print(paste("p-valueANOVA Additional_Number_of_Scoring:", o$p.value))
kw<-kruskal.test(dd[,k]~P)
print(paste("p-value Kruskal-Wallis Additional_Number_of_Scoring:", kw$p.value))
pvalk[,k]<-ValorTestXnum(dd[,k], P)
print("p-values ValorsTest Additional_Number_of_Scoring:")
print(pvalk[,k])
```

Per √∫ltim, considerem la variable *Submitted_from_Mobile*. Aquesta variable ens mostrar√† si en alg√∫n cl√∫ster s√≥n m√©s freq√ºents les ressenyes i valoracions escrites des del m√≤vil. Aquesta variable pot ser indicativa de si els usuaris est√†n satisfets, o no, amb el funcionament de la aplicaci√≥ de Booking.

```{r, fig.cap="Profiling variable Submitted_from_Mobile", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
require(colorspace)
k <- 30
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1), ylab = NULL)
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 3)
title("Submitted_from_Mobile (%)", xlab = "cluster", line = 1, ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=F,col=paleta, ylim = c(0, 1800))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Submitted_from_Mobile (nre. d'hotels)", ylab = "# usuaris", xlab = "cluster", line = 1)
```

No existeixen grans difer√®ncies entre els cl√∫sters pel que fa a la proporci√≥ de ressenyes escrites des del tel√®fon m√≤vil *(Figure 41)*. La difer√®ncia m√©s rellevant apareix en els usuaris compressos al cl√∫ster 3, els quals tendeixen a fer servir m√©s el tel√®fon m√≤vil per a escriure les seves ressenyes. Recordem que els hotels dins aquest conglomerat tendeixen a rebre valoracions m√©s negatives i, en conseq√º√®ncia, √©s possible inferir que aquestes s'escriuen en major grau des de tel√®fons m√≤vil. Pel que fa al contrast, veiem com la significaci√≥ global no √©s massa forta, segurament degut a que, excloent el cl√∫ster 3, tots els altres es troben for√ßa a prop de la mitjana global.

```{r, warning=F, comment = "", message=FALSE}
print("Test Chi quadrat Reviewer_Nationality:")
print(chisq.test(dd[,k], as.factor(P)))
```

Un cop tenim recopilada tota la informaci√≥ descriptiva de cada cl√∫ster, podem resumir-la en una taula, donant un nom al segment en q√ºesti√≥ i elaborant una petita descripci√≥ que inclogui els seus atributs principals.

|Cl√∫ster|Nom|Descripci√≥|
|:-:|:--:|:------------------:|
|1	|Utilitaris a la periferia|Hotels un tant allunyats del centre de les ciutats amb valoracions mitjanes (ni massa bones ni massa dolentes), generalment freq√ºentats per parelles, per√≤ tamb√© s√≥n abundants els grups (suposem que ser√†n els m√©s econ√≤mics). La est√†ncia mitjana est√† al voltant de la tend√®ndia general de 2,5 dies (cap de setmana llarg). Tamb√© s√≥n els hotels que reben m√©s comentaris.|
|2	|Anglesos a Barcelona|Hotels de Barcelona, majoritariament reservats per persones de nacionalitat anglesa amb pres√®ncia m√©s abundant de grups de viatgers i reservats per a llargues estades. Les valoracions s√≥n lleugerament superiors a la mitjana general per√≤ √©s el grup del que menys informaci√≥ disposem sobre el perfil i caracter√≠stiques de l'hotel. El nombre de revisions i puntuacions adicionals tamb√© es baix.|
|3	|Mal puntuats|S√≥n hotels majorit√†riament situats a Londres, no massa c√®ntrics, i els que han obtingut les valoracions m√©s baixes (els que menys agraden als clients). La majoria de ressenyes corresponen a un turisme local i s√≥n freq√ºentats per parelles o viatgers solitaris. Mencionar tamb√© que s√≥n els que reben m√©s ressenyes i valoracions, tot i que els usuaris que han visitat aquests hotels s√≥n els menys actius. Estades no massa llargues|
|4	|Ben puntuats |S√≥n hotels majorit√†riament situats a Londres, no massa c√®ntrics, i els que han obtingut les valoracions m√©s altes (els que m√©s agraden als clients). De nou reben molts comentaris tot i que els usuaris que han escrit les ressenyes d'aquest cl√∫ster no s√≥n gaire actius a Booking. En aquest grup s√≥n una mica m√©s freq√ºents les fam√≠lies i les parelles, en detriment del percentatge de grups grans de viatgers. Estades no massa llargues|
|5	|Experi√®ncia Urbana| Hotels amb valoracions mitjanes i poques valoracions, que es caracteritzen per estar situats al cor de Par√≠s. Predominen fam√≠lies amb nens petits i grups (les parelles no s√≥n tan habituals).|

\newpage

\section{ACP de les variables num√®riques}

L'objectiu general de l'an√†lisi de components principals √©s identificar patrons a les nostres dades, de manera que poguem analitzar-les redu√Ønt la dimensi√≥ de la base de dades original amb una p√®rdua d'informaci√≥ m√≠nima. 

√âs a dir, el output que busquem √©s la projecci√≥ de la nostra base de dades original (nxd) en un subespai m√©s petit, per√≤ que mantingui una bona representaci√≥ de les dades i les descrigui correctament. En aquest sentit, m√©s endavant veurem com aconseguir aquesta "bona" representaci√≥ de les dades mitjan√ßant els valors propis i vectors propis de la nostra matriu de dades. En general, podr√≠em dir que els objectius perseguits amb l'ACP s√≥n:

* Identificar patrons a les dades.
* Reduir la dimensionalitat de la base de dades original eliminant el "soroll" i les redund√†ncies.
* Identificar correlacions entre variables.

L'ACP aconsegueix aquests objectius transformant les variables inicials en nou (i m√©s petit) conjunt de variables sense que perdem la informaci√≥ m√©s rellevant que ens aporten aquestes. Les noves variables les anomenem components principals, i no s√≥n m√©s que combinacions lineals de les variables originals. La metodologia assumeix que les direccions principals amb major vari√†ncia s√≥n les m√©s importants. Per exemple, el primer component principal √©s una combinaci√≥ lineal de les variables originals que captura la vari√†ncia m√†xima de la base dades, determinant la direcci√≥ de m√©s variabilitat en les nostres dades n-dimensionals (cap component pot capturar m√©s variabilitat que el primer).

Per a evidenciar la explicaci√≥ anterior, proposem el seg√ºent gr√†fic on veiem com, sobre l'espai original es projecten els dos components principals que constitueixen els nous eixos de coordenades sobre els que rotaran les dades. La idea √©s aplicar aquest principi sobre les nostres dades i anar analizant les components en plans bidimensionals.

\begin{center}
\begin{figure} 
\includegraphics[width=3.2in]{Grafic_aux/PCA.png} 
\caption{Exemple: Projecci√≥ de les dues primeres components principals}
\end{figure}
\end{center}

En aquest sentit, √©s important mencionar des del comen√ßament que, com que hem de calcular dist√†ncies per a maximitzar aquestes vari√†ncies, considerarem com a actives √∫nicament les variables num√®riques ja que si incloem variables qualitatives en aquests c√†lculs, podem introduir errors considerables ja que R les tractar√† com a dummies per a la construcci√≥ d'aquestes combinacions lineals. En terminologia PCA, tenim:   

* **Individus actius**: Totes aquelles observacions que intervenen en l'ACP. En el nostre cas totes les observacions (5000).
* **Individus suplementaris**: Les coordenades d'aquests individus s'estimaran fent servir la informaci√≥ obtinguda de l'an√†lisi de components principals en base als individus actius.
* **Variables actives**: Totes les variables que utilitzem en l'ACP. En el nostre cas totes les num√®riques i num√®riques enteres.
* **Variables suplementaries**: Com en el cas dels individus suplementaris, les coordenades d'aquestes variables s'estimaran amb els resultats de l'an√†lisi. En aquest cas, no hem espcificat cap variable categ√≤rica suplementaria (les projectarem sobre els nous eixos).

```{r, results='hide', warning=F, comment = "", message=FALSE}
require(factoextra)
num <- which(sapply(dd, class) == "numeric"| sapply(dd, class) == "integer")

dcon <- dd[, num]
dcon <- dcon[ ,-1]

res.pca <- prcomp(dcon, scale = TRUE)
```

Podem fer servir *prcomp* per a que R calculi els valors propis de la matriu de dades un cop seleccionades les variables num√®riques actives en l'an√†lisi. A continuaci√≥, els representem en un gr√†fic *(Figure 43)* per a veure el percentatge de variabilitat total de les dades que captura cada dimensi√≥ (component principal).

```{r, fig.cap="Percentatge de vari√†ncia capturat a cada dimensi√≥", warning=F, comment = "", message=FALSE, fig.height=3.5, fig.width=4.5}
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,2,0))
fviz_eig(res.pca) + theme(axis.title = element_text(size=8))
```

Repetim el c√†lcul num√®ricament i observem com, per a assolir el llindar del 80% de la vari√†ncia total de les dades, necessitem 8 dimensions. Un altre llindar que normalment es fa servir √©s seleccionar dimensions fins que trobem un valor propi inferior a 1, ja que voldr√† dir que aquell valor propi capturar√† menys variabilitat que alguna de les variables originals. El resultat √©s molt semblant, tant si fem servir un criteri com l'altre (8 vs. 7).

```{r, message = FALSE, warning=F, comment = ""}
eig.val <- get_eigenvalue(res.pca)
eig.val
```

```{r, results='hide', warning=F, comment = "", message=FALSE}
nd = 8

# STORAGE OF THE EIGENVALUES, EIGENVECTORS AND PROJECTIONS IN THE nd DIMENSIONS

Psi = res.pca$x[,1:nd]
iden = row.names(dcon)
etiq = names(dcon)
ze = rep(0,length(etiq)) 
```

Un cop hem seleccionat les dimensions, podem guardar els resultats del PCA. Si partim de l'output res.pca de la comanda *prcomp*:       

\vspace{2mm}
          
*Resultats per a les variables*        

\vspace{1mm}


*res.var <- get_pca_var(res.pca)*

* res.var$coord          # Coordenades
* res.var$contrib        # Contribucions als components principals
* res.var$cos2           # Qualitat de la representaci√≥

*Resultats per als individus*        

\vspace{2mm}

*res.ind <- get_pca_ind(res.pca)*          

\vspace{1mm}
  
* res.ind$coord          # Coordenades
* res.ind$contrib        # Contribucions als components principals
* res.ind$cos2           # Qualitat de la representaci√≥

La qualitat de la representaci√≥ (cos2 a R) fa refer√®ncia a com de "bona" √©s la representaci√≥ de l'individu o la variable al component principal. Valors alts indicaran una alta representativitat, √©s a dir, m√©s rellevant ser√† aquell individu/variable per a la interpretaci√≥ dels resultats (major pes en l'an√†lisi). En contrapartida, valors baixos per a cos 2 indicaran baixa representativitat, poca correlaci√≥ dels valors de l'individu/variable amb la component principal (poca rellev√†ncia en l'an√†lisi).

\subsection{Gr√†fics d'individus}

Per a comen√ßar l'an√†lisi podem representar, en primer lloc, el n√πvol de punts dels individus sobre el primer pla factorial (components principals 1 i 2) *(Figure 44)*. S'ha considerat incloure en el gr√†fic la representativitat de cada individu, de manera que punts m√©s grans indicaran individus que mostren correlacions m√©s elevades amb la component principal.

```{r, fig.cap="Representaci√≥ dels individus sobre els PC (1er pla)", warning=F, comment = "", message=FALSE, fig.height=5.5, fig.width=7}
fviz_pca_ind(res.pca, col.ind = "cos2", pointsize = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07")) + theme(axis.title = element_text(size=8))
```

El n√∫vol de punts √©s molt homog√®ni, veiem com els individus amb menys representativitat prenen valors propers al centre de coordenades. A continuaci√≥ construim gr√†fics adicionals per a la resta de dimensions 3, 4, 5, 6 *(Figure 45)* (per abreujar l'an√†lisi, tractem nom√©s les 6 primeres dimensions, on es concentra la majoria de la variabilitat).

```{r, fig.cap="Representaci√≥ dels individus sobre els PC", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=6.5}
eje1<-1
eje2<-2
eje3<-3
eje4<-4
eje5<-5
eje6<-6

par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(1,1,0.5), mai = c(0.5, 0.5, 0.3, 0.3))

plot(Psi[,eje3],Psi[,eje4], xlab = "Dimensio_3", ylab = "Dimensio_4")
axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")

plot(Psi[,eje5],Psi[,eje6],  xlab = "Dimensio_5", ylab = "Dimensio_6")
axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")

```

Veiem com, a mesura que ens acosetem a dimensions d'ordre major, aquesta massa de punts es fa tornant m√©s compacte i ocupa menys a l'espai (menys dispersi√≥ entre els punts ja que es captura menys vari√†ncia). Adicionalment podem testar si aquests nous eixos construits a partir dels components principals ens separen b√© els cl√∫sters obtinguts anteriorment *(Figure 46)*. 

```{r, fig.cap="Clustering jer√†rquic sobre el primer pla factorial", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=5.5}
fviz_pca_ind(res.pca,
             geom.ind = "point", # show points only (nbut not "text")
             col.ind = as.factor(c5), # color by groups
             palette = c("#00AFBB", "#E7B800", "#FC4E07", "#E495A5", "#39BEB1"),
             addEllipses = TRUE, # Concentration ellipses
             legend.title = "Groups"
             ) + theme(axis.title = element_text(size=8))
```

Veiem com, sobre els eixos de dimensions, el cl√∫ster anterior no separa massa b√© els grups, en especial l'1 i el 2 (a simple vista, sembla que potser aniria millor amb 3 cl√∫sters). Deixant de banda aquest √∫ltim apartat, un cop hem representat els individus sobre aquests eixos de components principals, el seg√ºent pas ser√† tractar amb les variables i representar-les en els eixos d'aquest nou subespai. D'aquesta manera que podrem establir una relaci√≥ entre els individus i les variables, a partir de les posicions que ocupen.

\subsection{Gr√†fics de variables}

El primer pas, per a obtenir les projeccions de les variables √©s obtenir la correlaci√≥ entre els valors originals i les seves projeccions (fem servir les correlacions per a tenir una mesura estandaritzada). Un cop tinguem aquest resultat, la primera aproximaci√≥ que proposem √©s la creaci√≥ d'un gr√†fic per a veure la representativitat de cada variable en cada component principal *(Figure 47)*. La interpretaci√≥ √©s la mateixa que en el cas dels individus, a major representativitat, m√©s a prop de la circunfer√®ncia del cercle de correlacions i m√©s rellev√†ncia en l'an√†lisi.

```{r, fig.cap="Representativitat de les variables a cada dimensi√≥", warning=F, comment = "", message=FALSE, fig.height=6.5, fig.width=8.5, results = 'hide'}
var <- get_pca_var(res.pca)
library("corrplot")
corrplot(var$cos2[,1:8], is.corr=FALSE, tl.cex = 0.5, diag = FALSE) + theme(axis.title = element_text(size=8))
```

Un cop calculades les projeccions de les variables, caldr√† representar-les sobre els eixos de components principals. Podem pensar en un gr√†fic on representem aquests valors en funci√≥ de la seva contribuci√≥, de manera que poguem veure r√†pidament les que capturen m√©s vari√†ncia de l'eix. Construim el gr√†fic per al primer pla factorial (components principals 1 i 2) *(Figure 48)*. Recordem que aquestes variables s√≥n les actives en l'an√†lisi, ja que hem calculat les seves projeccions a partir de la matriu de correlacions descrita anteriorment.

```{r, fig.cap="Representaci√≥ de les variables sobre els PC(1er pla)", warning=F, comment = "", message=FALSE, fig.height=7, fig.width=8.5}
fviz_pca_var(res.pca, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             alpha.var = "contrib") + theme(axis.title = element_text(size=8))
```

En aquest primer pla veiem com les variables m√©s rellevants s√≥n la puntuaci√≥, el grau de positivisme del comentari i els negocis a 1km a la rodona, tot i que no totes en la mateixa direcci√≥. En general, les variables implicades en la valoraci√≥ del hotel (Reviewer_Score, Review_Positivity_Rate, Review_Total_Negative_Word_Counts...) tenen major representativitat a l'eix 1, mentre que les variables referides als negocis a la rodona i els comentaris adicionals es projecten millor a l'eix 2.
En aquest sentit, podem pensar que els individus situats al tercer sector del mapa de coordenades (valors negatius per a PC1 i PC2) s√≥n els que han obtingut millors valoracions. De la mateixa manera, √©s llogic que aquesta direcci√≥ sigui contr√†ria a la que mostra la variable *Review_Total_Negative_Word_Counts*.

A continuaci√≥, i com en el cas anterior, construim gr√†fics adicionals per a les dimensions 3, 4, 5 i 6 *(Figure 49)*.       

$\vspace{1mm}$

```{r, fig.cap="Representaci√≥ de les variables sobre els PC", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=7}
Phi = cor(dcon,Psi)
X<-Phi[,eje3]
Y<-Phi[,eje4]
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(1,1,0.5), mai = c(0.5, 0.5, 0.3, 0.3))
plot(Psi[,eje3],Psi[,eje4],type="n",xlim=c(-1,1), ylim = c(-1,1), xlab = "Dimensio_3", ylab = "Dimensio_4")
axis(side=1, pos= 0, labels = F)
axis(side=3, pos= 0, labels = F)
axis(side=2, pos= 0, labels = F)
axis(side=4, pos= 0, labels = F)
arrows(ze, ze, X, Y, length = 0.07,col="blue")
text(X,Y,labels=etiq,col="darkblue", cex=0.7)

X<-Phi[,eje5]
Y<-Phi[,eje6]
plot(Psi[,eje5],Psi[,eje6],type="n",xlim=c(-1,1), ylim = c(-1,1), xlab = "Dimensio_5", ylab = "Dimensio_6")
axis(side=1, pos= 0, labels = F)
axis(side=3, pos= 0, labels = F)
axis(side=2, pos= 0, labels = F)
axis(side=4, pos= 0, labels = F)
arrows(ze, ze, X, Y, length = 0.07,col="blue")
text(X,Y,labels=etiq,col="darkblue", cex=0.7)
```
         
\vspace{1mm}

En general, les variables ben representades a la Dimensi√≥ 2, tamb√© ho estan a la dimensi√≥ 3, en especials els comptatges de comentaris adicionals. D'aquest primer gr√†fic tamb√© es despr√®n una alta representativitat de les latituds i longituds a les dimensions 3 i 4. En contrapartida, a les dimensions 5 i 6 tenim, en general, una pitjor representaci√≥ global destacant √∫nicament, per√≤ en gran mesura, les variables *Total_Number_of_Reviews_Reviewer_Has_Given* i *Stay_Duration*.

Adicionalment, el software ens permet crear una esp√®cie de cl√∫ster de les variables num√®riques fent servir kmeans *(Figure 50)*. D'aquesta manera, creem conglomerats de variables que, a priori, assumim es relacionen del mateix mode amb les components principals. Recordem que l'algoritme kmeans requereix especificar el nombre de categories que desitgem (en aquest cas hem considerat 3).

```{r, fig.cap="Representaci√≥ de les variables sobre els PC(1er pla)", warning=F, comment = "", message=FALSE, fig.height=7, fig.width=8.5}
# Create a grouping variable using kmeans
# Create 3 groups of variables (centers = 3)
set.seed(123)
res.km <- kmeans(var$coord, centers = 3, nstart = 25)
grp <- as.factor(res.km$cluster)
# Color variables by groups
fviz_pca_var(res.pca, col.var = grp, 
             palette = c("#0073C2FF", "#EFC000FF", "#868686FF", "red"),
             legend.title = "Cluster")
```

L'agrupaci√≥ sembla ll√≤gica ja que les variables que s'agrupen estan altament correlacionades entre elles. Per exemple *Review_Positivity_Rate*, *Reviewer_Score* i *Review_Total_Positive_Word_Counts*, o les tres variables corresponents als negocis a la rodona. √âs natural pensar que aquestes variables es desplacin conjuntament en aquest nou subespai.            

Un cop tractades les variables num√®riques actives a l'an√†lisi, no podem olvidar les variables qualitatives que hem deixat de banda inicialment. Podem fer un c√†lcul de la vari√†ncia (en relaci√≥ a les modalitats) de les variables qualitatives de la nostra base de dades i projectar-les als eixos juntament amb les num√®riques. Comen√ßem fent una representaci√≥ senzilla de les categories de la variable *Hotel_Country* en el primer pla factorial *(Figure 51)*. M√©s endavant proposarem construir un gr√†fic amb tots els nivells de totes les variables categ√≤riques, de manera que poguem identificar intu√Øtivament relacions entre variables als plans factorials.

```{r, fig.cap="Hotel_Country al primer pla factorial", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=5.5}
par(cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(1,0.5,0))
plot(Psi[,eje1],Psi[,eje2],type="n")
axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")

#select your qualitative variable
k<-3 #dictamen in credsco
varcat<-dd[,k]
fdic1 = tapply(Psi[,eje1],varcat,mean)
fdic2 = tapply(Psi[,eje2],varcat,mean) 

points(fdic1,fdic2,pch=16,col="blue")
text(fdic1,fdic2,labels=levels(dd[ ,k]),col="blue", cex=0.7)
```

Veiem com, en general, les categories es troben for√ßa a prop del centre de coordenades i no podem inferir gaire cosa. Tanmateix, la modalitat "Fran√ßa" es troba en la direcci√≥ de *Businesses_1km*. Aquest resultat concorda amb el que hem vist en l'etapa de profiling, ja que els hotels m√©s urbans (cluster 5) √©s troben majorit√†riament a Fran√ßa.

A continuaci√≥ generem un gr√†fic amb totes les modalitats de totes les variables cat√®goriques *(Figure 52)*. Si tenim molts nivells en total, com √©s el nostre cas, podem desdoblar el gr√†fic per a poder apreciar millor els nivells i evitar solapaments. D'aquesta manera, la interpretaci√≥ ser√† m√©s f√†cil, i de m√©s qualitat.

```{r, fig.cap="Projeccions de totes les modalitats sobre Dim.1 i Dim.2", warning=F, comment = "", message=FALSE, fig.height=5, fig.width=7}
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(2,0.5,0), mai = c(2, 0.8, 0.3, 0.3))

#all qualitative together
plot(Psi[,eje1],Psi[,eje2],type="n", ylim = c(-2, 2), xlim = c(-2, 2))
axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")

#nominal qualitative variables

dcat1<-c(3:4, 10:12,16)
#divide categoricals in several graphs if joint representation saturates

#build a palette with as much colors as qualitative variables 

colors<-rainbow_hcl(length(dcat1))
#alternative
#colors<-rainbow(length(dcat))

c<-1
for(k in dcat1){
  seguentColor<-colors[c]
  fdic1 = tapply(Psi[,eje1],dd[,k],mean)
  fdic2 = tapply(Psi[,eje2],dd[,k],mean) 
  
  text(fdic1,fdic2,labels=levels(dd[,k]),col=seguentColor, cex=0.6)
  c<-c+1
}
legend("bottomleft",names(dd)[dcat1],pch=1,col=colors, cex=0.6)


plot(Psi[,eje1],Psi[,eje2],type="n", ylim = c(-2, 2), xlim = c(-2, 2))
axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")

#nominal qualitative variables

dcat2 <- c(17, 19, 21, 30)
#divide categoricals in several graphs if joint representation saturates

#build a palette with as much colors as qualitative variables 

colors<-rainbow_hcl(length(dcat2))
#alternative
#colors<-rainbow(length(dcat))

c<-1
for(k in dcat2){
  seguentColor<-colors[c]
  fdic1 = tapply(Psi[,eje1],dd[,k],mean)
  fdic2 = tapply(Psi[,eje2],dd[,k],mean) 
  
  text(fdic1,fdic2,labels=levels(dd[,k]),col=seguentColor, cex=0.6)
  c<-c+1
}
legend("bottomleft",names(dd)[dcat2],pch=1,col=colors, cex=0.6)

```

La interpretaci√≥ √©s id√®ntica al cas de una sola variable, veiem com les modalitats de Fran√ßa i Par√≠s es troben al segon sector de la circunfer√®ncia. En general, el gr√†fic ens confirma les relacions que hem establert al profiling anterior ja que, per exemple la nationalitat brit√†nica i els hotels de Londres ocupen espais molt propers, els valors positius per a la variable *Review_Is_Positive* es troben al tercer sector que concorda amb la direcci√≥ de creixement de les variables *Reviewer_Score* i *Review_Positivity_Rate*, etc. A continuaci√≥, repetim el procediment per a les dimensions tercera i quarta *(Figure 53)*.

```{r, fig.cap="Projeccions de totes les modalitats sobre Dim.3 i Dim.4", warning=F, comment = "", message=FALSE, fig.height=5, fig.width=7}
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(2,0.5,0), mai = c(2, 0.8, 0.3, 0.3))

#all qualitative together
plot(Psi[,eje3],Psi[,eje4],type="n", ylim = c(-2, 2), xlim = c(-2, 2))
axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")

#nominal qualitative variables

dcat1<-c(3:4, 10:12,16)
#divide categoricals in several graphs if joint representation saturates

#build a palette with as much colors as qualitative variables 

colors<-rainbow_hcl(length(dcat1))
#alternative
#colors<-rainbow(length(dcat))

c<-1
for(k in dcat1){
  seguentColor<-colors[c]
  fdic1 = tapply(Psi[,eje3],dd[,k],mean)
  fdic2 = tapply(Psi[,eje4],dd[,k],mean) 
  
  text(fdic1,fdic2,labels=levels(dd[,k]),col=seguentColor, cex=0.6)
  c<-c+1
}
legend("bottomleft",names(dd)[dcat1],pch=1,col=colors, cex=0.6)


plot(Psi[,eje3],Psi[,eje4],type="n", ylim = c(-2, 2), xlim = c(-2, 2))
axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")

#nominal qualitative variables

dcat2 <- c(17, 19, 21, 30)
#divide categoricals in several graphs if joint representation saturates

#build a palette with as much colors as qualitative variables 

colors<-rainbow_hcl(length(dcat2))
#alternative
#colors<-rainbow(length(dcat))

c<-1
for(k in dcat2){
  seguentColor<-colors[c]
  fdic1 = tapply(Psi[,eje3],dd[,k],mean)
  fdic2 = tapply(Psi[,eje4],dd[,k],mean) 
  
  text(fdic1,fdic2,labels=levels(dd[,k]),col=seguentColor, cex=0.6)
  c<-c+1
}
legend("bottomleft",names(dd)[dcat2],pch=1,col=colors, cex=0.6)

```

Aquest segon gr√†fic mostra bona representaci√≥ per a modalitats com "Grecia", "Israel", "Barcelona" o "Milan" que abans consider√†vem inertes. En aquest cas hem projectat les modalitats √∫nicament sobre les 4 primeres dimensions que, com sabem, s√≥n les capturen major variabilitat de les dades. Tanmteix, de cara a estudis futurs podria ser interessent representar les modalitats en un major nombre de dimensions.
Si anem una mica m√©s enll√†, el m√©s interessant tenint l'input dels gr√†fics anteriors, √©s identificar possibles correlacions entre modalitats de les variables categ√≤riques i les projeccions de les variables num√®riques sobre els plans factorials (l'espai sobre el que projectem √©s el mateix i per tant s√≥n perfectament comparables). D'aquesta manera, podrem establir relacions entre variables determinant quines modalitats s√≥n indicatives de valors alts/baixos per qualsevol variable num√®rica de la base de dades. La metodologia √©s id√®ntica a la emprada per a construir els gr√†fics anteriors, √∫nicament cal representar un fons amb les variables num√®riques indicant les seves direccions de creixement respecte als plans factorials *(Figure 54)*. Generalment, es com√∫ fer servir un factor d'escala per a poder tenir una bona visualitzaci√≥ dels nivells de les variables qualitatives i les direccions de les num√®riques. En aquest sentit, per prova i error hem detectat que un factor corrector de 3 unitats s'adapta b√© a la dimensionalitat de les nostres dades. En aquesta l√≠nea d'aconseguir representacions clares i f√†cils d'interpretar, hem dividit de nou les variables categ√≤riques en dos conjunts.


```{r, fig.cap="Projeccions deles modalitats amb variables num√®riques", warning=F, comment = "", message=FALSE, fig.height=5.5, fig.width=7.5}
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(2,0.5,0), mai = c(2, 0.8, 0.3, 0.3))
fm = round(max(abs(Psi[,1]))) 
fm = 3
#scale the projected variables
X<-fm*Phi[,eje1]
Y<-fm*Phi[,eje2]

#represent numerical variables in background
plot(Psi[,eje1],Psi[,eje2],type="n",xlim=c(-5,5), ylim=c(-3,2))
#plot(X,Y,type="none",xlim=c(min(X,0),max(X,0)))
axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")

#add projections of numerical variables in background
arrows(ze, ze, X, Y, length = 0.07,col="lightgray")
text(X,Y,labels=etiq,col="gray", cex=0.7)

#add centroids
c<-1
for(k in dcat1){
  seguentColor<-colors[c]
  
  fdic1 = tapply(Psi[,eje1],dd[,k],mean)
  fdic2 = tapply(Psi[,eje2],dd[,k],mean) 
  
  #points(fdic1,fdic2,pch=16,col=seguentColor, labels=levels(dd[,k]))
  text(fdic1,fdic2,labels=levels(dd[,k]),col=seguentColor, cex=0.6)
  c<-c+1
}
legend("bottomleft",names(dd)[dcat1],pch=1,col=colors, cex=0.6)

fm = round(max(abs(Psi[,1]))) 
fm = 3
#scale the projected variables
X<-fm*Phi[,eje1]
Y<-fm*Phi[,eje2]

#represent numerical variables in background
plot(Psi[,eje1],Psi[,eje2],type="n",xlim=c(-5,5), ylim=c(-3,2))
#plot(X,Y,type="none",xlim=c(min(X,0),max(X,0)))
axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")

#add projections of numerical variables in background
arrows(ze, ze, X, Y, length = 0.07,col="lightgray")
text(X,Y,labels=etiq,col="gray", cex=0.7)

#add centroids
c<-1
for(k in dcat2){
  seguentColor<-colors[c]
  
  fdic1 = tapply(Psi[,eje1],dd[,k],mean)
  fdic2 = tapply(Psi[,eje2],dd[,k],mean) 
  
  #points(fdic1,fdic2,pch=16,col=seguentColor, labels=levels(dd[,k]))
  text(fdic1,fdic2,labels=levels(dd[,k]),col=seguentColor, cex=0.6)
  c<-c+1
}
legend("bottomleft",names(dd)[dcat2],pch=1,col=colors, cex=0.6)
```

\subsection{Biplots mixtes de variables i individus}

Per √∫ltim, i com a ampliaci√≥, hem considerat la representaci√≥ gr√†fica de diferents biplots on exposem juntament el n√∫vol de punts del les projeccions dels individus sobre els eixos de components principals i les projeccions de les variables actives (num√®riques). Hem incl√≤s les variables qualitatives en aquests gr√†fics creant agrupacions d'individus en base a les modalitats, de manera que podem identificar, al mateix temps, la posici√≥ en l'espai dels individus corresponents a una modalitat d'una variable qualitativa determinada *(Figure 55)*.

```{r, fig.cap="Representaci√≥ de les variables sobre els PC (1er pla)", warning=F, comment = "", message=FALSE, fig.height=9, fig.width=9}
# Create a grouping variable using kmeans
# Create 3 groups of variables (centers = 3)
par(cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(2,0.5,0), mai = c(2, 0.8, 0.3, 0.3))
require(gridExtra)
plot1 <- fviz_pca_biplot(res.pca, 
                col.ind = dd$Hotel_Country, palette = "jco", 
                addEllipses = TRUE, label = "var",
                col.var = "black", repel = TRUE,
                legend.title = "Modalitats") 
plot2 <- fviz_pca_biplot(res.pca, 
                col.ind = dd$Room_Type_Level, palette = "jco", 
                addEllipses = TRUE, label = "var",
                col.var = "black", repel = TRUE,
                legend.title = "Modalitats") 
plot3 <- fviz_pca_biplot(res.pca, 
                col.ind = dd$Trip_Type, palette = "jco", 
                addEllipses = TRUE, label = "var",
                col.var = "black", repel = TRUE,
                legend.title = "Modalitats")
plot4 <- fviz_pca_biplot(res.pca, 
                col.ind = dd$Review_Is_Positive, palette = "jco", 
                addEllipses = TRUE, label = "var",
                col.var = "black", repel = TRUE,
                legend.title = "Modalitats") 
grid.arrange(plot1, plot2, plot3, plot4, ncol=2)
```

Observem com, en general, les categories es troben for√ßa sobreposades. La distinci√≥ m√©s clara la trobem en la variable *Review_Is_Positive*, on clarament veiem com, valors negatius per a les components principals 1 i 2, estan altament correlacionats amb valoracions positives (i valors alts per a les variables *Review_Positivity_Rate*, *Reviewer_Score*, *Review_Total_Positive_Word_Counts*...). Podem fer distincions lleus, en relaci√≥ al primer gr√†fic on es pot apreciar subtilment que les modalitats "Fran√ßa" i "Gran Bretanya" es corresponen amb el segon i quart sector del gr√†fic. En aquest sentit, podem veure com hotels ubicats a Fran√ßa seran m√©s urbans (valors alts per a variables Businesses), mentre que els hotels anglesos tindran m√©s ressenyes i valoracions addicionals.

\newpage

\section{ACM de les variables qualitatives}

L'an√†lisi de correspond√®ncia m√∫ltiple (ACM) √©s una extensi√≥ de l'an√†lisi de correspond√®ncia simple per tal de resumir i visualitzar una taula de dades que contingui m√©s de dues variables categ√≤riques. L'ACM tamb√© s'usa com una generalitzaci√≥ de l'an√†lisi de components principals quan les variables a analitzar s√≥n categ√≤riques en lloc de quantitatives.

L'ACM s'ha utilitzat generalment per analizar un conjunt de dades d'una enquesta.        

\vspace{1mm}

L'objectiu de l'ACM √©s identificar:

* Grups d'individus amb un perfil semblant respecte a la resposta a les variables categ√≤riques.
* Associacions entre categories de les variables.

```{r, results='hide', warning=F, comment = "", message=FALSE}
rm(list = ls())
library(FactoMineR)
library(Matrix)
library(factoextra)
```

```{r, results='hide', warning=F, comment = "", message=FALSE}
datapath <- "~/ESTADISTICA/3er/2n semestre/An√†lisi Multivariant/Course project/Dades"
file <- "Booking_data_preprocessed_def.csv"
dd <- read.csv(paste(datapath, file, sep = "/"), sep = ",", dec = ".", header = T)
attach(dd)
no<-c(1,2,14,22,24)
dd<-dd[,-no]
quali<-c(1,2,8:10,13:14,16,18,25)
quanti<-c(3:7,11,12,15,17,19,20:24)
dd<-dd[,c(quali, quanti)]
res.mca0<-MCA(dd,quanti.sup=11:25,graph = FALSE )
```

La funci√≥ que usarem per calcular l'ACM s'anomena MCA i en aquesta funci√≥ indiquem:

+ dd: la nostra base de dades.
+ quanti.sup: Les variables quantitatives de la nostra base de dades.

Per tal de mirar la proporci√≥ de vari√†ncia explicada per les diferents dimensions utilitzarem els valors propis.        

```{r, fig.cap="Scree Plot ACM", warning=F, comment = "", message=FALSE, fig.height=3.5, fig.width=4.5}
eig.val <- get_eigenvalue(res.mca0)
fviz_screeplot(res.mca0, addlabels = TRUE, ylim = c(0, 45))
```

Mitjan√ßant un Scree Plot *(Figure 56)* podem veure la vari√†ncia acumulada per a cada una de les dimensions. Com podem apreciar a la cinquena dimensi√≥ arribem a una vari√†ncia acumulada del 19.81%, per tal de seguir amb l'an√†lisi ens quedarem amb aquestes 5 dimensions.

```{r, warning=F, comment = "", message=FALSE}
head(eig.val,5)
```

Seguidament podem veure la contribuci√≥ tant de les 5000 observacions com de les categories de cada variable qualitativa a les  5 dimensions que hem definit per a analitzar.

```{r, warning=F, comment = "", message=FALSE}
head(res.mca0$ind$contrib,5)
head(res.mca0$var$contrib, 5)
```

Per tal de poder treure millors conclusions sobre les contribucions de cada  modalitat a les definicions de cada dimensi√≥ realitzarem un plot on poder interpretar els resultats anteriors. A continuaci√≥, fem un petit recordatori on es mostra el nombre de modalitats de cada variable qualitat que ha intervingut en l'an√†lisi.

```{r, warning=F, comment = "", message=FALSE}
df <- dd[,1:10]
dc <- dd[,11:25]
cats = apply(df, 2, function(x) nlevels(as.factor(x)))
cats 
mca1_vars_df = data.frame(res.mca0$var$contrib, Variable = rep(names(cats), cats))
mca1_obs_df = data.frame(res.mca0$ind$contrib)
```

Al seg√ºent gr√†fic *(Figure 57)* podem veure representades cada modalitat i, com hem dit, la seva contribuci√≥ a les dues dimensions proposades. Mitjan√ßant aquest plot podem identificar les variables que estan m√©s correlacionades amb les dues dimensions.

```{r, fig.cap="Contribucions de les modalitats sobre els PC(1er pla)", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=6.2}
ggplot(data=mca1_vars_df, 
       aes(x = Dim.1, y = Dim.2, label = rownames(mca1_vars_df))) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_text(aes(colour=Variable)) +
  ggtitle("ACM: Contribuci√≥ modalitats a les dimensions") 
```

Es pot observar com  les modalitats de Londres i Regne Unit s√≥n les m√©s correlacionades amb la dimensi√≥ 1 (aporten m√©s a la dimensi√≥ 1) i Barcelona i Espanya les m√©s correlacionades amb la dimensi√≥ 2. Les altres modalitats aporten menys, en comparaci√≥ amb aquestes, i haur√≠em de mirar-ho a la taula de contribucions per saber quant aporten exactament.

Per √∫ltim, tamb√© podem fixar-nos en les coordenades dels individus i de les modalitats sobre el pla factorial.

```{r, warning=F, comment = "", message=FALSE}
head(res.mca0$ind$coord,5)
head(res.mca0$var$coord,5)
```

Mitjan√ßant aquestes taules, podem observar les coordenades per a cada registre i modalitat sobre el pla factorial.

```{r, warning=F, comment = "", message=FALSE, results='hide'}
mca1_vars_df_coor = data.frame(res.mca0$var$coord, Variable = rep(names(cats), cats))
mca1_obs_df_coor = data.frame(res.mca0$ind$coord)
```

Mitjan√ßant el seg√ºent gr√†fic *(Figure 58)*, igual que anteriorment amb la contribuci√≥, podem millorar la taula pr√®via. Per tal de poder interpretar aquest plot hem de tenir en consideraci√≥ que:

+ Les modalitats de les variables amb un perfil similar s'agrupen.
+ Les modalitats de les variables negativament correlacionades se situen els quadrants oposats.
+ La dist√†ncia entre els punts de la modalitat i l'origen mesura la qualitat de la categoria variable en el mapa de factors. Els punts de modalitat que estan allunyats de l'origen estan ben representats en el mapa de factors.

```{r, fig.cap="Representaci√≥ de les modalitats sobre els PC(1er pla)", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=6.2}
ggplot(data=mca1_vars_df_coor, 
       aes(x = Dim.1, y = Dim.2, label = rownames(mca1_vars_df))) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_text(aes(colour=Variable)) +
  ggtitle("ACM coordenades modalitats") + 
  xlim(-1.,1.5)+
  ylim(-1.8,1.5)
```

Com podem veure hi ha modalitats ben allunyades de l'origen s√≥n entre altres Room_type_level_duplex, trip_type_other, Vicennes, Paris, Billancourt, Vienna, i per tant s√≥n algunes de les modalitats millor representades en el mapa de factors.

Per altra banda podem observar que Vicennes, Paris, Billancourt, es troben agrupades, aix√≤ vol dir que tenen caracter√≠stiques similars (cosa que t√© sentit, ja que totes formen part de la regi√≥ de Par√≠s).

Per √∫ltim en el seg√ºent gr√†fic, a m√©s de les modalitats tamb√© podem observar les coordenades de les observacions *(Figure 59)*. D'aquest mode podem observar diferents n√∫vols de punts representats en el plot. Per tal de relacionar les observacions amb les modalitats, podem interpretar que els n√∫vols de punts situats juntament amb les modalitats tenen les caracter√≠stiques d'aquelles mateixes categories.


```{r, fig.cap="Representaci√≥ de les modalitats i el n√∫vol d'individus sobre els PC(1er pla)", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=6.2}
ggplot(data = mca1_obs_df_coor, aes(x = Dim.1, y = Dim.2)) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_point(colour = "gray50", alpha = 0.7) +
  geom_density2d(colour = "gray80") +
  geom_text(data = mca1_vars_df, 
            aes(x = Dim.1, y = Dim.2, 
                label = rownames(mca1_vars_df), colour = Variable)) +
  ggtitle("AMC coordenades modalitats i registres") +
  scale_colour_discrete(name = "Variable")+
  xlim(-1.,1.5)+
  ylim(-1.8,1.5)
 
```


Seguidament analitzarem l'ACM amb la combinaci√≥ d'altres dimensions que no siguin la 1 i la 2. En primer lloc realitzarem l'an√†lisi entre la dimensi√≥ 1 i 3, mitjan√ßant els gr√†fics anteriors podrem extreure a les mateixes conclusions que abans sobre aquestes noves dimensions, i saber quines modalitats i/o observacions contribueixen m√©s a l'ACM *(Figure 60)*.

```{r, warning=F, comment = "", message=FALSE, results='hide'}
mca1_vars_df = data.frame(res.mca0$var$contrib, Variable = rep(names(cats), cats))
mca1_obs_df = data.frame(res.mca0$ind$contrib)
```

```{r, fig.cap="Contribucions de les modalitats sobre els PC(Dim.1 vs Dim.3)", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=6.2}
ggplot(data=mca1_vars_df, 
       aes(x = Dim.1, y = Dim.3, label = rownames(mca1_vars_df))) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_text(aes(colour=Variable)) +
  ggtitle("AMC Contribuci√≥ modalitats a les dimensions") 
```

Veiem com, l√≤gicament, les modalitats que m√©s aporten a la dimensi√≥ 1 s√≥n les mateixes que en el primer gr√†fic. Pel que fa a la dimensi√≥ 3 veiem que les que estan millor representades s√≥n Mil√† (It√†lia) i Par√≠s (Fran√ßa). Tamb√© podem destacar Barcelona i que la Review_date sigui festiu a la ciutat de l'allotjament. Per tal d'entrar a analitzar m√©s modalitats haur√≠em de mirar a la taula de contribucions.

Mitjan√ßant la taula de coordenades, podem observar aquestes contribucions per a cada registre i, de manera an√†loga al estudi de les dimensions 1 i 2, podem representar cada modalitat sobre el pla factorial *(Figure 61)*.

```{r, warning=F, comment = "", message=FALSE, results='hide'}
mca1_vars_df_coor = data.frame(res.mca0$var$coord, Variable = rep(names(cats), cats))
mca1_obs_df_coor = data.frame(res.mca0$ind$coord)
```

```{r, fig.cap="Representaci√≥ de les modalitats sobre els PC(Dim.1 vs Dim.3)", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=6.2}
ggplot(data=mca1_vars_df_coor, 
       aes(x = Dim.1, y = Dim.3, label = rownames(mca1_vars_df))) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_text(aes(colour=Variable)) +
  ggtitle("AMC coordenades modalitats") + 
  xlim(-1.,1.5)+
  ylim(-1.8,1.5)
```

Tal com hem vist abans les modalitats que es troben agrupades tenen un perfil similar, tamb√© podem interpretar que les modalitats situades en els quadrants oposats estan correlacionades negativament i una de les conclusions que podem extreure per exemple, √©s que els hostes su√Øssos solen viatjar sense mascotes. Per √∫ltim podem apreciar que les categories m√©s allunyades de l'origen de coordenades seran les que estiguin millor representades en el mapa de factors *(Figure 62)*.

```{r, fig.cap="Representaci√≥ de les modalitats i el n√∫vol d'individus sobre els PC(Dim.1 vs Dim.3)", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=6.2}
ggplot(data = mca1_obs_df_coor, aes(x = Dim.1, y = Dim.3)) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_point(colour = "gray50", alpha = 0.7) +
  geom_density2d(colour = "gray80") +
  geom_text(data = mca1_vars_df, 
            aes(x = Dim.1, y = Dim.2, 
                label = rownames(mca1_vars_df), colour = Variable)) +
  ggtitle("AMC coordenades modalitats i registres") +
  scale_colour_discrete(name = "Variable")+
  xlim(-1.,1.5)+
  ylim(-1.8,1.5)
 
```

El gr√†fic que compara les modalitats amb les coordenades de les observacions, no t√© sentit repetir-lo, ja que en aquests no intervenen les dimensions i per tant la seva representaci√≥, independentment de les dimensions escollides, ser√† la mateixa. 

Tal com hem pogut observar en l'an√†lisi de les dimensions 1,2 i 3, sigui quina sigui la combinaci√≥ entre elles, s'acaben treien les mateixes conclusions sobre quina modalitat esta millor representada a cada dimensi√≥ (ja que les representacions sobre els eixos s√≥n les mateixes). Si a simple vista no es veu quina modalitat contribueix m√©s a cada dimensi√≥, podem fixar-nos en les taules de coordenades i contribucions per esclarir els dubtes. Per a seguir avan√ßant, ara ens centrarem les dues dimensions que ens queden per analitzar.

```{r, warning=F, comment = "", message=FALSE, results='hide'}
mca1_vars_df = data.frame(res.mca0$var$contrib, Variable = rep(names(cats), cats))
mca1_obs_df = data.frame(res.mca0$ind$contrib)
```

Repetim el gr√†fic de contribucions, per a cada modalitat *(Figure 63)*

```{r, fig.cap="Contribucions de les modalitats sobre els PC(Dim.4 vs Dim.5)", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=6.2}
ggplot(data=mca1_vars_df, 
       aes(x = Dim.4, y = Dim.5, label = rownames(mca1_vars_df))) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_text(aes(colour=Variable)) +
  ggtitle("AMC Contribuci√≥ modalitats a les dimensions") 

```

Tal com es pot veure en aquest gr√†fic, les modalitats que m√©s aporten a la dimensi√≥ 4 s√≥n Amsterdam (Holanda) i Mil√† (It√†lia). Entre les altres categories a simple vista no es pot diferenciar quina t√© una major contribuci√≥. En canvi, a la dimensi√≥ 5 √©s Viena (A√πstria) √©s la millor representada.

```{r, warning=F, comment = "", message=FALSE, results='hide'}
mca1_vars_df_coor = data.frame(res.mca0$var$coord, Variable = rep(names(cats), cats))
mca1_obs_df_coor = data.frame(res.mca0$ind$coord)
```

Per a fer aquest resultat m√©s visual i, com en els casos anteriors, dibuixem les modalitats sobre els PC *(Figure 64)*

```{r, fig.cap="Representaci√≥ de les modalitats sobre els PC(Dim.4 vs Dim.5)", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=6.2}
ggplot(data=mca1_vars_df_coor, 
       aes(x = Dim.4, y = Dim.5, label = rownames(mca1_vars_df))) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_text(aes(colour=Variable)) +
  ggtitle("AMC coordenades modalitats") + 
  xlim(-1.,1.5)+
  ylim(-1.8,1.5)
```

Mencionar que, de nou, en aquest gr√†fic trobem les modalitats que tenen un perfil similar agrupades. Podem observar com, per exemple, la modalitat Nacionality_Israel est√† correlacionada negativament amb ciutat de l'hotel Billancourt, ja que aquestes es troben en quadrants oposats i les modalitats m√©s allunyades de l'origen de coordenades seran les que estiguin millor representades en el mapa de factors.

Com a conclusi√≥ de l'an√†lisi de correspond√®ncies m√∫ltiples, podem extreure que les variables Hotel_city i Hotel_country s√≥n les que tenen les modalitats millor representades a les 5 dimensions estudiades i, en conseq√º√®ncia, les m√©s rellevants a l'hora de difer√®nciar entre individus.       


\newpage 

\section{Clustering jer√†rquic sobre les components factorials retingudes a l'ACP i a l'ACM}

Aquesta secci√≥ t√© com a objectiu replicar el proc√©s de clustering jer√†rquic de la secci√≥ 4 per√≤, en comptes d'executar l'algoritme de clustering sobre les dades originals, fer servir com a input el resultat de l'an√†lisi de components principals. 

En aquest sentit, comencem replicant el procediment de l'an√†lisi de components principals, ja que necessitarem la matriu de coordenades dels individus sobre els components principals per a implementar el c√†lcul de les dist√†ncies. En aquest cas, hem fet servir la llibreria FactoMineR i hem tallat en les 8 dimensions que, ja hem vist, capturen aproximadament el 80% de la variabilitat de la matriu de les nostres dades.

```{r, results='hide', warning=F, comment = "", message=FALSE}
library(FactoMineR)
res.pca<-PCA(dd, ncp = 8, quali.sup = 1:10,graph=FALSE)
# Eigenvalues
res.pca$eig
```

Com a recordartori, proposem un la realitzaci√≥ d'un petit resum gr√†fic per individus i per variables dels resultats de l'ACP *(Figure 65)*.

```{r, fig.cap="Resum ACP", warning=F, comment = "", message=FALSE, fig.height=5, fig.width=8}
par(mfrow = c(2, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(2,0.5,0), mai = c(2, 0.8, 0.3, 0.3))

plot(res.pca,choix="var",axes=c(1,2))
plot(res.pca,choix="var",axes=c(3,4),select = "cos2 0.3")
plot(res.pca,choix="ind",invisible="quali",axes=c(1,2),label="none")
plot(res.pca,choix="ind",invisible="quali",axes=c(3,4),label="none")
```

A continuaci√≥, procedim amb el cl√∫ster en si. En primer lloc, hem d' extreure les coordenades dels individus per tots els components principals i calcular les dist√†ncies entre ells amb la funci√≥ dist (per defecte calcula dist√†ncies euclidianes).

```{r, results='hide', warning=F, comment = "", message=FALSE}
Psi<-res.pca$ind$coord
D = dist(Psi)
```

Un cop tenim la matriu de dist√†ncies $D$, la fem servir com a input per al c√†lcul del cl√∫ster jer√†rquic i realitzem els mateixos passos que en la secci√≥ 4 que, recordem empra el m√®tode de Ward *(Figure 66)*.

```{r, fig.cap="Dist√†ncia acumulada a cada tall (1:10)", warning=F, comment = "", message=FALSE, fig.height=3.8, fig.width=4.5}
hc <- hclust(D, method = "ward.D2") 
barplot(hc$height[1:10],main="Aggregated distance at each iteration", ylim = c(0, 0.35))
abline(h=0.12,col="red",lwd=2)
abline(h=0.08,col="red",lty=2)
```

Obsevem com, en vista de la dist√†ncia agregada en cada iteraci√≥, podriem considerar un nombre de cl√∫sters entre 5 i 10. Per a concretar una mica m√©s, podem representar el dendograma *(Figure 67)* i veure quin d'aquests talls s'adapta m√©s al resultat del clustering, d'un mode m√©s heur√≠stic.

```{r, fig.cap="Dendograma-m√®tode de Ward amb dist√†ncies euclidianes", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=5.5, fig.align="center"}
plot(hc, xlab = "observaci√≥", ylab = "Dist√†ncies", main = "Dendrograma-WARD", sub = "")
nc = 5
clus1 <- cutree(hc,nc)
rect.hclust(hc, k = 5, border="red")
```

A partir del dendograma, hem considerat tallar en 5 cl√∫sters, igual que en el clustering que hem fet anteriorment sobre les dades originals. Si recordem el procediment anterior, un cop hem fet efectiva la partici√≥, procedim a analitzar la qualitat d'aquesta, calculant la suma de quadrats entre cl√∫sters sobre la total. Recordem, √©s interessant minimizar la vari√†ncia intra-clusters (que a la vegada maximitzar√° la entre-clusters) ja que volem tenir els individus agrupats en conglomerats homog√®nis internament pero heterog√®nis entre ells.

```{r, results='hide', warning=F, comment = "", message=FALSE}
# The quality of partition
cdg <- aggregate(as.data.frame(Psi),list(clus1),mean)[2:9]
Bss <- sum(rowSums(cdg^2)*as.numeric(table(clus1)))
Tss <- sum(rowSums(Psi^2))

# Consolidate the partition
clus2<-kmeans(Psi,centers=cdg)

Bss <- sum(rowSums(clus2$centers^2)*clus2$size)
Wss <- sum(clus2$withinss)
100*Bss/(Bss+Wss)
```

Veiem com, en aquest cas, la partici√≥ no √©s tan bona (incl√∫s la consolidada) ja que amb l'ACP redu√Øm la dimensionalitat de les dades a un conjunt redu√Øt de components principals que capturen una major proporci√≥ de la vari√†ncia. A continuaci√≥, podem representar les dades als eixos de components principals un cop consolidada la partici√≥. Comencem fent la representaci√≥ sobre el primer pla factorial (components principals 1 i 2) *(Figure 68)*.

```{r, fig.cap="Clustering jer√†rquic ACP sobre el primer pla factorial", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=5.5}
require(factoextra)
fviz_pca_ind(res.pca,
             geom.ind = "point", # show points only (nbut not "text")
             col.ind = as.factor(clus2$cluster), # color by groups
             palette = c("#00AFBB", "#E7B800", "#FC4E07", "#E495A5", "#39BEB1"),
             addEllipses = TRUE, # Concentration ellipses
             legend.title = "Groups"
             ) + theme(axis.title = element_text(size=8))
```

Observem com el resultat √©s for√ßa semblant a l'obtingut en el clustering anterior, una forta distinci√≥ entre els conglomerats 3 i 5 que, recordem, es corresponien amb els perfils d'hotels ubicats, respectivament, a Fran√ßa i el Regne Unit (tot i que potser ara han canviat aquestes etiquetes).

Tot seguit, fem servir la funci√≥ *HCPC* de FactoMineR per a obtenir informaci√≥ adicional sobre la partici√≥. En primer lloc, mencionar que el output de la funci√≥ ens torna una list amb diferents components relacionats amb caracter√≠stiques de la partici√≥. Comencem mostrant el test Chi-quadrat que especifica la rellev√†ncia de cada variable categ√≤rica en la caracteritzaci√≥ dels cl√∫sters.

```{r, warning=F, comment = "", message=FALSE}
res.hcpc<-HCPC(res.pca, nb.clust = 5, consol = F, graph = F)
res.hcpc$desc.var$test.chi2
```

Observem com les variables geogr√†fiques s√≥n les que millor discriminen en relaci√≥ als nostres conglomerats. FactoMineR tamb√© ens permet realitzar una descripci√≥ completa de cada modalitat per variable, mostrant la representativitat de cada cluster en cada modalitat i de cada modalitat en cada cl√∫ster, juntament amb un test Chi-quadrat per a cada modalitat.

```{r, warning=F, comment = "", message=FALSE}
res.hcpc$desc.var$category
```

A continuaci√≥, repetim el procediment de trobar la variable que millor defineixi els conglomerats, aquest cop per a les variables num√®riques. Podem fer un ajust lineal amb els clusters com a covariables per a veure la relaci√≥ que existeix entre les nostres variables num√®riques i les components del cl√∫ster. En aquest cas, com a repostes testem les valoracions dels hotels, variables *Reviewer_Score* i *Average_Score*.

```{r, warning=F, comment = "", message=FALSE}
res.hcpc$desc.var$quanti.var
summary(lm(res.hcpc$data.clust$Reviewer_Score~res.hcpc$data.clust$clust))
summary(lm(res.hcpc$data.clust$Average_Score ~res.hcpc$data.clust$clust))
```

En conson√†ncia amb el resultat previ, les variables geogr√†fiques, s√≥n les que millor caracteritzen els nostres conglomerats (latitud i longitud, Negocis a la rodona...). A m√©s, tots dos models s√≥n significatius i les puntuacions (respostes) semblen ser m√°ximes al cl√∫ster 5.

A continuaci√≥, formulem la descripci√≥ dels cl√∫sters en termes de variables quanitatives. Un cop realitzat el nou profiling d'aquests cl√∫sters, farem m√©s intu√Øtiva aquesta caracteritzaci√≥. Tanmateix, a continuaci√≥ mostrem una pinzellada del que ens ofereix FactoMineR per a realitzar aquesta descripci√≥.

FactoMineR ens permet calcular estad√≠stics num√®rics per variable i cl√∫ster. En aquest cas, proposem calcular les mitjanes i desviacions tipus per al cl√∫ster 1 i el global, prenent com a variable num√®rica *Total_Number_of_Reviews*.

```{r, warning=F, comment = "", message=FALSE}
mean(res.hcpc$data.clust$Total_Number_of_Reviews[res.hcpc$data.clust$clust==1])
mean(res.hcpc$data.clust$Total_Number_of_Reviews)
sd(res.hcpc$data.clust$Total_Number_of_Reviews[res.hcpc$data.clust$clust==1])
sd(res.hcpc$data.clust$Total_Number_of_Reviews)
```

Noteu que, podem replicar el procediment anteior per a qualsevol combinaci√≥ de variable num√®rica i cl√∫ster.

Si volem un resum num√®ric complet (totes les variables i tots els cl√∫sters), cridem la comanda *res.hcpc$desc.var$quanti*.

```{r, warning=F, comment = "", message=FALSE}
res.hcpc$desc.var$quanti
```

Per √∫ltim, podem considerar la representaci√≥ dels cl√∫sters sobre altres plans factorials. En aquest cas, hem considerat representacions fins a la sisena dimensi√≥ *(Figure 69)*.

```{r, fig.cap="Clustering jer√†rquic ACP (plans factorials adicionals)", warning=F, comment = "", message=FALSE, fig.height=6, fig.width=8.2}
require(gridExtra)
plot1 <- fviz_pca_ind(res.pca,
                      axes = c(3, 4),
             geom.ind = "point", # show points only (nbut not "text")
             col.ind = as.factor(clus2$cluster), # color by groups
             palette = c("#00AFBB", "#E7B800", "#FC4E07", "#E495A5", "#39BEB1"),
             addEllipses = TRUE, # Concentration ellipses
             legend.title = "Groups"
             ) + theme(axis.title = element_text(size=8))
plot2 <- fviz_pca_ind(res.pca,
                      axes = c(5, 6),
             geom.ind = "point", # show points only (nbut not "text")
             col.ind = as.factor(clus2$cluster), # color by groups
             palette = c("#00AFBB", "#E7B800", "#FC4E07", "#E495A5", "#39BEB1"),
             addEllipses = TRUE, # Concentration ellipses
             legend.title = "Groups"
             ) + theme(axis.title = element_text(size=8))
grid.arrange(plot1, plot2, ncol=2)
```

Veiem com, a mesura que avancem en les dimensions, la variabilitat dismineix ja que aquesta √©s capturada per les dimensions superiors. En general, a major nombre de dimensi√≥ m√©s residual es torna aquesta, en termes de contribuci√≥ a la variabilitat de les dades.

\newpage

\section{Profiling del Cl√∫ster Jer√†rquic sobre ACP}

En aquesta secci√≥, repetim el profiling, ara considerant el cl√∫ster obtingut a partir de l'ACP. Recordem les eines descriptives que fem servir per a la caracteritzaci√≥ dels conglomerats:

* Snake plots, diagrames de barres o taules de conting√®ncia per a les variables qualitatives.
* Boxplots i diagrames de barres per a les variables num√®riques.

En aquest cas, obviem els constrastos, ja que aquests apareixen resumits en les taules de l'apartat anterior. L'objectiu d'aquesta secci√≥ passa m√©s per aportar una visi√≥ m√©s conceptual i f√†cil d'entendre de les caracteritzacions de cada cl√∫ster, i no pas endinsar-nos en c√†lculs num√®rics (les taule de l'apartat anterior contenen tota la informaci√≥ resumida en aquest apartat).

```{r, warning=F, comment = "", message=FALSE, results = 'hide'}
datapath <- "~/ESTADISTICA/3er/2n semestre/An√†lisi Multivariant/Course project/Dades"
file <- "Booking_data_preprocessed_def.csv"
dd <- read.csv(paste(datapath, file, sep = "/"), sep = ",", dec = ".", header = T)
attach(dd)
K<-dim(dd)[2]
par(ask=TRUE)

P<-as.numeric(clus2$cluster)
nc<-length(levels(as.factor(P)))
pvalk <- matrix(data=0,nrow=nc,ncol=K, dimnames=list(levels(P),names(dd)))
nameP<-"Cluster"
n<-dim(dd)[1]
c5 <- as.numeric(clus2$cluster)
```

Les primeres variables de la base de dades *Hotel_Country, Hotel_City, Hotel_lat, Hotel_lng* fan refer√®ncia a l'√†mbit geogr√†fic i √©s ll√≤gic pensar que la caracteritzaci√≥ dels cl√∫sters continuar√† en la mateixa l√≠nia en tots quatre casos *(Figure 70)*.

```{r, fig.cap="Profiling2 variable Hotel_Country", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
require(colorspace)
k <- 3
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.5,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1))
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 3)
title("Hotel_Country per cluster (%)", xlab = "cluster", line = 1,  ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=T,col=paleta, ylim = c(0, 1500))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Hotel_Country per cluster (nre. d'hotels)", ylab = "# hotels", xlab = "cluster", line = 1)
```

Observem com la situaci√≥ ha canviat totalment, ara els hotels de Gran Bretanya es trobem majorit√†riament concentrats als clusters 1 3 i 4. Al cl√∫ster 2 predominen els hotels d'It√†lia, Espanya i √Äustria, mentre que al 5 seguim tenint forta pres√®ncia Francesa.       

\vspace{2mm}

Si considerem la variable *Hotel_City*, de nou observem com les ciutats concorden amb els resultat obtingut en el profiling pr√®vi *(Figure 71)*.

```{r, fig.cap="Profiling2 variable Hotel_City", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
require(colorspace)
k <- 4
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.5,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1))
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 3)
title("Hotel_City per cluster (%)", xlab = "cluster", line = 1,  ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=T,col=paleta, ylim = c(0, 1800))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Hotel_City per cluster (nre. d'hotels)", ylab = "# hotels", xlab = "cluster", line = 1)
```


De nou, Per a facilitar la comprensi√≥ dels resultats geogr√†fics anteriors, podem pensar en fer servir les variables latitud i longitud per a realitzar una geolocalitzaci√≥ de les dades i visualitzar els cl√∫sters en un mapa. Als seg√ºents gr√†fics representem al mapa la localitzaci√≥ dels hotels estratificant per cl√∫sters, els quals distingim amb colors, i on la mida dels cercles fa refer√®ncia al nombre total de ressenyes que tenen els hotels *(Figure 72)*.

$\vspace{1mm}$

```{r, fig.cap="Geolocalitzaci√≥", warning=F, comment = "", message=FALSE, fig.height = 4, fig.width=6}
require(ggmap)
map <- get_map("France", zoom = 5, language = "Spanish")
cluster <- as.numeric(clus2$cluster)
variablePoints <- ggmap(map) + geom_point(aes(x = dd$Hotel_lng, y = dd$Hotel_lat, color = cluster, size = Total_Number_of_Reviews), data = dd, alpha = .5) + geom_text(aes(label = lat), size = 0.6) + theme(axis.title = element_text(size=10))
updatedMap <- variablePoints + scale_size_area(name = "Total number of reviews")
updatedMap
```


Si seguim amb la resta de variables de la base de dades, les seg√ºents tres fan refer√®ncia al nombre de negocis a la rodona considerant diferents dist√†ncies. L'objectiu cercat amb aquestes variables √©s fer una distinci√≥ entre hotels urbans i hotels m√©s allunyats del centre de les ciutats. Com que les variables *Business_100m, Business_1km i Business_5Km* tenen connotacions semblants, hem considerat novament representar-les juntes mitjan√ßant un plotMeans *(Figure 73)*.

```{r, fig.cap="Profiling2 Nre. Negocis a 100m, 1km i 5km a la rodona", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7.5}
require("Rcmdr")
par(mfrow = c(1, 3), cex.main = 0.8, cex.axis = 0.7, cex.lab = 0.6, mgp=c(3,2,0))
plotMeans(dd$Businesses_100m, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "Plot Means of Businesses_100m", ylab = "mitjana Businesses_100m",
        xlab = "cluster")
plotMeans(dd$Businesses_1km, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "Plot Means of Businesses_1km", ylab = "mitjana Businesses_1km",
        xlab = "cluster")
plotMeans(dd$Businesses_5km, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "Plot Means of Businesses_5km", ylab = "mitjana Businesses_5km",
        xlab = "cluster")
```

En aquest cas, observem com el cl√∫ster 5 absorbeix la gran majoria dels valors elevats per a variables de negocis a la rodona, est√† molt per sobre dels altres en tots els llindars

A continuaci√≥ ens fixem en el tipus d'habitaci√≥. Constru√Øm un snake plot i un diagrama de barres per a comparar les modalitats dins de cada cl√∫ster *(Figure 74)*

```{r, fig.cap="Profiling2 variable Room_Type_Level", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
require(colorspace)
k <- 10
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.5,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1))
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 2)
title("Room_Type_Level per cluster (%)", xlab = "cluster", line = 1, ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=T,col=paleta, ylim = c(0, 1500))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Room_Type_Level per cluster (nre. d'hotels)", ylab = "# habitacions per categoria", xlab = "cluster", line = 1)
```

De nou, aquest gr√†fic presenta la limitaci√≥ que tenim molts valors missing que hem incl√≤s en la categoria "Others". Aquesta categoria √©s la m√©s freq√ºent en tots els cl√∫sters, en especial al cl√∫ster 2. La resta de modalitats s√≥n for√ßa homog√®nies per a tots els cl√∫sters, amb la salvetat que al cl√∫ster 3 hi ha major pres√®ncia d'habitacions de tipus Standard (concorda amb el profiling anterior).

La seg√ºent variable √©s *Guest_Type*. En aquest cas, les parelles s√≥n m√©s abundants als cl√∫sters 1 i 5 *(Figure 75)*. Les persones que viatgen soles, en comptes de concentrar-se en el cl√∫ster 3, ara s√≥n m√©s freq√ºents al 4.

```{r,  fig.cap="Profiling2 variable Guest_Type", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=8.5}
require(colorspace)
k <- 11
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.5,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1))
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 1)
title("Guest_Type per cluster (%)", xlab = "cluster", line = 1, ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=T,col=paleta, ylim = c(0, 1500))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Guest_Type per cluster (nre. d'hotels)", ylab = "# clients per categoria", xlab = "cluster", line = 1)
```

A continuaci√≥, passem a la variable *Trip_Type* que reflecteix el motiu del viatge. Veiem com es mant√© for√ßa constant, predominen els viatges amb motiu d'oci per a tots els cl√∫sters, amb lleugeres difer√®ncies al cl√∫ster 4 on aquests baixen una mica i pugen els viatges per negocis (concorda amb els que viatgen sols) *(Figure 76)*.

```{r, fig.cap="Profiling2 variable Trip_Type", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=8.5}
require(colorspace)
k <- 12
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.5,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1))
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 2)
title("Trip_Type per cluster (%)", xlab = "cluster", line = 1, ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=T,col=paleta, ylim = c(0, 1500))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Trip_Type per cluster (nre. d'hotels)", ylab = "# viatges per categoria", xlab = "cluster", line = 1)
```

La seg√ºent variable √©s *Stay_Duration*. Al tenir davant una variable num√®rica, recordem, cal construir un boxplot i un gr√†fic de barres *(Figure 77)*. En aquest cas, els cl√∫sters 2 i 5 inclouen llargues estades, mentre que el primer, que en l'anterior profiling presentava un valor for√ßa alt, ara cont√© els hotels on les estades s√≥n les m√©s curtes. 

```{r, fig.cap="Profiling2 variable Stay_Duration", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
k <- 13
boxplot(dd[,k]~P, horizontal=TRUE)
title(main=paste("Boxplot of", names(dd)[k], "vs", nameP ), ylab = "cluster", xlab = "Dies d'estada", line = 1)

barplot(tapply(dd[[k]], P, mean))
title(main=paste("Means of", names(dd)[k], "by", nameP ), xlab = "cluster", ylab = "Durada est√†ncia mitjana", line = 1) 
abline(h=mean(dd[[k]]))
legend(0,mean(dd[[k]]),"global mean",bty="n")
```


La seg√ºent variable √©s *Days_Since Review*. En aquest cas, fem un resum num√®ric per a cada segment (cl√∫sters del 1 al 5). Sembla que la mitjana del cl√∫ster 5 √©s considerablement superior a la resta (igual que el profiling pr√®vi). Tanmateix, recordem que aquesta variable no est√† massa ben representada a les dimensions superiors.

```{r, warning=F, comment = "", message=FALSE}
dd$cluster <- NULL
k <- 15
for(s in levels(as.factor(P))) {print(summary(dd[P==s,k]))}
```


A continuaci√≥ ens fixem conjuntament en les variables *Is_Hotel_Holiday i Is_Reviewer_Holiday*, dicot√≤miques les dues. Per a caracteritzar els cl√∫sters, construim dos diagrames de barres apilades *(Figure 78)* de manera que poguem comparar entre els conglomerats si la ciutat de l'hotel, o la de l'usuari es troba en dia festiu. L'objectiu √©s veure si en algun cl√∫ster els clients tendeixen a escriure les ressenyes en dies festius.

```{r, fig.cap="Profiling2 variables dia Festiu", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
k <- 16
barplot(table(dd[,k], as.factor(P)), beside=F,col=paleta, ylim = c(0, 1800))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.7, col=paleta, ncol = 2)
title("Is_Hotel_Holiday per cluster (nre. d'hotels)", ylab = "# ressenyes", xlab = "cluster", line = 1)

k <- 17
barplot(table(dd[,k], as.factor(P)), beside=F,col=paleta, ylim = c(0, 1800))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.7, col=paleta, ncol = 2)
title("Is_Reviewer_Holiday per cluster (nre. d'hotels)", ylab = "# ressenyes", xlab = "cluster", line = 1)
```

Veiem com les proporcions es mantenen constants per a tots els cl√∫sters. Per a aquestes dues variables s'han redu√Øt les difer√®ncies entre cl√∫sters, en comparaci√≥ amb el profiling anterior. 

A continuaci√≥, ens fixem en la variable *Total_Number_of_Reviews* *(Figure 79)*. En aquest cas, el resultat es veu altament modificat i observem com, el cl√∫ster 3 presenta un valor extremadament alt mentre que tots els altres conglomerats es mantenen per sota la mitjana (concentraci√≥ de registres amb valors alts al cl√∫ster 3). En aquest cas oc√≤rre el fen√≤men contr√†ri a l'anterior, les difer√®ncies entre cl√∫sters s'han fet m√©s evidents.

```{r, fig.cap="Profiling2 variable Total_Number_of_Reviews", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
k <- 18
boxplot(dd[,k]~P, horizontal=TRUE)
title(main=paste("Boxplot of", names(dd)[k], "vs", nameP ), ylab = "cluster", xlab = "Nombre de ressenyes v√†lides", line = 1)

barplot(tapply(dd[[k]], P, mean))
title(main=paste("Means of", names(dd)[k], "by", nameP ), ylab = "Nombre mig de ressenyes v√†lides", xlab = "cluster", line = 1)
abline(h=mean(dd[[k]]))
legend(0,mean(dd[[k]]),"global mean",bty="n")
```
       
Les seg√ºents dues variables, s√≥n *Review_Is_Positive* i *Review_Positivity_Rate*, relacionades amb el grau de positivisme de la ressenya *(Figure 80)*. Veiem com, de nou, les difer√®ncies s'han accentuat respecte al profiling anterior.

```{r, fig.cap="Profiling2 variables grau de positivisme de la ressenya", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
k <- 19
barplot(table(dd[,k], as.factor(P)), beside=F,col=paleta, ylim = c(0, 1800))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.7, col=paleta, ncol = 2)
title("Review_Is_Positive (nre. d'hotels)", ylab = "# hotels", xlab = "cluster", line = 1)

k <- 20
barplot(tapply(dd[[k]], P, mean))
title(main=paste("Means of", names(dd)[k], "by", nameP ), xlab = "cluster", ylab = "Positivity Rate", line = 1)
abline(h=mean(dd[[k]]))
legend(0,mean(dd[[k]]),"global mean",bty="n")
```

Observant el gr√†fic, podem concloure que:     

* Els comentaris positius s'han concentrat als cl√∫sters 1, 2 i 5 (alt percentatge de ressenyes positives)  
* El cl√∫ster 4 t√© gaireb√© totes les ressenyes i comentaris negatius (al profiling anterior aquest paper l'adoptava el cl√∫ster 3).

La seg√ºent variable √©s *Reviewer Nationality*. Els resultats s√≥n consistents amb la hip√≤tesi pr√®via que el turisme predominant √©s intern *(Figure 81)*, ja que als cl√∫sters 1 i 3, on la majoria d'hotels es troben a Gran Bretanya, tamb√© es concentren la majoria de clients de nacionalitat anglesa.

```{r, fig.cap="Profiling2 variable Reviewer_Nationality", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=8}
require(colorspace)
k <- 21
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1))
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 3)
title("Reviewer_Nationality per cluster (%)", xlab = "cluster", line = 1, ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=T,col=paleta, ylim = c(0, 1800))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Reviewer_Nationality per cluster (nre. d'hotels)", ylab = "# usuaris", xlab = "cluster", line = 1)
```


Les seg√ºents variables, si excloem les textuals, s√≥n *Review_Total_Negative_Word_Counts i Review_Total_Positive_Word_Counts*. Els resultats concordem amb les conclusions ofertes pels gr√†fics que reflectien el grau de positivisme *(Figure 82)*. En aquest nou clustering, el conglomerat 4, absorbeix la majoria de ressenyes negatives.


```{r, fig.cap="Profiling2 Nre.paraules comentari Negatiu/Postiu", warning=F, comment = "", message=FALSE, fig.height=4.5, fig.width=7}
require("Rcmdr")
par(mfrow = c(1, 2), cex.main = 0.8, cex.axis = 0.7, cex.lab = 0.6, mgp=c(3,2,0))
plotMeans(dd$Review_Total_Negative_Word_Counts, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "PlotMeans Total_Negative_Word_Counts", ylab = "mitjana Review_Total_Negative_Word_Counts",
        xlab = "cluster")
plotMeans(dd$Review_Total_Positive_Word_Counts, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "Plot Means Total_Positive_Word_Counts", ylab = "mitjana Review_Total_Positive_Word_Counts",
        xlab = "cluster")
```


Tot seguit entrem a analitzar variables relacionades amb les puntuacions dels hotels (tot i ja tenir indicis del que obtindrem) *(Figure 83)*. De nou, prenem conjuntament la puntuaci√≥ mitjana que presentava l'hotel a finals de 2016, i la que han anat otorgant els usuaris de Booking que han escrit les ressenyes.

```{r, fig.cap="Profiling2 variable Valoracions", warning=F, comment = "", message=FALSE, fig.height=4.2, fig.width=7}
par(mfrow = c(1, 2), cex.main = 0.8, cex.axis = 0.7, cex.lab = 0.6, mgp=c(3,2,0))
plotMeans(dd$Average_Score, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "Plot Means Average_Score", ylab = "mitjana Average_Score",
        xlab = "cluster")
plotMeans(dd$Reviewer_Score, as.factor(c5), error.bars="se",connect=TRUE, 
        main = "Plot Means of Reviewer_Score", ylab = "mitjana Reviewer_Score",
        xlab = "cluster")
```
          
\vspace{1mm}

En efecte, les conclusions que podem obtenir d'aquests gr√†fics s√≥n calcades a les que hem obtingut analitzant *Review_Is_Positive, Review_Positivity_Rate. Review_Total_Negative_Word_Counts i Review_Total_Positive_Word_Counts*: cl√∫ster 4 pitjors valoracions, seguit d'aprop pel 3, i la resta amb valoracions elevades.

La seg√ºent variable que analitzem, √©s *Total_Number_of_Reviews_Reviewer_Has_Given*. Veiem com, en aquest clustering els individus del cl√∫ster 2 s√≥n els m√©s actius a Booking, mentre que en l'anterior ho eren els del cl√∫ster 3 *(Figure 84)*. La resta, a exepci√≥ del 5, es mant√© considerablement per sota la mitjana.

```{r, fig.cap="Profiling2 variable Total_Reviews_Given", warning=F, comment = "", message=FALSE, fig.height=4.2, fig.width=7.5}
k <- 28
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
boxplot(dd[,k]~P, horizontal=TRUE)
title(main=paste(names(dd)[k], "vs", nameP ), ylab = "cluster", xlab = "Total de ressenyes escrites pels usuaris", line = 1)

barplot(tapply(dd[[k]], P, mean))
title(main=paste(names(dd)[k], "by", nameP ), ylab = "Nombre mig de ressenyes escrites pels usuaris", xlab = "cluster", line = 1)
abline(h=mean(dd[[k]]))
legend(0,mean(dd[[k]]),"global mean",bty="n")
```


A continuaci√≥ ens fixem en la variable *Additional_Number_of_Scoring* *(Figure 85)*. En aquest cas, la majoria de valors alts per a aquesta variable es concentren al cl√∫ster 3 mentre que, en el primer profiling, aquesta posici√≥ era compartida pel 3 i el 4.

```{r, fig.cap="Profiling2 variable Additional_Number_of_Scoring", warning=F, comment = "", message=FALSE, fig.height=4.2, fig.width=7}
k <- 29
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
boxplot(dd[,k]~P, main=paste("Boxplot of", names(dd)[k], "vs", nameP ), horizontal=TRUE) 
title(ylab = "cluster", xlab = "Nombre de valoracions adicionals", line = 1)

barplot(tapply(dd[[k]], P, mean),main=paste("Means of", names(dd)[k], "by", nameP ))
title(ylab = "Nombre mig de valoracions adicionals", xlab = "cluster", line = 1)
abline(h=mean(dd[[k]]))
legend(0,mean(dd[[k]]),"global mean",bty="n")
```

Per √∫ltim, considerem la variable *Submitted_from_Mobile* *(Figure 86)*. Observem molt poca variaci√≥ entre clusters pel que fa a aquesta variable, a excepci√≥ d'un lleuger augment en el percentatge de ressenyes escrites des del m√≤vil al cl√∫ster 3.

```{r, fig.cap="Profiling2 variable Submitted_from_Mobile", warning=F, comment = "", message=FALSE, fig.height=4.2, fig.width=7}
require(colorspace)
k <- 30
par(mfrow = c(1, 2), cex.main = 0.7, cex.axis = 0.6, cex.lab = 0.6, mgp=c(3,0.4,0))
marg <-table(dd[,k])/n
paleta<-rainbow_hcl(length(levels(dd[,k])))
table<-table(P,dd[,k])
#   print("Cross-table")
#   print(table)
rowperc<-prop.table(table,1)
colperc<-prop.table(table,2)
marg <- table(as.factor(P))/n
marg <- table(as.factor(P))/n

plot(marg,type="n",ylim=c(0,1), ylab = NULL)
for(c in 1:length(levels(dd[,k]))){lines(rowperc[,c],col=paleta[c]) }
legend("topleft", levels(dd[,k]), col=paleta, lty=2, cex=0.6, ncol = 3)
title("Submitted_from_Mobile (%)", xlab = "cluster", line = 1, ylab = "%")

barplot(table(dd[,k], as.factor(P)), beside=F,col=paleta, ylim = c(0, 1800))
legend("topleft",levels(as.factor(dd[,k])),pch=1,cex=0.6, col=paleta, ncol = 2)
title("Submitted_from_Mobile (nre. d'hotels)", ylab = "# usuaris", xlab = "cluster", line = 1)
```

De nou, un cop tenim recopilada tota la informaci√≥ descriptiva de cada cl√∫ster, podem resumir-la en una taula, donant un nom al segment en q√ºesti√≥ i elaborant una petita descripci√≥ que inclogui els seus atributs principals.

|Cl√∫ster|Nom|Descripci√≥|
|:-:|:--:|:------------------:|
|1	|Eleg√†ncia Anglesa|An√†legs als ben putuats del profiling anterior. S√≥n ressenyes sobre hotels ubicats majorit√†riament a Londres lluny del centre urb√†. Aquests hotels s√≥n els que reben millors valoracions i el tipus de client m√©s habitual s√≥n parelles que viatgen per motius d'oci. Tamb√© s√≥n hotels que reben poques ressenyes i tampoc massa valoracions adicionals, cosa ll√≤gica ja que els seus clients s√≥n poc actius a la plataforma. Les estades tamb√© solen ser curtes en aquests hotels|
|2	|En Familia|Hotels a Barcelona, Vienna i Milan no excessivament c√®ntrics pero amb valoracions acceptables. Els m√©s semblants del profiling anterior s√≥n els utilitaris a la perif√®ria. Aquests hotels normalment s√≥n per a llargues estades i hi abunden lleugerament m√©s que en els anteriors les families amb nens petits/joves. En aquest grup predominen els clients de diferents nacionalitats (grup others) i, tot i que tampoc destaquen per rebre moltes valoracions/comentaris, els seus clients s√≥n els m√©s actius a la plataforma|
|3	|Londres mal valorats|Les ressenyes d'aquest segment estan associades amb hotels ubicats a Londres que no han rebut massa bones puntuacions|
|4	|Els que no agraden|An√†legs al grup 3 anterior| Hotels ubicats a Londres i Amsterdam que han rebut molt males puntuacions. Hotels utilitaris on les estades solen ser curtes i √©s el grup on m√©s abunden els viatges per negocis|
|5	|Experi√®ncia Urbana| Hotels amb valoracions mitjanes i poques valoracions, que es caracteritzen per estar situats al cor de Par√≠s. Predominen les parelles en viatges d'oci. Aquests hotels tamb√© han rebut altes puntuacions|

\newpage

\section{An√†lisi Textual}

Per tal de poder aprofitar les nostres dues variables Positive_Review i Negative_Review, que es basen en els comentaris tant positius com negatius que escriuen els clients dels allotjaments a Booking, realitzarem l'an√†lisi textual amb l'objectiu de poder determinar quines s√≥n aquelles paraules m√©s utilitzades i que m√©s contribueixen a la nostra base de dades.

Per tal de poder realitzar aquest apartat necessitarem els paquets FactoMiner (ja utilitzat previament) i Xplortext. 
```{r, warning=F, comment = "", message=FALSE, results='hide'}
datapath <- "~/ESTADISTICA/3er/2n semestre/An√†lisi Multivariant/Course project/Dades"
file <- "Booking_data_preprocessed_def.csv"
dd <- read.csv(paste(datapath, file, sep = "/"), sep = ",", dec = ".", header = T)
attach(dd)
library(FactoMineR)
library(Xplortext)
```

Ja que no disposem de variables  que ens indiqui quantes vegades apareix una paraula en cada registre, haurem de fer un recompte general per a cada paraula que apareix en les dues variables textuals que disposem, a partir de la funci√≥ **Textdata**.

```{r, warning=F, comment = "", message=FALSE, results='hide'}
text<-TextData(dd, var.text=c(22,24),Fmin=150, Dmin=150)
names<-names(text)
head(text$DocTerm$dimnames$Terms,20)
dm<-as.matrix(text$DocTerm)
a <- as.vector(text$DocTerm$dimnames$Terms)
a <- c(1:4,6,7,9,10,11,13,14,17,20,21,23,
          24,25,33,35,36,40,46,49,50,52,53,54,55,58
          ,59,60,61,62,63,64,69,70,73,74,75,77,
          78,81,83,84,85,86,87,89,90,91,92,95,99,104,109,110,115:121,
          123:128,131,132,134,135:139,141:144)
text$DocTerm$dimnames$Terms <- as.character(a)
dm<-dm[,-a]
b<-which(apply(dm,1,sum)==0)
dm<-dm[-b,]
```

Mitjan√ßant aquesta funci√≥ podem saber quantes vegades apareix cada paraula de les que formen les nostres variables textuals. Hem escollit per tal d'acotar la recerca, que aquestes paraules hi han d'apar√®ixer un m√≠nim de 150 vegades en els 5000 registres que disposem en la base dades. Un cop executada, ens hem trobat que la funci√≥ ens ha proporcionat algunes paraules poc rellevants i que per tant no podrien aportar informaci√≥ en el posterior an√†lisi. √âs per aix√≤ que d'aquesta llista final hem tret algunes paraules com preposicions, articles o verbs sense relaci√≥ amb les variables estudiades.

Un cop hem escollit les paraules a estudiar realitzem l'an√†lisi de correspond√®ncia:

```{r, warning=F, comment = "", message=FALSE}
res.ca<- CA(as.matrix(dm),graph = FALSE)
head(res.ca$eig,44)
```
Un cop fet podem observar mitjan√ßant els valors propis, com tenim moltes dimensions i per tal d'arribar  a una vari√†ncia del 80% necessitar√≠em 44 dimensions.

Nosaltres en el nostre an√†lisi textual ens centrarem en unes poques dimensions, i en aquestes ens focalitzarem en veure les contribucions de les paraules a cada una de les dimensions estudiades.

```{r, warning=F, comment = "", message=FALSE}
res.ca$col$contr[order(apply(res.ca$col$contr[,1:5],1,sum),decreasing=TRUE)[1:15],1:5]
```

Mitjan√ßant aquesta taula podem observar les 15 variables que m√©s aporten o contribueixen, en les 5 primeres dimensions. Que una paraula aporti m√©s a una dimensi√≥ indica que aquesta paraula tindr√† molta influ√®ncia en aquesta dimensi√≥ i que ser√† aquella paraula la que separar√† m√©s als individus o registres entre ells o m√©s els diferenciar√†. 

Per tal de veure aquesta taula d'una manera m√©s clara i entenedora podem fer un seguit de plots *(Figures 87, 88 & 89)*que ens mostrar√† aquestes contribucions d'una manera m√©s gr√†fica:

```{r, fig.cap="Constribucions D1 vs D2", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=6.5, fig.align="center"}
plot.CA(res.ca,invisible="row",axes=c(1,2),autoLab="yes")
```

En aquest gr√†fic es pot observar com les paraules en els comentaris dels clients que m√©s contribueixen a la dimensi√≥ 1, s√≥n aquelles que estan m√©s allunyades de l'eix Y, √©s a dir que es situen m√©s a prop dels extrems horitzontals. Per altra banda aquelles que estan m√©s allunyades de l'eix X, com pot ser metro, estaci√≥, proper (totes elles relacionades) o confortable s√≥n algunes de les que m√©s aporten a la dimensi√≥ 2.

Podem seguir analitzant el pes de les paraules de les nostres variables textuals en diferents dimensions, analitzarem les dimensions 3, 4 i 5.

```{r, fig.cap="Contribucions D3 vs D4", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=6.5, fig.align="center"}
plot.CA(res.ca,invisible="row",axes=c(3,4),autoLab="yes")
```

D'igual forma que en el gr√†fic anterior, interpretarem aquest plot. En la dimensi√≥ 3 aquelles paraules que m√©s aporten s√≥n menjar, servei i restaurant (relacionades amb la gastronomia i els √†pats que prenen els clients als seus respectius viatges). Pel que fa a la dimensi√≥ 4 s√≥n les paraules excel¬∑lent, car, o espectacular.

Per √∫ltim com hem dit analitzarem la dimensi√≥ vs les paraules de les variables textuals.

```{r, fig.cap="Dimensio vs nre. paraules", warning=F, comment = "", message=FALSE, fig.height=4, fig.width=6.5}
plot.CA(res.ca,invisible="row",axes=c(2,5),autoLab="yes")
```

Per tal de fer el plot relacionarem la 5 amb qualsevol de les dimensions anteriors i ens fixarem en com de separades estan les paraules respecte a l'eix X, com m√©s allunyades estiguin m√©s contribuiran a aquesta dimensi√≥. Com podem veure aire, soroll√≥s i confortable s√≥n les paraules que m√©s aporten a la cinquena dimensi√≥.

\newpage

\section{An√†lisi Comparativa dels diferents m√®todes i conclusions generals}

Per finalitzar, exposem les conclusions que hem obtingut a partir dels diferents m√®todes i t√®cniques d'an√†lisi que hem fet servir al llarg de l'estudi. En primer lloc, mencionar que els resultats obtinguts en cada apartat han seguit una ll√≤gica general de concordan√ßa al llarg de tot l'estudi. Totes les petites conclusions que hem anat elaborant en cada fase, s'han vist posteriorment refor√ßades per altres resultats. En relaci√≥ a les dues branques principals de l'estudi que s√≥n els dos clusterings (amb el posterior profiling) es pot apreciar com molts dels perfils tenen un alt grau de similitud. La difer√®ncia m√©s important que hem detectat es que, si fem servir les components de l'ACP al cl√∫stering, hi ha variables que s'estabilitzen (les difer√®ncies entre clusters es redueixen fins a nivells m√≠nim), mentre que d'altres s'accent√∫en molt per a un cl√∫ster particular. D'aquesta manera el proc√©s de profiling es fa m√©s evident i les caracter√≠stiques amb les que etiquetem els segments s√≥n m√©s rellevants.   

Tot seguit, intentem resoldre les q√ºestions plantejades a l'inici en relaci√≥ a les experi√®ncies dels usuaris de Booking. Fent servir aquesta petita mostra de dades hem pogut extreure les seg√ºents conclusions que, creiem, poden ajudar a millorar els viatges dels usuaris:

* En primer lloc, mencionar que per a viatges en parella, basant-nos en experi√®ncies pr√®vies d'altres usuaris, Par√≠s √©s destinaci√≥ ideal. Les parelles han valorat molt positivament la seva experi√®ncia en aquesta ciutat i recomanem estades llargues, de m√©s de tres dies.

* Barcelona √©s un dest√≠ molt recomanable per a fam√≠lies amb nens, que busquen estades m√©s aviat llargues.

* En general, els destins Gran Bretanya i Pa√Øsos Baixos obtenen valoracions m√©s baixes en relaci√≥ a la resta. En especial, per a estades curtes el servei als hotels ha rebut valoracions for√ßa dolentes. 

* Tot i no estar segurs de tenir prou evid√®ncies, un nombre elevat de negocis a la rodona, en especial si el radi es √†mpli, √©s indicatiu, en promig, de valoracions elevades. Una possible explicaci√≥ √©s que, per als usuaris, la ubicaci√≥ del hotel juga un paper fonamental en la seva experi√®ncia.

Un cop cobertes les conclusions que hem considerat, poden ser √∫tils per als usuaris de Booking, tamb√© volem breuement mostrar com el nostre an√†lisi por ajudar als hotels a l'hora de millorar el servei que ofereixen i satisfer els clients d'una manera m√©s eficient.

* En primer lloc, a nivell general s'ha observat que les experi√®ncies negatives s√≥n les que m√©s comentaris i valoracions generen. En aquest sentit, tot i que les valoracions no siguin bones, aix√≤ representa una gran aventatge per als hotels amb una pitjor performance ja que son els que disposen de m√©s informaci√≥ sobre el client i perqu√® no ha quedat satisfet. √âs molt important que els hotels prenguin nota de tots els comentaris, valoracions, opinions dels seus clients, especialment aquells que no han quedat contents ja que s√≥n els que aporten informaci√≥ m√©s valuosa per a millor (quin o quins serveis han puntuat pitjor, paraules clau que han deixat a la ressenya...). D'aquesta manera l'hotel pot centrar esfor√ßos en millorar el que, a prior fa pitjor. 

* Seguidament, hem detectat un gran mercat de usuaris descontents amb els hotels d'Amsterdam i Londres que escullen per motius de viatges de negocis o per estades curtes. En aquest sentit, aquests hotels m√©s allunyats del centre que a priori ofereixen un preu m√©s econ√≤mic tenen un gran marge de millorar per a intentar contentar aquest col.lectiu. Una possible estrat√®gia seria centrar-se en les demandes d'aquest perfil de client (molts viatgen en solitari o en parella i escullen habitacions de la categoria Classic o Deluxe) i intentar corregir les males actuacions ja que, al tenir un col.lectiu en general descontent, el fet de poguer satisfer les seves demandes, representar√† una gran avantatge competitiva. 

* Per √∫ltim, mencionar que en relaci√≥ als hotels de Barcelona hem pogut veure com, les estades que es contracten generalment s√≥n for√ßa llargues i el perfil de client √©s molt internacional. Caldr√† que els hotels estiguin preparats per adaptar-se a les demandes del tipus de client que sol contractar aquestes estades, predominen les parelles per√≤ aquest tipus de viatges el solen fer tamb√© fam√≠lies amb nens petits. D'aquesta manera aspectes com, oferir serveis per als infants, pensar en que el client hi estar√† hospedat bastants dies i no volem que s'aburreixi o  tenir personal que domini moltes lleng√ºes, poden ser aspectes clau per a tenir √®xit.


\section{Pla de treball real}

Per tancar, annexem el pla de treball real que hem seguit durant aquest semestre per a la realitzaci√≥ del treball de l'assignatura.

\subsection{Diagrama de Gantt}

\begin{figure} 
\includegraphics[width=6.2in]{Grafic_aux/Gantt_final.pdf} 
\caption{Diagrama de Gantt}
\end{figure}

\newpage

\subsection{Distribuci√≥ de tasques}
						
\begin{figure} 
\includegraphics[width=5.8in]{Grafic_aux/Tasques_final.pdf} 
\caption{Distribuci√≥ de tasques}
\end{figure}
