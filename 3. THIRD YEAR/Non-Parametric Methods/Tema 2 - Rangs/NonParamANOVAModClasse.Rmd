---
title: "NonParametricANOVA"
author: "Mireia Vilardell"
date: "21 març de 2018"
output: html_document
---
##Exercici 11 de la Llista del Jordi Ocaña
## Apartat a)
### PAS 0; Introducció de les dades


```{r}
suavitat = c(
  38.7, 41.5, 43.8, 44.5, 45.5, 46, 47.7, 58,
  39.2, 39.3, 39.7, 41.4, 41.8, 42.9, 43.3, 45.8,
  34, 35, 39, 40, 43, 43, 44, 45,
  34, 34.8, 34.8, 35.4, 37.2, 37.8, 41.2, 42.8
)

laboratori = factor(rep(c("A","B","C","D"), rep(8,4)))
#Noteu que la unitat no cal com a factor ja que son diferents entre si.
#unitat = factor(rep(1:8, 4))


```

### PAS 1; Definir el contrast hipotesis que s'està realitzant

$H_{0}: \mu_{1}=..=\mu_{4}=\mu$ 

$H_{1}:$ algun parell diferent entre si

### PAS 2; Càlcul dels rangs
```{r}
N = length(suavitat) #longitud total
N
ni = tapply(suavitat, laboratori, length) # grandaria grups
ni

rsuavitat = rank(suavitat) # calcul dels rangs com si estractes d'una sola mostra
rsuavitat
ri. = tapply(rsuavitat, laboratori, sum) # suma dels rangs per cada grup (laboratori)
ri.
```

### PAS 3; Càlcul de l'Estadístic de Test o Mesura de discrepància
```{r}

h = (12 / (N * (N + 1))) * sum((ri.^2) / ni) - 3 * (N + 1)
h

```

### PAS 4; Cal fer una correcció?
Hi ha dos tipus de correccions una pel cas d'empats i una pel cas de continuitat si no podem assumir asintóticament que les dades tenen magnituds lo suficientment grans com per poder considerar continuitat.

```{r}
ties<-summary(as.factor(rsuavitat), maxsum=1000)
ties<-ties[ties>1]
ti<-ties
ti
correc = 1 - sum(ti^3 - ti) / (N^3 - N)
hp<-h/correc
hp

```

### PAS 5; Definir la regió de rebuig;  resultat del test

```{r}
pvalor<-1-pchisq(hp, length(ni)-1)
pvalor
ChiT<-qchisq(0.95, (length(ni)-1))
ChiT
```
Noteu que la distribucio chi quadrat ja és la versió asintótica no EXACTE del test!!

### PAS 6; comparació resultats R amb els obtinguts a mà


```{r}
kruskal.test(suavitat ~ laboratori)
kruskal.test(suavitat, laboratori)

# El que hem fet anteriorment amb rangs, té el seu equivalent
# en estadística paramètrica-normal en la prova ANOVA d'un factor:
oneway.test(suavitat ~ laboratori, var.equal = TRUE)

```

Noteu si passa quelcom extrany? Quin seria el resultat que hauriem de pendre per bo? Creieu que ara ja s'hauria acabat l'exercici? que més caldria fer??


## Apartat b)
### PAS 0; Introducció de les dades


```{r}
suavitat = c(
  38.7, 41.5, 43.8, 44.5, 45.5, 46, 47.7, 58,
  39.2, 39.3, 39.7, 41.4, 41.8, 42.9, 43.3, 45.8,
  34, 35, 39, 40, 43, 43, 44, 45,
  34, 34.8, 34.8, 35.4, 37.2, 37.8, 41.2, 42.8
)

laboratori = factor(rep(c("A","B","C","D"), rep(8,4)))
#Noteu que la unitat ara es un bloc.
unitat = factor(rep(1:8, 4))


```

### PAS 1; Definir el contrast hipotesis que s'està realitzant

$H_{0}: \mu_{1}=\mu_{k}=\mu$ 

$H_{1}:$ alguna diferent

Noteu que en realitat volem testar la mateixa hipotesis nomes que ara tenim un bloc que no es el nostre objectiu d'estudi!!!

### PAS 2; Càlcul dels rangs
```{r}
n = nlevels(unitat)
s = nlevels(laboratori)

dades = matrix(suavitat, nrow = n, ncol = s)
colnames(dades) = levels(laboratori)
dades

rsuavitat = apply(dades, 1, rank)
rsuavitat
# I sumem els rangs de cada laboratori:
ri. = rowSums(rsuavitat)
ri.

```

### PAS 3; Càlcul de l'Estadístic de Test o Mesura de discrepància
```{r}

estad.q = (12 / (n * s * (s + 1))) * sum(ri.^2) - 3 * n * (s + 1)
estad.q

```

### PAS 4; Cal fer una correcció?
Hi ha dos tipus de correccions una pel cas d'empats i una pel cas de continuitat si no podem assumir asintóticament que les dades tenen magnituds lo suficientment grans com per poder considerar continuitat.

```{r}
#EN AQUEST CAS CAL CORREGIR DINS DE LES UNITATS!
ties<-function(rdades){
  ti<-summary(as.factor(rdades), maxsum=10000)
  ti<-ti[ti>1]
  ti
}
unitat.ti = apply(rsuavitat, 2, ties)
unitat.ti
correc = 1 - (1 / (n * s * (s^2 - 1))) * sum(vapply(unitat.ti, function(ti) sum(ti^3 - ti), FUN.VALUE = 0))
correc
# Valor final de l'estadístic de Friedman, corregit per empats:
estad.q / correc



```

### PAS 5; Definir la regió de rebuig;  resultat del test

```{r}
pvalor<-1-pchisq(estad.q / correc, length(ni)-1)
pvalor
ChiT<-qchisq(0.95, (length(ni)-1))
ChiT
```
Noteu que la distribucio chi quadrat ja és la versió asintótica no EXACTE del test!!

### PAS 6; comparació resultats R amb els obtinguts a mà


```{r}
# Típic disseny "en blocs aletoritzats"
# Sota un enfoc paramètric-normal ho resoldríem així:
# (Recordem:)
dades = data.frame(laboratori, unitat, suavitat)
anova(aov(suavitat ~ laboratori + unitat, data = dades))

friedman.test(suavitat, laboratori, unitat)
friedman.test(suavitat ~ laboratori | unitat)
friedman.test(suavitat ~ laboratori | unitat, data = dades)
dades
```

Noteu si passa quelcom extrany? Quin seria el resultat que hauriem de pendre per bo? Creieu que ara ja s'hauria acabat l'exercici? que més caldria fer??

```{r}

dades = matrix(suavitat, nrow = n, ncol = s)
colnames(dades) = levels(laboratori)
dades


p.vals = numeric(s * (s - 1) / 2)

nomLab = colnames(dades)

comparacio = character(length(p.vals))
k = 0
for (i in 2:s)
  for (j in 1:(i-1)) {
    k = k + 1
    comparacio[k] = paste(nomLab[i], nomLab[j], sep ="-")
    p.vals[k] = wilcox.test(dades[,i], dades[,j], paired = TRUE, correct = FALSE)$p.value
  }

names(p.vals) = comparacio
p.vals

# Ajust per multiplicitat de tests:
p.adjust(p.vals, method = "holm")
```


### Exercici 9

```{r}
peso <- c(198,186,201,190, 200,203,205,190,187, 215,187,212,190)
peso
# Creaci???n de un objeto 'localidad' que codifica la localidad de procedencia
# para cada uno de los valores anteriores:
localidad <- factor(rep(c(1,2,3), c(4,5,4)))
# (aclaraci???n: repetimos 1 cuatro veces, 2 cinco veces, 3 cuatro veces)
localidad

# C???lculos paso a paso:
n = length(peso)
n
# Rangos:
rangs = rank(peso)
rangs
# Suma de rangos dentro de cada nivel del factor:
sumRangsLoc = tapply(rangs, localidad, sum)
sumRangsLoc
# Tama???o muestral dentro de cada nivel:
nLoc = tapply(rangs, localidad, length)
nLoc

# Estad???stico H:
h = (12 / (n * (n + 1))) * sum(sumRangsLoc^2 / nLoc) - 3 * (n + 1)
h

# Pero hay empates, dos series de valores empatados, de longitudes 2 y 3.
ties = outer(rangs, unique(rangs), "==")
ties = apply(ties, 2, sum)
ties = ties[ties != 1]
# Correcci???n por empates:
#h = h / (1 - ((2^3 - 2) + (3^3 - 3)) / (n^3 - n))
h = h / (1 - sum(ties^3 - ties) / (n^3 - n))
h

# Hay que compararlo con un valor cr???tico ji-cuadrado con 3 - 1 g.d.l.:
qchisq(0.95, 2)
# o bien:
qchisq(0.95, 2, lower.tail = FALSE)

# O calcular el p-valor:
1 - pchisq(h, 2)
# o bien:
pchisq(h, 2, lower.tail = FALSE)

# C???lculo del test de Kruskal-Wallis mediante 'kruskal.test'. Variante 1:
# primer argumento de la funci???n: vector de valores num???ricos observados
# segundo argumento: vector de la misma longitud que codifica cada nivel
# del factor a estudiar
kruskal.test(peso, localidad)

```
