---
title: "Lab Session 9"
author: "Lidia Montero, Josep Anton Sanchez & Jordi Cortes"
date: "November 2018"
output:
  html_document: default
---
  
# Insurance data: baxter.RData
### Data

**_District_**: districte (1:small city - 4:big city), factor a 4 nivells.

**_Group_**: grup de cotxe (< 1 litre; 1-1.5; 1.5-2; >2 litres), factor a 4 nivells.

**_Age_**: edat (<25;25-29;30-35;>35), factor a 4 nivells.

**_Holders_**: numero assegurats

**_Claims_**: numero de queixes (variable resposta)

444= 64 possibilitats (si ens donden la bbdd agregada tindrem com a mxim 64 registres, com a mxim perqu es possible que no es donin totes ls combinacions).

Els holders, tot i que tamb es un recompte, no s la variable resposta, sin que, al tractar-se de dades agrupades necessitem incloure l'offset.

Dades agrupades: el n de reclamacions resulta de sumar el nmero de reclamacions, necessitem ajustar per el numero de holders(offset) per podem avaluar si existeix algun del factors que fa que hi hagi ms queixes que un altre o no. Per exemple, podriem veure que hi ha mes queixes en un disctricte per amb el holder podriem mirar si en aquell districte hi ha ms poblaci que en la resta i poder decidir si el nombre de queixes alt ve donat per una alta poblaci, o si pel contrari, s un factor significatiu.

**Notaci pel nostre cas:**

$$Y_i|X_i^{(1)},X_i^{(2)},X_i^{(3)} \sim Pois(\lambda_i)$$
$$ g(\lambda_i)=X\beta$$

$$log(\lambda_i) =log(H_i) + \beta_0 + \alpha_i^{(1)}+ \alpha_i^{(2)}+ \alpha_i^{(3)}$$
on $log(H_i)$ s l'offset.

# Inicialitzaci

### Carregar paquets i dades Insurance del paquet MASS

```{r warning=FALSE,message=FALSE}
# install.packages("MASS")
# install.packages("car")
# install.packages("AER")
options(warn = -1)
library(MASS,warn.conflicts = FALSE,quietly = TRUE)              # Insurance; glm.nb
library(car,warn.conflicts = FALSE,quietly = TRUE)               # Anova
library(AER,warn.conflicts = FALSE,quietly = TRUE)               # dispersion.test

data(Insurance)                                                  # data in package MASS
df <- data.frame(Insurance , logtamany=log(Insurance$Holders))   # logtamany --> offset
```

**Sol: Hem afegit la variable _log(grandaria)_ a les dades ja que far les funcions d'_offset_**

### Descriptiva
```{r}
summary(Insurance)
```

# Model Poisson

```{r}
options(contrasts=c("contr.treatment","contr.treatment"))    # Evitar explicatives ordinals, a les variables ordinals les mantenim aix per farem igual un tipo baseline on la categoria base ser la primera (igual que les variables vategriques nominals)
mod.poisson <- glm(Claims ~ offset(logtamany) + District + Group + Age, family=poisson, data=df)
summary(mod.poisson)
```

**Comentaris del summary**

Z value pequ en aquest cas assumim asintticament que els coeficiets segueixen una normal, llavors si el z value es superior a 1.96 (el p valor ser 0.05) veurem que surtir el coeficient com a significatiu.

Model que suposa $\phi = 1$, recordar que aix s restrictiu.(lab8)

Si fem l'exponencial de -1.8, obtindrem el valor esperat de queixes si l'individu s menor que 25 anys, est en el Districte 1 i est en el grup de cotxe <1. (categories base)

Districtes 2 i 3, respecte el 1 (!!), no suposen cap diferncia en el nombre de queixes esperat. Entre els Districtes 2 i 3 no ho sabem i en canvi, entre els districtes 1 i 4 veiem que si hi ha diferncies: la taxa del districte 4 es superior a la del Districte 1.

*ATENCI!*

Pel que fa a la potncia del cotxe, els coeficients posen en manifest que el fet d'incrementar la potncia fa augmentar el nombre de queixes (coeficients ms gran cada cop). En canvi, pel grup d'edat passa a l'inversa (mirar coeficients).

Nombre de reclamacions ms alt: jove conduint un cotxe amb molte potencia per Londres (Districte 4).

*S UN BON MODEL? REFLECTEIX B LA INFORMACI DE LES DADES?*

Cal mirar la deviana i els graus de llibertat.

Deviana residual nulla: deviana mxima que s la que tenim quan hi ha noms l'intercept.

Quan la deviana s molt ms gran que els graus de llibertat, ens far rebutjar la hiptesis nulla de que el model reflecteix b la informaci de les dades. Aix, vegem que el model noms amb l'intercept no s un bon model i que, al haver introduit l'offset amb els 3 factors, sha redut la deviana fins a arribar estar per sota dels graus de llibertat i confirmem que el model s b, s correcte i l'acceptem.


**Sol: Tots els efectes tenen una categoria significativa. Anem a calcular els efectes nets de cada variable**

### Efectes nets
```{r}
Anova(mod.poisson)
```

Aquests sn els resultats que ens permeten confirmar que les variables sn importants en el model i que cal deixarles.


**Sol: Totes les variables tenen un efecte net significatiu**

# Validacio

### Validacio grafica
```{r}
par(mfrow=c(2,2))
plot(mod.poisson)
```


Estem vegent els residus de deviana.

Residus estandaritzats (de Pearson) en el cas de la Poisson.
$$r_i= \frac{Y_i - \lambda_i}{ \sqrt{\lambda_i}}$$

En dades agrupades, quan ms agrupades, ms fcil de poder validar el model. En 1 vegem residus al voltant de 0, en 2 que els residus son normals, en 3 considerem que es prcticament constant (pequ al comenament n'hi ha pocs i pot ser per aix et una mica ms amunt) i en 4 igual. Validem el model.


**Sol: No s'observa cap patr en els grfics de residus --> Validem el model**

### Validacio: deviana i Pearson

```{r}
# Per deviana
1 - pchisq(mod.poisson$deviance,mod.poisson$df.residual)
```

No tenim motius per rebutjar la hiptesis nulla de que el model ajusta b les dades.

```{r}
# Pearson generalitzat
X2P <- sum(resid(mod.poisson,type="pearson")^2);X2P
1 - pchisq(X2P,mod.poisson$df.residual)
```

- Estadstic: 48.62
- Deviana residual era 51.42

Molt similars, pvalor superior a 0.05 (igual q abans), model b.

**Sol: Els p-valors surten superiors a 0.05. Usant Dev o X2P no tinc evidncia per rebutjar la hipotesi nula: el model ajusta b les dades. Pero cal que amplii el model? Busco si alguna parella d'interaccions s significativa**



### Interaccions

Mirem si el fet d'introduir interaccions millorem encara mes el model.

```{r}
mod.poisson1 <- glm(Claims ~ offset(logtamany) + District*Group + Age, family=poisson, data=df)
mod.poisson2 <- glm(Claims ~ offset(logtamany) + District + Group*Age, family=poisson, data=df)
mod.poisson3 <- glm(Claims ~ offset(logtamany) + District*Age + Group, family=poisson, data=df)

Anova(mod.poisson1)
Anova(mod.poisson2)
Anova(mod.poisson3) # igual anova(mod.poisson, mod.poisson3, test="Chisq"), noms en models en els qe XXX.
```


Cap de les interaccins per s sola ens resulta significativa, no ens millora el model. 

Tenim en compte que al introduir les interaccions gastem 9 graus de llibertat per en cap cas ens redueix la deviana lo suficient com per millorar el model anterior.


**Sol: El model additiu ja sembla prou bo. Cap interaccio surt significativa. Anem a avaluar la sobredispersio**

### Sobredispersio

Com es diagnostica?

1. Estimar parmetre de sobredispersio $\phi$.

```{r}
# Estimar parmetre de sobredispersio
X2P <- sum(resid(mod.poisson,type="pearson")^2)
phi <- X2P/mod.poisson$df.residual
phi
```


El estadstic de Pearson era 48.62, els graus de llibertat eren 54, per tant un estimaci de $\phi$ ser 48.62/54, que es el 0.90 que obtenim amb R.

Al ser inferior a 1, hi ha infradisperssi, la seva varincia s ms petita del que tocaria. 

(pensar en grafica amb eix x com a lambda_i i phi al l'eix y)

2. Proposa com a alternativa al Poission, el model Quasipoisson.

trafo=1: quasipoisson!

$$E(Y|X) = \lambda$$
$$V(Y|X)= (1+\alpha)\lambda$$
El test de sobredispersi que farem contrasta:

$$H_0:\alpha=0 \rightarrow POISSON$$
$$H_1: \alpha>0 \rightarrow SOBREDISPERSSI$$

```{r}
# Test formal per dependencia lineal amb esperanza
dispersiontest(mod.poisson, trafo = 1)  # V(Y)=(1+alpha)*mu^2 -> Y Quasi-poisson
```

Estima una $\alpha$ = 0.22
Estem mirant si la distribuci Poisson s restrictiva en questes dades.

No ens interessa, no s una probaiilitat. Sempre conv fer igualment una Binomial Negativa, que em fa una bona estimai de alfa.

```{r}
# Test formal per dependencia quadratica amb esperanza
dispersiontest(mod.poisson, trafo = 2)  # V(Y)=mu+alpha*mu^2 -> Y Bin Neg
```

**Sol: No hi ha sobredispersi. Poisson funciona b. No obstant, estimem binomial negativa per verificar-ho.**

# Binomial negativa

Quantes fallides per aconseguir r encerts?
trafo=2 $\rightarrow BN(\lambda,\alpha)$
$$E(Y|X) = \lambda$$
$$V(Y|X)= \lambda+\alpha\lambda^2$$

Alfa sempre ser positiva. Per tant la BN noms serveix per tracar la sobredispersi. Tot i aix, ho aplicarem.

```{r}
# Estimaci theta glm.nb()
mod.nb <- glm.nb(Claims ~ offset(logtamany) + District + Group + Age, data=df)  
summary(mod.nb)
# theta = 1/alpha = 449932  tendeix a infinit -> consistent Poisson
```

Primer necessitem el valor de la alfa, per despres pod fer glm() amb famili= binomial negativa de alfa.

El valor que volem es l'invsers del que ens apareix a:*Theta:  449934*

Quan aquest valor s molt alt, s que el que tinc realment s una Poisson. (alfa petita)

```{r}
# Amb theta per bn -> puc usar metode generic glm()
mod.nb1 <- glm(Claims ~ offset(logtamany) + District + Group + Age, family=neg.bin(449932),data=df)  
summary(mod.nb1)
```

```{r}
# Comparacio amb Poisson
anova(mod.poisson, mod.nb1, test="LRT")  
```

**Sol: deviances practicament identiques ente Poisson i binomial negativa (p-valor no es estimable--> mateix numero de parametres)**

# Interpretacio coeficients en model de Poisson
```{r}
co <- cbind(coef(mod.poisson),confint(mod.poisson))
round(exp(co),2)
```

1.26: un 26% d'increment.

0.83: reduccio 83% de la taxa.

**Sol: La taxa de mitjana de sinistres per vehicle en la poblacio formada per les categories de referencia (Districte 1, Vehicle < 1l, Joves) es 0.16. Ser del districte 4 incrementa la taxa mitjana de queixes 1.26 (IC95%, de 1.12 a 1.42) respecte al districte 1 (sembla lgic ja que en les ciutats grans hi ha ms cotxes). Els vehicles grans (>2l) tenen una taxa mitjana de sinistres 1.76 (IC95%: 1.52 a 2.02) superior als cotxes petits (<1l). Els ms joves (<25) tenen una taxa mitjana de sinistres 1.72 (=1/0.58, IC95%: de 0.49 a 1.96) superior als conductors ms grans (>35)**