---
title: "Lab Session 28Nov2017 - 3"
output:
  html_document: default
---

# Berkeley admissions: UCBAdmissions (R data)
### Data

**_Admit_**: yes/no

**_Gender_**: yes/no

**_Dept_**: A-F

# Inicialitzacio

### Carregar dades i paquets
```{r}
options(warn = -1)
install.packages('vcd')
library(vcd)       # To test the odds-ratios in the marginal table and each of the subtables
data(UCBAdmissions)
```

**Sol: Hem carregat les dades**


### Visualitzar la taula
```{r}
UCBAdmissions
ftable(UCBAdmissions, row.vars = c("Dept","Gender"))
addmargins(UCBAdmissions)
```

**Sol: Hem visualitzat la taula en diferents formats**

### Inspeccionar alguna relació --> Paradoxa de Simpson
```{r}
t <- apply(UCBAdmissions,c(1,2),sum)
t
prop.table(t,2)
prop.table(UCBAdmissions, margin = c(2,3))
```

**Sol: Aqui tenim un exemple de la paradoxa de Simpson. En l'analisi agregat, les dones son més rebutjades que els homes, malgrat que quan estratifiquem per departaments, no es veu aquesta relacio** 


### Transformar dades a data.frame
```{r}
UCB.df <- as.data.frame(as.table(UCBAdmissions))
UCB.df[,1] <- relevel(UCB.df[,1], ref = "Rejected")
UCB.df[,2] <- relevel(UCB.df[,2], ref = "Male")
UCB.df[,3] <- factor(UCB.df[,3])
UCB.df
```

**Sol: posem les referencies que ens interessen per interpretar millor**

# Hipotesi: Independencia total

**H0: pi_ijk = pi_i x pi_j x pi_k <--> Independència Total**

### Model

```{r}
mod0 <- glm(Freq ~ Admit + Gender + Dept,data = UCB.df, family = poisson)
summary(mod0)
# Goodness of fit
qchisq(0.95,mod0$df.residual)            # punt critic
mod0$deviance                            # deviança

1-pchisq(mod0$deviance,mod0$df.residual) # p-valor
```

**Sol: Es rebutja H0 de independencia total ja que obtenim un p-valor per contrastar la validesa del model proper a zero i una deviança residual (2098) molt per sobre del punt crític (26.3). Hem de testar la independencia per blocs**

### Comparem valors predits i observats
```{r}
cbind(mod0$data, fitted(mod0))
```
**Sol: Confirmem que no és un gran ajust ja que difereixen molt**

### Interpretacio dels coeficients
```{r}
exp(coef(mod0)['GenderFemale'])
pt <- with(UCB.df,tapply(Freq,Gender,sum))
pt[2]/pt[1]
```

**Sol: Aquesta és la odd de ser dona a la mostra (per cada home, hi ha 0.68 dones en aquesta universitat)**


# Hipotesi: Independencia per blocs (1 parella d'interaccions)

**A) Y ~ B + AxC**

```{r}
# a) HO: pi_ijk=pi_j x pi_ik
mod1a <- glm(Freq ~ Admit*Dept + Gender,data = UCB.df, family = poisson)
summary(mod1a)
# GoF: Dev prou petita 
1-pchisq(mod1a$deviance,mod1a$df.residual)
```

**Sol: Rebutjo H0 de independencia per blocs de genere**


**B) Y ~ A + BxC**

```{r}
# b) HO: pi_ijk=pi_i x pi_jk  B) Y-A+B*C
mod1b <- glm(Freq ~ Admit + Gender*Dept,data = UCB.df, family = poisson)
summary(mod1b)
# GoF: Dev prou petita 
1-pchisq(mod1b$deviance,mod1b$df.residual)
```

**Sol: Rebutjo H0 de independencia per blocs de admesos/no admesos**


**C) Y ~ C + AxB**

```{r}
# c) HO: pi_ijk=pi_k x pi_ij  C) Y-C+A*B
mod1c <- glm(Freq ~ Admit*Gender + Dept,data = UCB.df, family = poisson)
summary(mod1c)
# GoF: Dev prou petita 
1-pchisq(mod1c$deviance,mod1c$df.residual)
```

**Sol: Rebutjo H0 de independencia per blocs de Departament**


# Hipotesi: Independencia Parcial (2 parelles d'interaccions)

**A) Y ~ BxC + AxC**
```{r}
# H0: pi_ijk = p_ik x pi_jk
mod2a<-glm(Freq~(Gender+Admit)*Dept,family=poisson,data=UCB.df )
summary(mod2a)
# GoF: Dev prou petita 
1-pchisq(mod2a$deviance,mod2a$df.residual)
```

**Sol: Rebutjo H0 de independencia parcial mediada pel Departament**


**B) Y ~ BxA + CxA**
```{r}
# H0: pi_ijk = p_ij x pi_ik  B) Y-B*A+C*A
mod2b<-glm(Freq~(Gender+Dept)*Admit,family=poisson,data=UCB.df )
summary(mod2b)
# GoF: Dev prou petita 
1-pchisq(mod2b$deviance,mod2b$df.residual)
```

**Sol: Rebutjo H0 de independencia parcial mediada per l'admissio**


**C) Y ~ AxB + CxB**
```{r}
# H0: pi_ijk = p_ij x pi_jk  C) Y-A*B+C*B
mod2c<-glm(Freq~(Admit+Dept)*Gender,family=poisson,data=UCB.df )
summary(mod2c)
# GoF: Dev prou petita 
1-pchisq(mod2c$deviance,mod2c$df.residual)
```

**Sol: Rebutjo H0 de independencia parcial mediada pel genere**


# Hipotesi: Associacio Uniforme (3 interaccions dobles)

```{r}
mod3 <- glm(Freq ~ Admit*Gender + Admit*Dept + Dept*Gender, family=poisson, data=UCB.df )
summary(mod3)
# GoF: Dev prou petita 
1-pchisq(mod3$deviance,mod3$df.residual)
```

**Sol: Rebutjo H0 -> El model encara no és consistent amb l'associacio uniforme**

### Comparem valors predits i observats
```{r}
cbind(mod3$data, fitted(mod3))
```

### Residus
```{r}
resids <- residuals(mod3,type="pearson")
h <- lm.influence(mod3)$hat
adjresids <- resids/sqrt(1-h)
cbind(UCB.df,round(fitted(mod3)),round(adjresids,2))
```

**Sol: El departament A queda mal predit amb aquest model**

# Model saturat

```{r}
summary(mod4 <- glm(Freq ~ Admit*Gender*Dept, family=poisson, data=UCB.df ))
```

**Sol: Amb 24 paràmetres som capaços d'explicar completament la taula de contingencia de 24 valors**

### Comparar model saturat amb el d'associació uniforme
```{r}
anova(mod3,mod4,test='Chi')
```

**Sol: Necessitem el model saturat per explicar la relacio entre aquestes 3 variables**


# Alternative to glm: loglin()

```{r}
berk.ind <- loglin(UCBAdmissions, list(1,2,3), fit=TRUE, param=TRUE)
berk.ind
1 - pchisq(berk.ind$lrt, berk.ind$df)

berk.sat<-loglin(UCBAdmissions, list(c(1,2,3)), fit=TRUE, param=TRUE)
berk.sat
1 - pchisq(berk.sat$lrt, berk.sat$df)
```

