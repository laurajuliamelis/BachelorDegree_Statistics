---
title: "Lab Session 5"
author: "Lidia Montero, Josep Anton Sanchez & Jordi Cortes"
date: "October 2018"
output:
  html_document: default
---
v.resposta PRES: Yi=0 1-pi no ha votat, 1 pi ha votat
      Yi|Xi dist Bern(pi)
      pi=E(Yi|Xi)
      V(Yi|Xi)=pi(1-pi)
      g(pi)=log(pi/(1-pi))
      
la variable party està separada. p=convenciment, arty=característca que segueix

## Prepare Dataset and load packages

```{r, warning=FALSE, message=FALSE}
load("Eleccions_92.RData")
options(contrasts=c("contr.treatment","contr.treatment"))
library(car)
library(MASS)
#library(AER) no es farà servir
library(effects)
library(lmtest)
library(FactoMineR)
library(rms)
library(fmsb)
library(ROCR)
library(AUC)
```

# Define response variable (pres) and factors properly. 

New variables will be created: they will be use further.

```{r}
### Punt 1
summary(elecc92)

elecc92$inter<-factor(elecc92$inter,levels=c("none","some","high"))
elecc92$close<-factor(elecc92$close,labels=c("Close-No","Close-Yes"))
elecc92$sat<-factor(elecc92$sat,labels=c("Sat-No","Sat-Yes"))
elecc92$vota<-factor(elecc92$pres,labels=c("Pres-No","Pres-Yes")) #nova variable
elecc92$c.age <- cut(elecc92$age,breaks=c(16,29,39,59,91)) #categortizem les numeriques
elecc92$ones <- rep(1,length(elecc92$pres))
elecc92$c.edu <- cut(elecc92$educ,breaks=c(-1,11,12,15,17)) #categortizem les numeriques
#-1 en comtes de 0 per garantir que agafem tots els valors
elecc92$p <- factor(elecc92$p,levels=c('ind','weak','strong'))

elecc92$id <- NULL # Not use

summary(elecc92)
```

# Point 1: Exploratory Data Analysis

Categories are reasonably well balanced
Quina és la millora manera de introduir l'edat en el model?

```{r, fig.height=3.5}
par(mfrow=c(1,2),las=2)
barplot(table(elecc92$c.age))
barplot(table(elecc92$c.edu))
```
Cap categoría queda infrarrepresentada.

```{r, fig.height=5}
par(mfrow=c(1,2),las=1)
Boxplot(age~pres,data=elecc92,col=c(2,3))
Boxplot(educ~pres,data=elecc92,col=c(2,3))

#vota categorica, pres numèrica
par(mfrow=c(3,2),las=1)
plot(vota~inter,data=elecc92,col=c(2,3))
plot(vota~close,data=elecc92,col=c(2,3))
plot(vota~sat,data=elecc92,col=c(2,3))
plot(vota~inter,data=elecc92,col=c(2,3))
plot(vota~c.age,data=elecc92,col=c(2,3))
plot(vota~c.edu,data=elecc92,col=c(2,3))
```
Boxplots per representar la variable resposta en front age i educació. Veiem si la dist és diferent per no que per sí. Si en el boxplot es veuen diferencies voldra dir que la variable age o educ serian significatives (almenys en el cas que fossin les úniques variables explicatives en el model).
En el cas de l'edat no està massa clar. Pot ser que els joves tinguin més tendència a abtenir-se.
En el cas de l'educació es veuen més diferències. Els que tenen més anys d'educació tenen més tendencia a votar.

El mossaic plot possa en el eix vertical la var resposta i en el horitzontal les diferent categries de les variable categoriques. Verd els que voten, vermell els que no voten. si les distribucions en cada columna són diferents, la variable serà significativa de forma marginal.
Mossaic plot per interes, veiem diferencies. Sembla que l'interes té que veure amb si vota o no.

# Feature Selection

```{r}
summary(elecc92)
catdes(elecc92,9)  # 9 is the index of variable vota, library(FactoMineR) --> catdes=descriptiva d'una categòrica
#Test Chi-quadrat per variable resposta (vota) enfront cada var categorica
#Ordenació per p-valor=> la var que més explica és l'interés (ens dona l'importancia marginal de les variables (o una o l'altra))
```
PER LES VARIABLES CATEGORIQUES
                 Cla/Mod  
inter=none      58.62069 -> el 58% dels que no tenen interés no voten
Les caracteristiques que tenen un v.test positiu són dominants

Els que no voten tendeixen a no tenir interes, pocs anys d'educació, partit independent...
Surt el que és raonable
Els que sí que voten tenent alt interés

PER LES VARIABLES NUMÈRIQUES
test de comparació de mitjanes
Els que no voten tendeixen a ser més joves que el col·lectiu

\pagebreak

# Point 2: Aggregated vs Desaggregated data for binary response models

Quan tenim variables numèriques és difícil tenir les dades agregades.
Dades agregades: per cada possible combinació quants casos hi ha

###Disaggregated data

```{r}
m1 <- glm(pres~age,data=elecc92,family=binomial) #age numèrica
# Yi|Xi dist Bern(pi), log(pi/(1-pi))=beta0+beta1*AGEi, pi=exp(beta0+beta1AGEi)/(1+exp(beta0+beta1AGEi))
summary(m1)

par(mfrow=c(2,2))
plot(m1)
```
El fet d'afegir beta1 fa disminuir la deviança.
Quan intentem validar el model tindrem problemes perquè els plots no ens permeten validar que hi hagi normalitat, linealitat, independencia...

###Function to create an aggregated dataset using classes defined by age

Considerant la variable edat com a entera (quants hi ha de 17 i quants voten, quants hi ha de 18 i quants voten,...)
Per cada edat tindrem quants han votat i quants no
```{r,echo=FALSE}
# Codi de la rutina
agregacio <- function(dfin,nve,formula1, formula2){
# Exemple crida: dfage <- agregacio(elecc92,1,as.formula(uns~age),as.formula(pres~age))
# Retorna dataframe: dfage amb age, m, ypos, yneg. 
#
# Formula1 ha de ser uns~var1+...+var_nve
# Formula2 ha de ser resposta~var1+...+var_nve.Resposta ha de ser num?rica.
# Requereix que dfin,data.frame d'entrada contingui una columna amb uns
# Retorna: dfout, data.frame amb var1 , ..., var_nve, m, ypos, yneg.
# Valid per nve arbitrari > 0

taulam <- xtabs(formula1,exclude=NULL,dfin,drop.unused.levels=TRUE);
taulap <- xtabs(formula2,exclude=NULL,dfin,drop.unused.levels=TRUE);

dfout <- as.data.frame(taulam);
dfaux <- as.data.frame(taulap);

names(dfout)[nve+1] <- "m";
names(dfaux)[nve+1] <- "ypos";
attach(dfaux);
dfout <- data.frame(dfout,ypos);
dfout$m <- as.integer(dfout$m)
dfout$yneg <- as.integer(dfout$m-dfout$ypos);
attach(dfout);
dfout <- dfout[m>0,]
}
```

# Aggregated data

In this case, it is possible to aggregate by a continous variable because it is discretized and the sample size is big enough

```{r}
dfage <-agregacio(elecc92,1,as.formula(ones~age),as.formula(pres~age))
summary(dfage)
dfage$age<-as.numeric(levels(dfage$age))[dfage$age]
head(dfage)
summary(dfage)
```

In the model, the coefficients are the same that those ones with dissagragated data, but not the deviance and degrees of freedom.

```{r}
m1a <- glm(cbind(ypos,yneg)~age,data=dfage,family=binomial)
summary(m1a)
par(mfrow=c(2,2))
plot(m1a) #al ser dades agregades ja no és un 0,1 sino tenim la prob (Binomial), i podem interpretar
#La validació es pot realitzar desde el punt de vista dels residus de Pearson
#1r grafic: la linealitat falla --> següent pas: mirar polinomis o categoritzar
```
Els coeficients han sortit exactament igual per les dades desagregades que per les agregades. El que canvia es la deviança.

La Deviança Residual, sota H0, segueix una dist Chi-quadrat amb 73 gr.ll. Busquem el p-valor per determinar si el model és satisfactori.

# Goodness of fit

When disaggregated data is used then $m_i = 1$ and asymptotic theory does not apply, as a rule of thumb at a fully disaggregated level for data, a model is good if Deviance or Pearson $\chi^2$ statistics are similar to degrees of freedom of the model. Large values indicate a lack of fit of the model.

```{r}
1-pchisq(m1a$dev,m1a$df.res)  # Aggregated data model
m1a$dev;m1a$df.res              # Disaggregated data
```
En el mnoment en el que la deviaça residual s'apropa als gr.ll podem dir que el model és bo. Si és més gran, l'allunya de la moda i rebutgem que el model sigui valid.


# Interpretation

The exponential of the coefficient represents the OR on the positive response for a 1-year increase.


*Escala del logODDS es com si fos una interpretació lineal classica

```{r}
# Interpretacio efecte age en m1
exp(coef(m1)['age'])      # Increment 1 any respecte any anterior
exp(10*coef(m1)['age'])   # Increment 10 anys respecte any partida
```


Let's check the fit using a manual plot and also residual analysis methods available in package car 

By hand:

```{r}
par(mfrow=c(1,1))
dfage$olog <- log((dfage$ypos+0.5)/(dfage$yneg+0.5))    # logodds
plot(dfage$age,dfage$olog,pch=19)                       # points
points(dfage$age,m1a$linear.predictor,col=2,lwd=1.5)    # Linear relationship
lines(lowess(dfage$age,dfage$olog,f=0.5),col=3)         # high smooth        
lines(lowess(dfage$age,dfage$olog,f=0.75),col=4,lwd=2)  # medium smooth        
lines(lowess(dfage$age,dfage$olog,f=1.0),col=5)         # low smooth        
```
Línea vermella (predictor lineal) no està explicant correctament aquesta relació.
Verd=ajust suau.
Amb auqestes finestres d'amplades cada cop més gran ens anem ajustant més a la linealitat.

Package car:

```{r}
scatterplot(olog~age,dfage,col=1,regLine=list(col=4),smooth=list(col.smooth=3,col.var=3))
```
si la verda i la blava fossin la mateixa m'estaria dient que hi ha relació lineal

Effects

```{r}
plot(allEffects(m1),ask=FALSE)
```
Representació sobre el efecte que té sobre el predictor lineal

```{r warning=FALSE}
residualPlots(m1a, layout=c(1, 2))
marginalModelPlots(m1a,id=list(method=abs(cooks.distance(m1)),n=5)) 
```
S'observa que hi ha una cobertura, que aquí no hi ha linealitat

\pagebreak

# Point 3: Exercicis

3.	Ajusteu un model de regressió logística amb predictor lineal els termes d'ordre 1 i 2 de l'EDAT (Models  M1-2, M1-3, variants de M1) (els ordres no lineals obteniu-los sempre respecte la tendència central de la variable o empreu la comanda poly(EDAT,k)). 

Dos metodes: amb la funcio $I$ o amb la funcio $poly$. Es centra per a que tingui sentit el valor nul.

I((age-42)^2) --> terme quadratic de l'edat centrada en el 42
I((age-42)^3) --> terme cúbic de l'edat centrada en el 42


```{r}
m1.1 <-  glm(pres ~ age, data=elecc92,family=binomial)
m1.2 <-  glm(pres ~ age + I((age-42)^2), data=elecc92,family=binomial)
m1.3 <-  glm(pres ~ age + I((age-42)^2) + I((age-42)^3), data=elecc92,family=binomial)
m1.2p <- glm(pres ~ poly(age,2,raw=TRUE),data=elecc92,family=binomial)
m1.3p <- glm(pres ~ poly(age,3),data=elecc92,family=binomial)
```

a.	Contrasteu formalment la significació del terme d'ordre 3 de l'edat: segons l'estadístic de Wald i segons el contrast de la deviança.

```{r}
summary(m1.3)
```
No cal terme cúbic.


m1.2, m1.3 models gerarquitzats
```{r}
anova(m1.2,m1.3,test="Chisq")              # Deviance
anova(m1.2p,m1.3p,test="Chisq")            # Deviance --> Equivalent to previous


waldtest(m1.2,m1.3,test="Chisq")           # Wald
linearHypothesis(m1.3p,"poly(age, 3)3=0")  # Wald --> Equivalent to previous
```
He reduit un 0.023 la deviança.

b.	Contrasteu formalment la significació del terme d'ordre 2 de l'edat: segons l'estadístic de Wald i segons el contrast de la deviança. 
```{r}
anova(m1,m1.2,test="Chisq")      # Deviance
waldtest(m1,m1.2,test="Chisq")   # Wald
```
Introduint el terme quadràtic aconsegueixo disminuir la deviança residual significativament (en 30unitats).

c.	Useu sobre el conjunt de dades desagregat la comanda: marginalModelPlots() en m1 i model triat.
```{r warnings=FALSE}
plot(allEffects(m1.2p),ask=FALSE)

par(mfrow=c(2,2))
marginalModelPlots(m1.2p,id=list(method=abs(cooks.distance(m1.2p)),n=5)) 
avPlots(m1.2p,id=list(method=abs(cooks.distance(m1.2p)),n=5))
summary(m1.2p)
```

d.	Feu una diagnosi estàndard del model desagregat triat (m1): residualPlots()
```{r}
residualPlots(m1.2p, layout=c(1, 2))
```

4.	Considereu l'agrupació de l'EDAT en categories <30, 30-39, 40-59, 60+. Diem-li Model (M2).  Tornarem a calcular el model m2 amb dades desagregades (i si en teniu ganes m2a amb dades agregades).
a.	Feu una diagnosi estàndard del model desagregat (m2c): residualPlots(m2c)
b.	Representeu el logits empírics/ajustats en funció de l'EDAT Categoritzada en les dades agregades (diagnosi artesanal). Pistes: Us ho podeu estalviar examinant atentament el sumari del model agregat m2a.
```{r warnings=FALSE}
m1c <- glm(pres~c.age,data=elecc92,family=binomial)
summary(m1c)
exp(coef(m1c)['c.age(39,59]'])          # OR for this category in respect to reference
residualPlots(m1c , layout=c(1, 2))
marginalModelPlots(m1c,id=list(method=abs(cooks.distance(m1c)),n=5)) 
```

5.	Quin tractament us sembla més adient per la variable EDAT: com a covariable (fins a quin terme d'ordre) o com a factor. Justifiqueu estadísticament la resposta.

No són niuats el model, per tant no podem usar la deviança.

```{r}
AIC(m1,m1.2p,m1c)
BIC(m1,m1.2p,m1c)
```
6.	Ara estudiarem la introducció de la variable EDUCACIÓ en el model que ja conté l'EDAT (en el seu millor tractament). Per començar es treballarà amb l'EDUCACIÓ com a covariant.
a.	Afegiu un terme lineal d'EDUCACIÓ en el millor model anterior amb l'EDAT.

```{r}
m3n.1  <- glm(pres ~ poly(age,2) + educ,data=elecc92,family=binomial)
summary(m3n.1)
```

b.	Interpreteu el coeficient estimat en termes dels logodds, odds i probabilitats. 
```{r}
b_edu <- coef(m3n.1)['educ']  # Increment en logodd
exp(coef(m3n.1)['educ'])      # Increment en odds --> OR
```


c.	Contrasteu la hipòtesi que l'efecte de EDUCACIÓ és lineal mitjançant la introducció d'un terme d'ordre 2 en el model. I el terme d'ordre 3, és significatiu? Pareu a l'ordre 3.

```{r}
m3n.2  <- glm(pres ~ poly(age,2) + poly(educ,2),data=elecc92,family=binomial)
m3n.3  <- glm(pres ~ poly(age,2) + poly(educ,3),data=elecc92,family=binomial)

anova(m3n.1,m3n.2,test="Chisq")
anova(m3n.2,m3n.3,test="Chisq")
```

d.	Trieu el millor model que empra l'EDAT i la covariant EDUCACIÓ: li direm (m3n). No cal treballar amb la versió agregada tret que vulgueu fer diagnosi artesanal.

```{r}
m3n <- m3n.3
```

e.	Useu les eines standard d'anàlisi de residus: marginalModelPlots() i residualPlots().
```{r warnings=FALSE}
residualPlots(m3n , layout=c(1, 3))
marginalModelPlots(m3n,labels=row.names(elecc92),id.method=abs(cooks.distance(m3n)), id.n=5) 
```

7.	Considereu una agrupació dels anys d'educació (EDUCACIÓ Categoritzada) en 4 grups: <12, 12, 13-15, 16+. Estimeu el model de regressió logística amb els termes i tractament adient de  l'edat i el factor EDUCACIÓ. Quina és la millor manera de tractar els anys d'educació? Li direm (M4).
i.	Assageu rectes amb pendents idèntics per cada categoría d'EDUCACIO
ii.	Assageu rectes amb pendents diferents per cada categoría d'EDUCACIO
iii.	Assageu paràboles amb idèntica corbatura per cada categoría d'EDUCACIO 
iv.	Assageu paràboles amb diferent corbatura per cada categoría d'EDUCACIO
v.	Estrictament per inferència, quin us sembla el tractament més apropiat.
```{r}
m4.1  <-glm(pres ~ age + c.edu, data=elecc92,family=binomial)
m4.2  <-glm(pres ~ age * c.edu, data=elecc92,family=binomial)
m4.3  <-glm(pres ~ poly(age,2) + c.edu,data=elecc92,family=binomial)
m4.4  <-glm(pres ~ poly(age,2) * c.edu,data=elecc92,family=binomial)


anova(m4.1,m4.2,test="Chisq")
anova(m4.2,m4.3,test="Chisq")
anova(m4.3,m4.4,test="Chisq")
```

Effects

```{r}
plot(allEffects(m4.4),ask=FALSE)
```

```{r warnings=FALSE}
residualPlots(m4.4 , layout=c(1, 3))
marginalModelPlots(m4.4,id=list(method=abs(cooks.distance(m4.4)),n=5)) 
scatterplot(log((pres+0.05)/(1-pres+0.05))~age|c.edu,smooth=TRUE,data=elecc92)
```





8.	Quina és la millor manera de tractar els anys d'educació, un cop l'EDAT ja ha estat incorporada en el model?
Comparing models by AIC and BIC

```{r warnings=FALSE}
BIC(m4.1,m4.2,m4.3,m4.4)
AIC(m4.1,m4.2,m4.3,m4.4)
```


# Interpretation of two models

```{r warnings=FALSE}
summary(m4.3)
summary(m4.4)
```

9.	Afegir al model les preferències partidistes. Analitzar els coeficients estimats i suggerir com es podria recodificar aquesta variable per simplificar la interpretació del model i estalviar un quants graus de llibertat (heu de veure que amb màxim 3 categories és suficient). Reajustar el model i reinterpretar els coeficients de la variable codificada.

Crear nova variable:

```{r}
elecc92$party <- as.factor(paste(elecc92$p,elecc92$arty))
summary(elecc92)
```

```{r}
m6.1 <- glm(pres ~ poly(age,2)*c.edu + party, family=binomial, data=elecc92)
summary(m6.1)

# Agrupacio de categories
partit <- rep("weak",length(elecc92$party))
partit[elecc92$party=="strong rep" | elecc92$party=="strong dem"] <- "strong"
partit[elecc92$party=="ind ind"] <- "ind"
partit <- factor(partit,levels=c("ind","weak","strong"))

elecc92 <- data.frame(elecc92,partit)

m6.2 <- glm(pres ~ poly(age,2)*c.edu + partit, family=binomial, data=elecc92)
summary(m6.2)

anova(m6.2,m6.1,test="Chisq")

plot(allEffects(m6.2),ask=FALSE)
m6 <- m6.2
```

10.	Introduïu la variable 'grau d'interès' en les eleccions en el model. Contrasteu la significació del seu efecte principal emprant: test de Wald (si es paquet estadístic us ho permet) i el test de la deviança. Afirmaríeu que la principal raó per la que la gent jove vota menys és que no estan interessats en les eleccions?

```{r}
```

11.	Introduïu en el model un terme d'interacció entre el 'grau d'interès' i les 'preferències partidistes'. Contrasteu la significació de la interacció mitjançant el test de deviança. Expliqueu detalladament, si hi ho trobeu evidència, com funciona la interacció.

```{r}
```

12.	Hi ha alguna evidència que, després d'introduir el factor de 'proximitat entre els candidats' en el model TREBALLAT FINS EL MOMENT (EDAT, EDUCACIO, PREFERÈNCIES PARTIDISTES, GRAU D'INTERÈS), les persones que creuen que les eleccions són ajustades tinguin una major incidència de vot?

```{r}
```

13.	Considereu la satisfacció amb les candidatures. La gent que no està satisfeta amb les candidatures té una menor incidència de vot? Canviaria la conclusió si el 'grau d'interès' en les eleccions no estigués inclòs en el model?

```{r}
```


14.	Feu la diagnosi del vostre model final.

```{r}
```

15.	Empreu el vostre model final per predir el comportament d'un votant. Classifiqueu com a votant probable aquells individus amb probabilitat superior o igual a 0.5. Feu una taula de contingència amb el vot probable i el vot real i analitzeu-la. Quina és l'explicabilitat del model final?

```{r}
```

16.	Calculeu el pseudo coeficient de determinació del model final i el coeficient de Naglekerke. Feu un goodness of fit test sobre el model final. Calculeu el goodness of fit emprant l'estadístic proposat per Hosmer-Lemershow.
```{r}
```

17.	Determineu la capacitat predictiva mitjançant l'anàlisi de la corba ROC.
```{r}
```

