---
title: "Laboratori sessió 4 - Introducció a resposta binaria"
author: "Lidia Montero, Josep Anton Sanchez & Jordi Cortés"
output:
  html_document: default
---

# Votants americans

## Dades

- Eleccions
    - *close*: eleccions disputades
    - *onesided*: eleccions amb un clar guanyador
- Voten: *No, Yes*    

Carregar les dades i veure els objectes en memoria.

```{r}
# install.packages("evd")
library(evd)                   # cloglog --> qgumbel
load("AmericanVoter.RData")
ls()
```

Tres maneres de mostrar les dades.

```{r}
# TAULA DE CONTNGÈNCIA + les sumes marginals(m) + estimació de quants voten en cada categoria de X 
campbell    # data.frame --> with row marginals and row probabilities

# TAULA DE FREQÜÈNCIES 
df          # data.frame --> for models with aggregated data  
#TAULA DE CONTINGÈNCIA
tt          # table --> Obtained as tt <- xtabs(df$y~df$FResult+df$FVotar)

sum(tt) # Total d'enquestats (nº observacions)
```

## Independencia amb taules de contingencia. 

Tenim: Y (resposta binària) i una sola var explicativa X (factor).

Y: FVotar (si vota o no vota)

Volem saber quins factors fan que la gent NO vagi a votar.

X: Fresult (oneside, un clar guanyador, close,eleccions empatades). És també una variable binària. 

#### Calcular el nombre esperat de votants/No votants sota la hipotesi de independencia $(H_0)$:

Test de independència = test d'hmogeneitat
Ho: P(V_i U(al revés) R_j) = P(V_i)
H1: no igual

Estimació de P(V_i)= marginal(n_·1)/N

S'ha de considerar que la probabilitat de votar és la mateixa si les eleccions estan disputades com si no:

$H_0: \pi_{V|C}=\pi_{V|O}$

Calcularem les freqüències esperades sota independencia:

```{r}
pVotar <- sum(campbell$voten)/sum(campbell$m)
campbell$p0Voten   <- campbell$m * pVotar # Valors teòrics dels que haurien d'haver votat sota Ho (sota independència)
campbell$p0noVoten <- campbell$m * (1-pVotar) # Valors teòrics dels que no haurien d'haver votat sota la Ho d'independència

# Taula d'efectius esperats sobre independència
campbell
```


#### Bondad d'ajust 

Per respondre a la pregunta a si el model que estem plantejant és adequat per explicar el comportament del que estem observant a les dades. 


Emprarem 2 estadístics per valorar la bondad d'ajust de considerar independència:

- L'estadístic de Pearson ($\chi^2_P$) generalitzat
- La deviança ($D$)

Primer, calcularem l'estadístic de Pearson:

$\chi^2_P=\sum_{i,j}{\frac{(O_{ij}-E_{ij})^2}{E_{ij}}}$

```{r}
X2P <- with(campbell,sum((p0Voten  -voten)^2  /p0Voten +
                         (p0noVoten-novoten)^2/p0noVoten))
pvalor <- 1-pchisq(X2P,1)
X2P;pvalor
```

La discrepància entre la taula observada i la taula esperada, mesurada amb l'estadístic de Pearson és 8.82. Es prou gran? Cal mirar el p-valor. Si > 0.05, rebutjem Ho de que la independència entre les meves dues variables és 0.

Regió crítica: qchisq(0.95,1)=3.84. Si la suma X2p sobrepassa aquest valor, diem que tenim evidències per rebutjar Ho. També es vàlid.

Així doncs, podem afirmar que existeix algun grau de dependència. Independentment de la percepció de com seran els resultats d'anar a votar, la probabilitat d'anar a votar és la mateixa. I per tant, el model d'independència que hem plantejat no és bó. 


Ara, calcularem l'estadístic de la deviança:

$D=2 \cdot \sum{\big[y_i \cdot log(\frac{y_i}{m_i\hat{\pi}_i})  +  (m_i - y_i) \cdot log(\frac{m_i - y_i}{m_i - m_i\hat{\pi}_i})  \big]}$

```{r}
Dev0 <- 2*sum(with(campbell,log(voten/p0Voten)     * voten + 
                            log(novoten/p0noVoten) * novoten))
pvalue <- 1 - pchisq(Dev0,1)
Dev0;pvalue
```

Resultats equivalents als de la R^2.

Amb la funció *chisq.test* es pot fer el test d'independencia per una taula IxJ

Amb correcció de Yates:

Té en compte que si alguna de les caselles de la taula de contingència té un valor esperat menor a 5, sha de fer una correcció de continuitat.

```{r}
chisq.test(tt)
```

Sense correcció de Yates:

Veiem que coincideix amb l'obtingut en primer lloc.

```{r}
chi.test <- chisq.test(tt,correct = FALSE)
chi.test
```

Amb la funció *chisq.test* podem obtenir:

- Els efectius esperats:

```{r}
chi.test$expected
```

- Els residus i l'estadístic de Pearson:

```{r}
chi.test$residuals
sum(chi.test$residuals^2)
chi.test$statistic
```

- El p-valor:

```{r}
chi.test$p.value
```



## Mesures 

- Per cada categoria de tipus d'elecció:
    - Probabilitat de votar. Són els que voten en una categoria entre el total de la categoria. 
    - Odds de votar. Són els que voten en una categoria entre els que no voten. 
- Relació entre categories:
    - Odds-ratio. És el rati d'odds.


```{r}
campbell$p1pos <- with(campbell,voten/m)
campbell$p1neg <- with(campbell,novoten/m)
campbell$odd1  <- with(campbell,voten/novoten)
oddsratio <- with(campbell,odd1[1]/odd1[2])            # Categoria de referencia is onesided (2nd row)
campbell;oddsratio
```


## Funcions Link

#### Logit link: Model sota $H_0$

Aquesta funció link representa el logaritme del odd i és la funció link que proporciona resultats més interpretables ja que es poden obtenir els odds i els odds ratis a traves de desfer les transformacions.

Sota $H_0$:

$H_0: \pi_{V|C}=\pi_{V|O}$

```{r}
(beta0 <- with(campbell,log(pVotar/(1-pVotar))))          
ml0 <- glm(cbind(voten,novoten) ~ 1,family=binomial(link="logit"), data=campbell)
summary(ml0)
```


#### Logit link: Model sota $H_1$

Sota $H_1$:

$H_1: \pi_{V|C} \ne \pi_{V|O}$

```{r}
(beta1 <- with(campbell,log(p1pos/(1-p1pos)))) # Reference level is onesided - 2nd row !!!
beta1[2]                                       # Constant estimate related to reference level eleccions=='onesided'
beta1[1]-beta1[2]                               # Additive value over the reference for eleccions=='closed'
ml1 <- glm(cbind(voten,novoten)~eleccions,family=binomial(link="logit"),data=campbell)
summary(ml1)
```


#### Probit link: Model sota $H_0$

Aquesta funció link representa el quantil de la normal estandard de la probabilitat de votar.

Sota $H_0$:

$H_0: \pi_{V|C}=\pi_{V|O}$

```{r}
beta0 <- qnorm(pVotar);beta0
mn0  <- glm(cbind(voten,novoten)~1, family=binomial(link="probit"), data=campbell)
summary(mn0)
```


#### Probit link: Model sota $H_1$

Sota $H_1$:

$H_1: \pi_{V|C} \ne \pi_{V|O}$

```{r}
beta1 <- qnorm(campbell$p1pos);beta1 # Reference level is onesided - 2nd row !!!
beta1[2]                            # Constant estimate related to reference level eleccions=='onesided'
beta1[1]-beta1[2]                    # Additive value over the reference for eleccions=='closed'
mn1 <- glm(cbind(voten,novoten)~eleccions,family=binomial(link="probit"),data=campbell)
summary(mn1)
```


#### Complementary-log-log link: Model sota $H_0$

Aquesta funció link es construeix a través del quantil de la distribució gumbel.

```{r}
beta0 <- 0 - qgumbel(1-pVotar);beta0
mg0  <- glm(cbind(voten,novoten)~1,family=binomial(link="cloglog"),data=campbell)
summary(mg0)
```


#### Complementary-log-log: Model sota $H_1$

Sota $H_1$:

$H_1: \pi_{V|C} \ne \pi_{V|O}$

```{r}
beta1 <- 0-qgumbel(1-campbell$p1pos);beta1 # Reference level is onesided - 2nd row !!!
beta1[2]  # Constant estimate related to reference level eleccions=='onesided'
beta1[1]-beta1[2] # Additive value over the reference for eleccions=='closed'
mg1 <- glm(cbind(voten,novoten)~eleccions,family=binomial(link="cloglog"),data=campbell)
summary(mg1)
```


#### Diferents formes de les funcions link

```{r}
ps <- seq(0.01,0.99,0.01)
flogit <- log(ps/(1-ps))
fprobit <- qnorm(ps)
fcloglog <- log(-log(1-ps))

par(las=1)
plot(ps,flogit,type='l',lwd=2,col=1,xlab='Probability',ylab='link function')
lines(ps,fprobit,type='l',lwd=2,col=2)
lines(ps,fcloglog,type='l',lwd=2,col=3)
legend('topleft',c('Logit','Probit','Cloglog'),lwd=2,col=1:3)
```

Aquí es veu la diferent distribució de les 3 funcions. Depenent de com augmenti/decreixi la probabilitat de la resposta en funció del valor de la variable predictora, escollirem una o altra.
